# Associations {#sec-associations}

```{r setup}
#| cache: false
# Packages
library(scales)
library(ggtext)
library(lubridate)
library(kableExtra)
library(memoise)
library(cachem)
library(ggstance)
library(ggbeeswarm)
library(mgcv)
library(brms)
library(ggh4x)
library(tidybayes)
library(ggdist)
library(posterior)
library(parameters)
library(bayestestR)
library(emmeans)
library(broom)
library(tidyverse)

cd <- cache_disk("memoise_cache", max_size = Inf)
```


```{r load}
#| cache: false
# Load data sets
dat <- read_rds("data/data-all.rds")

# Countries and regions
countries <- dat %>% 
  distinct(region, country)

# Load models
oo <- c(
  "Life_satisfaction", "Negative_experiences", "Positive_experiences",
  "Anxiety", "Depression", "Selfharm"
)
fits <- tibble(outcome = oo) %>% 
  mutate(outcome = factor(outcome, levels = oo))
```

We then turned to the second research question: To what extent are changes in well-being predicted by internet adoption? To answer, we investigate the results of Model 2.

## Main result: Association

```{r}
get_fixef <- function(outcome, var = "i1_cw"){
  path <- str_glue("models/brm-{outcome}-2-internet.rds")
  fixef(
    readRDS(path), 
    summary = FALSE
  )[,var, drop = FALSE] %>% 
    summarise_draws(
      mean, sd,
      ~quantile2(., probs = c(.025, .1, .5, .9, .975)),
      pd = ~pd(as.numeric(.)), 
      rhat
    ) %>% 
    mutate(pd = percent(pd, .1))
}
get_fixef <- memoise(get_fixef, cache = cd)

fits_fixef <- fits %>% 
  mutate(out = map(outcome, ~get_fixef(.x))) %>% 
  select(outcome, out) %>% 
  unnest(out)

fits_fixef %>%
  mutate(across(mean:q97.5, ~./10)) %>% 
  kbl(digits = 2, caption = "Model 2 population level associations (% increase per 10% increase in internet adoption)") %>% 
  kable_custom()
```

This table shows the population-level (average across region, country, age) associations. We then summarise the region- and country-level trends in a table.

```{r}
# Region coefficients
get_region_coef <- function(outcome) {
  path <- str_glue("models/brm-{outcome}-2-internet.rds")
  coef(readRDS(path), summary = FALSE)$region[,,"i1_cw"] %>% 
    summarise_draws(
      mean, sd,
      ~quantile2(., probs = c(.025, .1, .5, .9, .975)),
      pd = ~pd(as.numeric(.)), 
      rhat
    ) %>% 
    mutate(pd = percent(pd, .1))
}
get_region_coef <- memoise(get_region_coef, cache = cd)

i1_cw_region <- fits %>% 
  mutate(out = map(outcome, ~get_region_coef(.x))) %>% 
  select(outcome, out) %>% 
  unnest(out)
i1_cw_region <- rename(i1_cw_region, region = variable)

# Country random deviations + region coefficients
get_country_ranef <- function(outcome) {
  path <- str_glue("models/brm-{outcome}-2-internet.rds")
  ranef(readRDS(path), summary = FALSE)$country[,,"i1_cw"] %>% 
    summarise_draws(
      mean, sd,
      ~quantile2(., probs = c(.025, .1, .5, .9, .975)),
      pd = ~pd(as.numeric(.)), 
      rhat
    ) %>% 
    mutate(pd = percent(pd, .1))
}
get_country_ranef <- memoise(get_country_ranef, cache = cd)

i1_cw_country <- fits %>% 
  mutate(out = map(outcome, ~get_country_ranef(.x))) %>% 
  select(outcome, out) %>% 
  unnest(out)

# Add region coefs
i1_cw_country <- i1_cw_country %>% 
  rename(country = variable) %>% 
  left_join(countries) %>% 
  left_join(
    select(i1_cw_region, outcome, region, mean_region = mean)
  ) %>% 
  mutate(across(mean:q97.5, ~. + mean_region)) %>% 
  # pd doesn't work without the region coefs
  select(-mean_region, -pd)

i1_cw_region %>% 
  mutate(across(mean:q97.5, ~./10)) %>% 
  arrange(outcome, mean) %>% 
  kbl(
    digits = 2, 
    caption = "Region-specific associations, arranged by outcome and magnitude"
  ) %>% 
  kable_custom() %>% 
  scroll_box("500px")

i1_cw_country %>% 
  mutate(across(mean:q97.5, ~./10)) %>% 
  select(outcome, country, everything()) %>% 
  arrange(outcome, mean) %>% 
  kbl(
    digits = 2, 
    caption = "Country-specific associations, ordered by outcome and magnitude"
  ) %>% 
  kable_custom() %>% 
  scroll_box("500px")
```

### Coefficient plot

Putting these together into a plot

```{r}
tmp <- i1_cw_country %>%
  mutate(Level = "Country") %>% 
  mutate(s = sign(q2.5) == sign(q97.5))

bind_rows(
  "Average" = fits_fixef %>% mutate(region = "**Average**"),
  "Region" = i1_cw_region,
  .id = "Level"
) %>% 
  mutate(region = fct_relevel(region, "**Average**")) %>% 
  mutate(s = sign(q2.5) == sign(q97.5)) %>% 
  ggplot(aes(mean, region, col = Level, shape = s)) +
  scale_color_manual(
    values = c("dodgerblue4", "dodgerblue3", "dodgerblue3")
  ) +
  scale_shape_manual(values = c(21, 19)) +
  scale_y_discrete(
    labels = ~str_replace(., "_", " "),
    expand = expansion(c(0.05, 0.05))
  ) +
  scale_x_continuous(
    "Conditional lagged effect of 10% increase in internet adoption",
    breaks = pretty_breaks(5),
    # Effect of 10% increase
    labels = function(x) percent(x / 1000, .001) %>% 
      str_remove("\\.000") %>% 
      str_remove("(?<=[0-9])0(?=%)"),
    expand = expansion(c(0.025, .025))
  ) +
  geom_vline(xintercept = 0, lty = 2, size = .2) +
  geom_point(
    data = tmp,
    size = 1, col = "dodgerblue1", stroke = .3, alpha = .8,
    position = position_quasirandom(width = .2, groupOnX = F)
  ) +
  geom_linerange(
    aes(xmin = q10, xmax = q90), size = 1, col = "dodgerblue4"
  ) +
  geom_pointrangeh(
    aes(xmin = q2.5, xmax = q97.5), col = "dodgerblue4",
    fatten = 4, fill = "white", stroke = .8
  ) +
  # geom_richtext(
  #   aes(x = Inf, label = str_glue("{percent(mean/100, .01)}<br>[{percent(q2.5/100, .01)} {percent(q97.5/100, .01)}]")), 
  #   hjust = 1, vjust = 0.15, size = 2.7, lineheight = .9,
  #   col = "black", fill = NA, label.color = NA
  # ) +
  facet_wrap(
    "outcome", scales = "free_x", ncol = 3,
    labeller = as_labeller(~str_replace(., "_", " "))) +
  theme(
    axis.title.y = element_blank(),
    axis.text.y = element_markdown(),
    legend.position = "none"
  )
agg_png(
  "Fig-assc-coef.png", 
  width = W, height = W*0.6, units = "in", res = 400
)
last_plot()
dev.off()
```

## Between-country associations

We then focused on the between-country association between internet adoption and well-being. Recall that the model does not adjust for between-country differences so these associations are likely to reflect many other factors covarying with internet adoption (e.g. wealth and development factors).

```{r}
#| column: page-right
#| fig.width: 8
#| fig.height: 6
#| fig-cap: "Between-country associations"
#| label: fig-cb1

fitted_cb1 <- function(outcome) {
  fit <- readRDS(str_glue("models/brm-{outcome}-2-internet.rds"))
  newx <- fit$data %>%
    group_by(region, country) %>%
    summarise(i1_cb = unique(i1_cb), val = mean(val, na.rm = TRUE)) %>% 
    mutate(i1_cw = 0, year = 0, sex = NA, age = NA, se = 0) %>% 
    ungroup()
  
  newy <- bind_cols(
    newx,
    as.data.frame(
      fitted(
        fit, 
        newdata = newx, 
        re_formula = NA
      )
    )
  )
  newy
}
fitted_cb1 <- memoise(fitted_cb1, cache = cd)

tmp <- fits %>% 
  mutate(out = map(outcome, fitted_cb1)) %>% 
  select(outcome, out) %>%
  unnest(out)

get_cor_par <- function(outcome) {
  as_draws_df(
    readRDS(str_glue("models/brm-{outcome}-2-internet.rds")),
    variable = "b_i1_cb"
  ) %>%
    summarise_draws(mean, sd, ~ quantile2(., probs = c(.025, .975)))
}
get_cor_par <- memoise(get_cor_par, cache = cd)

cb1_pars <- fits %>%
  mutate(
    out = map(outcome, ~get_cor_par(.x))
  ) %>%
  select(outcome, out) %>%
  unnest(out) %>%
  mutate(across(where(is.numeric), ~ number(., .01)))

tmp %>% 
  ggplot(aes(i1_cb, val)) +
  scale_x_continuous(
    "Between-country centered internet adoption",
    labels = ~percent(.)
  ) +
  scale_y_continuous(
    "Value",
    labels = ~percent(./100),
    breaks = extended_breaks()
  ) +
  geom_point(
    shape = 1, size = 1, alpha = .75, col = "dodgerblue1"
  ) +
  geom_ribbon(
    aes(ymin = Q2.5, ymax = Q97.5),
    alpha = .2, fill = "dodgerblue1"
  ) +
  geom_line(
    aes(y = Estimate), 
    col = "dodgerblue4", size = 1
  ) +
  geom_smooth(
    method = "lm", se = F, 
    size = .5, col = "black", lty = 2
  ) +
  # geom_text(
  #   data = cb1_pars,
  #   aes(
  #     x = -Inf, 
  #     y = Inf, 
  #     label = str_glue("{mean} [{q2.5}, {q97.5}]")
  #   ),
  #   vjust = 1.3, hjust = -0.025, size = 2.8, family = Font
  # ) +
  facet_wrap(
    "outcome",
    scales = "free_y", nrow = 1,
    labeller = as_labeller(~str_replace(., "_", " "))
  ) +
  theme(
    aspect.ratio = 1,
    axis.title.y = element_blank()
  )

agg_png(
  "Fig-assc-cor.png", 
  width = W, height = W*0.2, units = "in", res = 400
)
last_plot()
dev.off()
```

Here are these correlations calculated from data

```{r}
# From data
tmp <- dat %>% 
  mutate(outcome = factor(outcome, levels = oo)) %>% 
  group_by(outcome, country) %>% 
  summarise(
    val = mean(val, na.rm = TRUE),
    internet = mean(i1_cb, na.rm = TRUE)
  )
tmp_tab <- tmp %>% 
  summarise(
    tidy(lm(scale(val) ~ scale(internet), data = cur_data()), conf.int = TRUE)
  ) %>% 
  ungroup() %>%
  filter(term != "(Intercept)") %>% 
  mutate(across(where(is.numeric), ~number(., .01))) %>% 
  transmute(
    Outcome = str_replace(outcome, "_", " "),
    r_CI = str_glue("{estimate}, [{conf.low}, {conf.high}]")
  )
tmp_tab
tmp_tab %>% 
  flextable::flextable(cwidth = 2) %>% 
  flextable::save_as_docx(path = "tmp.docx")
```

