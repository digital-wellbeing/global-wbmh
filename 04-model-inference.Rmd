# Model inference

```{r packages}
#| results: 'hide'
# Packages
library(ggtext)
library(brms)
library(broom.mixed)
library(scales)
library(ggh4x)
library(tidybayes)
library(ggdist)
library(posterior)
library(parameters)
library(lme4)
library(emmeans)
library(patchwork)
library(bayestestR)
library(lubridate)
library(broom)
library(kableExtra)
library(ggstance)
library(tidyverse)
```

```{r}
itu <- read_rds("data/itu.rds")
gbd <- read_rds("data/gbd.rds") # 10 to 24 year olds
```

## Read models from file

```{r}
fits <- distinct(gbd, cause) %>% 
  mutate(
    fit1 = map(
      cause, 
      ~read_rds(str_glue("output/brm-1-{.x}.rds"))
    ),
    fit2 = map(
      cause, 
      ~read_rds(str_glue("output/brm-2-{.x}.rds"))
    )
  )
```

## Model comparison

Compare 1 and 2 to examine how much model fit / variance explained changes when the internet predictors are added.

```{r}
# Save to file if not done yet
model_criteria_file <- "output/models-bayes-r2.rds"
if (!file.exists(model_criteria_file)) {
  model_criteria <- fits %>% 
    mutate(Year = map(fit1, ~bayes_R2(.x, resp = "val"))) %>% 
    mutate(`Year & internet` = map(fit2, ~bayes_R2(.x, resp = "val"))) %>% 
    select(-fit1, -fit2)
  write_rds(model_criteria, model_criteria_file)
} else {model_criteria <- read_rds(model_criteria_file)}

# Display table
model_criteria %>% 
  pivot_longer(-cause, names_to = "Model") %>% 
  mutate(value = map(value, ~as.data.frame(.) %>% rownames_to_column())) %>% 
  unnest(value) %>% 
  select(-Est.Error, -rowname) %>% 
  mutate(across(where(is.numeric), ~percent(.x, .1))) %>% 
  mutate(result = str_glue("{Estimate} [{Q2.5}, {Q97.5}]")) %>% 
  select(cause, Model, result) %>% 
  pivot_wider(names_from = Model, values_from = result) %>% 
  rename(Outcome = cause) %>% 
  kbl() %>% 
  kable_paper(html_font = Font, full_width = FALSE)
```


## Time courses

### Parameter estimates

Model's population-level parameters. Recall scales of data values: Year is in decades; internet is a proportion (0-1); and outcomes are percentages (0-100).

```{r}
fits %>% 
  mutate(
    out = map(
      fit1, 
      ~as_draws_df(.x, variable = "^b_", regex = TRUE) %>% 
        summarise_draws(
          mean, quantile, rhat, 
          .args = list(probs = c(.025, .975))
        )
    )
  ) %>% 
  select(-fit1, -fit2) %>% 
  unnest(out) %>% 
  # Round selfharm numbers less because so small
  mutate(
    across(
      where(is.numeric), 
      ~if_else(cause == "Selfharm", round(., 3), round(., 2)))
  ) %>% 
  mutate(
    result = str_glue(
      "{mean} ({`2.5%`}, {`97.5%`})"
    )
  ) %>% 
  select(-c(mean, `2.5%`, `97.5%`, rhat)) %>% 
  pivot_wider(names_from = cause, values_from = result) %>% 
  kbl() %>% 
  kable_paper(html_font = Font) %>% 
  row_spec(4, bold = TRUE)
```

### Figure: Timecourses and parameters

```{r}
tmp_coefs <- fits %>% 
  mutate(
    out = map(
      fit1, 
      ~hypothesis(
        .x,
        c("val_year = 0", "internet_year = 0"),
        scope = "coef",
        group = "region"
      )$hypothesis
    )
  ) %>% 
  select(-fit1, -fit2) %>% 
  unnest(out) %>% 
  mutate(
    across(
      where(is.numeric), 
      ~round(., 3)
    )
  ) %>% 
  # Round selfharm numbers less because so small
  mutate(
    across(
      where(is.numeric), 
      ~if_else(cause == "Selfharm", round(., 3), round(., 2)))
  ) %>% 
  mutate(result = str_glue('**{Estimate}**<br>[{CI.Lower}, {CI.Upper}]'))

# Remove duplicate internet estimates and reshape to long form re variable
tmp_coefs <- tmp_coefs %>% 
  filter(Hypothesis == "(val_year) = 0" | cause == "Anxiety") %>% 
  mutate(
    cause = if_else(str_detect(Hypothesis, "val_"), cause, "Internet")
  ) %>% 
  mutate(region = Group)

pseudo_gwp <-
  bind_rows(
    distinct(gbd, region, year, val = NA) %>% 
      crossing(
        cause = fct_inorder(
          c(
            "Negative\nexperiences", 
            "Positive\nexperiences", 
            "Life\nsatisfaction"
          )
        )
      )
  )

# Stack data sets
# Assume all outcomes are proportions (0-1)
dat_all <- bind_rows(
  pseudo_gwp,
  gbd,
  itu %>% mutate(cause = "Internet", val = internet)
) %>% 
  mutate(cause = fct_inorder(cause)) %>% 
  group_by(region, country, year, cause) %>% 
  summarise(mean = mean(val, na.rm = TRUE)) %>% 
  ungroup()

# Draw small multiples figure, outcomes x regions
dat_all %>% 
  mutate(year = make_date(year)) %>% 
  ggplot(aes(year, mean)) +
  scale_y_continuous(
    "Value",
    labels = function(x) percent(x, .01) %>% str_remove("\\.00"),
    breaks = pretty_breaks()
  ) +
  scale_x_date(
    "Year",
    breaks = make_date(c(2000, 2005, 2010, 2015)), 
    date_labels = "'%y", 
    expand = expansion(.02)
  ) +
  geom_line(
    aes(group = interaction(country, cause)), 
    alpha = .25, size = .4, color = "dodgerblue1"
  ) +
  stat_summary(
    fun = mean, geom = "line", 
    size = .6, color = "dodgerblue4"
  ) +
  facet_grid(cause~region, scales = "free_y") +
  geom_richtext(
    data = tmp_coefs %>% mutate(cause = fct_inorder(str_to_title(cause))),
    aes(x = make_date(2000), y = Inf, label = result),
    size = 2.4, vjust = .9, hjust = 0.05, color = "black",
    family = Font,
    fill = NA, label.color = NA
  ) +
  theme(
    legend.position = "none",
    axis.title.y = element_blank(),
    panel.spacing = unit(3, "pt")
  )
```

### Figure: Correlations

Calculate country coefficients and show scatterplots

```{r time-correlation-anxiety}
# Function to wrangle draws at multiple levels and create scatterplots + ellipses
draw_scatterplot <- function(
  fit, beta, r_region, r_country, sd_country, cor_country
) {
  # Get average and region-specific slopes
  r_region_draws <- fit %>% 
    spread_draws(
      b_val_year, 
      b_internet_year,
      r_region__val[region, term],
      r_region__internet[region, term]
    ) %>% 
    filter(term == "year") %>% 
    ungroup() %>% 
    # Fix names by replacing dot with line break
    mutate(region = str_replace(region, "\\.", "\n"))
  
  # Then country
  r_country_draws <- fit %>% 
    spread_draws(
      r_country__val[country, term],
      r_country__internet[country, term]
    ) %>% 
    filter(term == "year") %>% 
    ungroup() %>% 
    # Fix names by taking labels from original names
    mutate(
      country = factor(
        country, 
        labels = sort(unique(fit$data$country))
      )
    ) %>% 
    left_join(distinct(dat, region, country))
  
  # Calculate country coefficients
  country_coefs <- left_join(r_country_draws, r_region_draws) %>% 
    mutate(
      internet = b_internet_year + r_region__internet + r_country__internet,
      outcome = b_val_year + r_region__val + r_country__val
    ) %>% 
    group_by(country, region) %>% 
    median_qi(internet, outcome)
  
  # Create country ellipse data
  country_ellipse <- spread_draws(
    fit,
    b_val_year, 
    b_internet_year,
    sd_country__val_year,
    sd_country__internet_year,
    cor_country__internet_year__val_year, 
    ndraws = 100
  ) %>% 
    rename(
      cor = cor_country__internet_year__val_year, 
      sd_outcome = sd_country__val_year,
      sd_i = sd_country__internet_year,
      b_outcome = b_val_year,
      b_i = b_internet_year
    ) %>% 
    mutate(
      e = pmap(
        list(cor, sd_outcome, sd_i, b_outcome, b_i), 
        function(cor, sd_a, sd_i, b_a, b_i) 
          ellipse(
            cor, 
            scale = c(sd_i, sd_outcome), 
            centre = c(b_i, b_outcome), 
            level = .90
          ) %>% 
          as_tibble()
      )
    ) %>% 
    unnest(e)
  
  # Correlation
  country_cor_result <- spread_draws(fit, cor_country__internet_year__val_year) %>% 
    median_qi(.width = .95) %>% 
    mutate(across(where(is.numeric), ~round(., 2))) %>%
    {str_glue("{.[,1]} [{.[,2]}, {.[,3]}]")}
  
  # Plot
  country_coefs %>% 
    ggplot(aes(outcome, internet)) +
    geom_path(
      data = country_ellipse,
      # Internet values on Y
      aes(x = y, y = x, group = .draw), 
      alpha = .2, size = .1, col = "dodgerblue1"
    ) +
    geom_vline(xintercept = 0, lty = 2, size = .2) +
    geom_hline(yintercept = 0, lty = 2, size = .2) +
    geom_point(col = "dodgerblue1", size = 1, alpha = .5) +
    scale_y_continuous(
      "Internet trend",
      breaks = pretty_breaks()
    ) +
    scale_x_continuous(
      breaks = pretty_breaks()
    ) +
    annotate(
      "text",
      x = Inf, y = Inf, label = country_cor_result,
      size = 3.6, vjust = 1.5, hjust = 1.05, color = "black",
      family = Font
    )
}
```

```{r}
p1 <- draw_scatterplot(fits$fit1[[1]]) + labs(x = "Anxiety trend")
p2 <- draw_scatterplot(fits$fit1[[2]]) + labs(x = "Depression trend")
p3 <- draw_scatterplot(fits$fit1[[3]]) + labs(x = "Self-harm trend")
```

```{r}
# Same y axis
p2 <- p2 + theme(axis.title.y = element_blank())
p3 <- p3 + theme(axis.title.y = element_blank())

(wrap_elements(grid::textGrob('Negative experiences\nTBD')) |
    wrap_elements(grid::textGrob('Positive experiences\nTBD')) |
    wrap_elements(grid::textGrob('Life satisfaction\nTBD'))) /
  ((p1 | p2 | p3) & coord_cartesian(ylim = c(-1, 5))) & 
  theme(aspect.ratio = 1)
```

### Figure: Shrinkage

Shrinkage plot

```{r}
x <- mgcv::gam(
  internet ~ 0 + country + year:country, 
  family = mgcv::betar, data = itu %>% mutate(year = (year-2010)/10)
)
lm_coefs <- fits %>% 
  mutate(data = map(fit1, ~as_tibble(.x$data))) %>% 
  mutate(
    out = map(
      data, 
      ~tidy(
        lm(val ~ 0 + country + year:country, data = .x)
      )
    )
  ) %>% 
  select(-fit1, -fit2, -data) %>% 
  unnest(out)

lm_coefs <- left_join(
  tidy(x, TRUE) %>% 
    mutate(cause = "Internet") %>% 
    filter(str_detect(term, ":year")) %>% 
    mutate(term = str_remove(term, "country")) %>% 
    mutate(term = str_remove(term, ":year")) %>% 
    select(country = term, internet_lm = estimate),
  lm_coefs %>% 
    filter(str_detect(term, ":year")) %>% 
    mutate(term = str_remove(term, "country")) %>% 
    mutate(term = str_remove(term, ":year")) %>% 
    select(cause, country = term, outcome_lm = estimate)
)
bind_rows(
  "Anxiety" = p1$data,
  "Depression" = p2$data,
  "Selfharm" = p3$data,
  .id = "cause"
) %>% 
  ungroup() %>% 
  left_join(lm_coefs) %>% 
  ggplot() +
  geom_vline(xintercept = 0, lty = 2, size = .2) +
  geom_hline(yintercept = 0, lty = 2, size = .2) +
  geom_segment(
    aes(
      x = outcome_lm, xend = outcome,
      y = internet_lm, yend = internet
    ),
    size = .25,
    arrow = arrow(length = unit(4, "pt"), type = "closed")
  ) +
  geom_point(
    aes(outcome, internet), 
    col = "dodgerblue3", size = 1, alpha = .75
  ) +
  geom_point(
    aes(outcome_lm, internet_lm),
    col = "dodgerblue1", size = 1, alpha = .25
  ) +
  scale_y_continuous(
    "Internet trend",
    breaks = pretty_breaks()
  ) +
  scale_x_continuous(
    "Outcome trend",
    breaks = pretty_breaks()
  ) +
  facet_wrap("cause", scales = "free_x") +
  theme(aspect.ratio = 1)
```

### Sex and age

```{r}
x <- fits$fit1[[1]]
get_variables(x)
contrasts(fits$fit1[[1]]$data$sex)
contrasts(fits$fit1[[1]]$data$age)

x <- emtrends(fits$fit1[[1]], var = "year", by = c("sex", "age"), resp = "val")
parameters(x, centrality = "mean", ci_method = "quantile", test = "pd")
tmp <- fits_2c %>% 
  mutate(
    out = map(
      fit, 
      ~emtrends(.x, var = "i1_cw", by = c("sex"), at = list(age1=0, age2=0))
    )
  )
tmp$out[[1]] %>% summary

get_draws <- function(x) {
  draws_region <- spread_draws(
    x, 
    b_val_year, `b_val_year:sex1`, `b_val_year:age1`, `b_val_year:age2`,
    r_region[region, term] | term
  ) %>% 
    mutate(
      `10 to 14` = val_year + b_val_year +
        `val_year:age1`*1 + `b_val_year:age1`*1 +
        `val_year:age2`*0 + `b_val_year:age2`*0,
      `15 to 19` = val_year + b_val_year +
        `val_year:age1`*0 + `b_val_year:age1`*0 +
        `val_year:age2`*1 + `b_val_year:age2`*1,
      `20 to 24` = val_year + b_val_year +
        `val_year:age1`*-1 + `b_val_year:age1`*-1 +
        `val_year:age2`*-1 + `b_val_year:age2`*-1,
      Female = b_val_year + val_year + 
        `val_year:sex1`*1 + `b_sex1:val_year`*1,
      Male = val_year + b_val_year + 
        `val_year:sex1`*-1 + `b_val_year:sex1`*-1
    ) %>% 
    select(region, `10 to 14`:Male)
  
  draws_avg <- spread_draws(
    x, 
    b_i1_cw, `b_sex1:i1_cw`, `b_age1:i1_cw`, `b_age2:i1_cw`,
  ) %>% 
    mutate(
      `10 to 14` = b_i1_cw + `b_age1:i1_cw`*1 + `b_age2:i1_cw`*0,
      `15 to 19` = b_i1_cw + `b_age1:i1_cw`*0 + `b_age2:i1_cw`*1,
      `20 to 24` = b_i1_cw + `b_age1:i1_cw`*-1 + `b_age2:i1_cw`*-1,
      Female = b_i1_cw + `b_sex1:i1_cw`*1,
      Male = b_i1_cw + `b_sex1:i1_cw`*-1,
      Age = `20 to 24` - `10 to 14`,
      Sex = Female - Male
    ) %>% 
    select(`10 to 14`:Male) %>% 
    mutate(region = "Average")
  
  draws <- bind_rows(
    "regions" = draws_region,
    "average" = draws_avg, 
    .id = "Level"
  ) %>% 
    mutate(region = str_replace(region, "\\.", "\n")) %>% 
    ungroup()
  draws
}
```


## Association with internet adoption

### Parameter estimates

Model's population-level parameters. Recall scales of data values: Year is in decades; internet is a proportion (0-1); and outcomes are percentages (0-100).

```{r}
fits %>% 
  mutate(
    out = map(
      fit2, 
      ~as_draws_df(.x, variable = "^b_", regex = TRUE) %>% 
        summarise_draws(
          mean, quantile, rhat, 
          .args = list(probs = c(.025, .975))
        )
    )
  ) %>% 
  select(-fit1, -fit2) %>% 
  unnest(out) %>% 
  # Round selfharm numbers less because so small
  mutate(
    across(
      where(is.numeric), 
      ~if_else(cause == "Selfharm", round(., 3), round(., 2)))
  ) %>% 
  mutate(
    result = str_glue(
      "{mean} ({`2.5%`}, {`97.5%`})"
    )
  ) %>% 
  select(-c(mean, `2.5%`, `97.5%`, rhat)) %>% 
  pivot_wider(names_from = cause, values_from = result) %>% 
  kbl() %>% 
  kable_paper(html_font = Font) %>% 
  kable_paper(html_font = Font, full_width = FALSE)
```

### Coefficients

```{r}
tmp <- fits %>% 
  mutate(
    out = map(
      fit2, 
      ~emtrends(.x, var = "i1_cw", by = c("sex", "age"))
    )
  ) %>% 
  select(-fit1, -fit2)
tmp %>% 
  mutate(out = map(out, ~as.data.frame(out))) %>% 
  unnest(out) %>% 
  select(cause, sex, age, i1_cw.trend, lower.HPD, upper.HPD) %>% 
  kbl(digits = 3) %>% 
  kable_paper(html_font = Font, full_width = FALSE)
```

### Forest plots

figure of coefficients forest plot

```{r}
#' Create three-level data for a forest plot
#'
#' @param model a brmsfit Model 2
#'
#' @return data.frame with posterior samples of the i1_cw effect at level of regions and average, and posterior means at level of countries. Can then be filtered to display either.
create_forest_data <- function(model) {
  # Average
  y_avg <- spread_draws(model, b_i1_cw) %>% 
    mutate(region = "Average") %>% 
    select(.draw, r_region = b_i1_cw, region)
  # Region
  y_region <- spread_draws(model, b_i1_cw, r_region[region, term]) %>% 
    filter(term == "i1_cw") %>% 
    mutate(r_region = b_i1_cw + r_region) %>% 
    ungroup() %>% 
    select(.draw, region, r_region) %>% 
    mutate(region = str_replace_all(region, "\\.", "\n"))
  # Country
  y_country <- spread_draws(model, r_country[country, term]) %>% 
    filter(term == "i1_cw") %>% 
    mutate(country = str_replace_all(country, "\\.", " "))
  y_country <- y_country %>% 
    mean_qi(r_country) %>% 
    # Get region names
    left_join(distinct(model$data, region, country)) %>% 
    # Join to region means
    left_join(
      y_region %>% 
        group_by(region) %>% 
        mean_qi(r_region) %>% 
        select(region, r_region)
    ) %>% 
    mutate(r_country = r_country + r_region) %>% 
    select(region, country, r_country)
  
  # Common data frame
  y <- bind_rows(
    y_region,
    y_avg,
    y_country
  )
  
  y
}

forest_data <- fits %>% 
  mutate(data = map(fit2, create_forest_data)) %>% 
  select(-fit1, -fit2)

forest_data <- forest_data %>% 
  unnest(data)

forest_data <- forest_data %>% 
  mutate(region = fct_relevel(region, "Average"))

forest_text <- forest_data %>% 
  drop_na(r_region) %>% 
  select(-c(country, r_country)) %>% 
  pivot_wider(names_from = region, values_from = r_region) %>% 
  group_by(cause) %>% 
  summarise(
    parameters(
      cur_data_all()[,-c(1:2)], 
      test = "pd", 
      centrality = "mean",
      ci_method = "quantile"
    )
  ) %>% 
  mutate(region = fct_relevel(Parameter, "Average")) %>% 
  mutate(is_average = FALSE) %>% 
  mutate(
    across(
      where(is.numeric), 
      ~if_else(
        cause=="Selfharm", 
        format(round(., 3), nsmall = 3), 
        format(round(., 2), nsmall = 2)
      )
    )
  )

p_tmp <- drop_na(forest_data, r_region) %>% 
  mutate(is_average = region == "Average") %>% 
  ggplot(aes(r_region, region, fill = is_average)) +
  scale_fill_manual(values = c("dodgerblue1", "dodgerblue4")) +
  scale_alpha_manual(values = c(.4, .8)) +
  geom_vline(xintercept = 0, lty = 2, size = .2) +
  scale_shape_manual(values = c(21, 19)) +
  scale_y_discrete(
    expand = expansion(c(0.01, .1)),
    labels = function(x) if_else(x == "Average", "**Average**", x)
  ) +
  scale_x_continuous(
    "Conditional effect of 100% increase in internet adoption on outcome", 
    breaks = pretty_breaks(), 
    labels = function(x) percent(x/100, .01) %>% str_remove("\\.00"),
    expand = expansion(c(.1, .1))
  ) +
  geom_point(
    data = forest_data %>%
      mutate(is_average = TRUE) %>% 
      # This drops a few countries that didn't match region due to string processing above
      drop_na(region),
    aes(x = r_country), size = 1, col = "dodgerblue1",
    position = position_nudge(0, -0.075), alpha = .4
  ) +
  stat_halfeye(
    point_interval = NULL, normalize = "panels", 
    height = .75, adjust = 1,
    aes(alpha = is_average)
  ) +
  stat_pointinterval(
    alpha = 1, .width = c(.95),
    interval_size = 1,
    point_size = 1.75,
    fill = "white",
    aes(shape = after_stat(xmin > 0 | xmax < 0)),
    position = position_nudge(0, 0)
  ) +
  geom_text(
    data = forest_text, family = Font,
    alpha = 1, size = 2.4, hjust = 1, vjust = -0.2,
    aes(
      x = Inf,
      label = str_glue("{Mean} [{CI_low}, {CI_high}]")
    )
  ) +
  facet_wrap("cause", nrow = 1, scales = "free_x") +
  theme(
    axis.title.y = element_blank(),
    axis.text.y = element_markdown(),
    legend.position = "none"
  )

(wrap_elements(grid::textGrob('Negative experiences\nTBD')) |
    wrap_elements(grid::textGrob('Positive experiences\nTBD')) |
    wrap_elements(grid::textGrob('Life satisfaction\nTBD'))) /
  p_tmp
```

A table of smallest and greatest country-level estimates

```{r}
forest_data %>% 
  drop_na(country) %>% 
  select(-.draw, -r_region) %>% 
  group_by(cause) %>% 
  filter(
    r_country %in% 
      c(min(r_country, na.rm = T), max(r_country, na.rm = T))
  ) %>% 
  kbl() %>% 
  kable_paper(html_font = Font, full_width = FALSE)
```


### Figure: Between country effects

```{r}
tmp <- dat %>% 
  group_by(region, country, cause) %>% 
  summarise(
    internet = mean(internet, na.rm = TRUE),
    val = mean(val, na.rm = TRUE)
  ) 
tmp %>% 
  group_by(cause, region) %>% 
  summarise(tidy(lm(scale(val) ~ scale(internet), data = cur_data()))) %>% 
  filter(term != "(Intercept)") 
tmp %>% 
  ggplot(aes(internet, val)) +
  geom_point() +
  stat_smooth(method = "lm", se = F) +
  facet_grid(cause~region, scales = "free_y")

plot(conditional_effects(fits_2c$fit[[3]], "i1_cb"), points = TRUE)
x <- conditional_effects(fits_2c$fit[[3]], "i1_cb")[[1]]

x <- fits_2c$fit[[3]]
y <- fitted(x)
as_tibble(cbind(x$data, y)) %>% 
  arrange(desc(Estimate))
```

### Sex and Age

```{r}
tmp <- fits_2c %>% 
  mutate(
    out = map(
      fit, 
      ~emtrends(.x, var = "i1_cw", by = c("sex"), at = list(age1=0, age2=0))
    )
  )
tmp$out[[1]] %>% summary
```


Calculate coefficients from contrast coded factors

```{r}
get_coefs <- function(x) {
  h <- c(
    `10 to 14` = 
      "i1_cw + age1:i1_cw*1 + age2:i1_cw*0 = 0",
    `15 to 19` = 
      "i1_cw + age1:i1_cw*0 + age2:i1_cw*1 = 0",
    `20 to 24` = 
      "i1_cw + age1:i1_cw*-1 + age2:i1_cw*-1 = 0",
    `Female` = 
      "i1_cw + sex1:i1_cw*1 = 0",
    `Male` = 
      "i1_cw + sex1:i1_cw*-1 = 0"
  )
  
  # Average samples
  avg_h <- hypothesis(x, h)
  avg_s <- avg_h$samples %>% as_tibble()
  names(avg_s) <- avg_h$hypothesis$Hypothesis  
  avg_s <- avg_s %>% 
    pivot_longer(everything()) %>% 
    mutate(name = paste("Average", name, sep = "-"))
  
  # Region samples
  region_h <- hypothesis(x, h, scope = "coef", group = "region")
  region_s <- region_h$samples %>% as_tibble()
  names(region_s) <- paste(
    region_h$hypothesis$Group, 
    region_h$hypothesis$Hypothesis, 
    sep = "-"
  )
  region_s <- region_s %>% 
    pivot_longer(everything())
  
  # Country means
  country_h <- hypothesis(
    x, h, scope = "ranef", group = "country"
  )$hypothesis %>% 
    as_tibble()
  country_h <- country_h %>% 
    left_join(
      distinct(x$data, region, country), 
      by = c("Group" = "country")
    ) %>% 
    select(region, Hypothesis, Estimate, country = Group)
  
  # Add region coefs to country ranefs
  country_h <- left_join(
    country_h, 
    region_h$hypothesis %>% 
      rename(region = Group, coef = Estimate)
  ) %>% 
    mutate(Estimate = Estimate + coef)
  
  # Join all to one data frame
  samples <- bind_rows(avg_s, region_s) %>% 
    separate(name, into = c("region", "Hypothesis"), sep = "-") %>% 
    bind_rows(country_h)
  
  # Verify that naming worked
  # region_h$hypothesis %>% 
  #   left_join(
  #     samples %>% 
  #       group_by(region, Hypothesis) %>% 
  #       summarise(xxx = mean(value)),
  #     by = c("Group" = "region", "Hypothesis")
  #   ) %>% 
  #   as_tibble() %>% 
  #   filter(xxx != Estimate)
  
  samples
}
tmp <- fits %>% 
  mutate(out = map(fit2, get_coefs)) %>% 
  select(-fit1, -fit2)

tmp <- tmp %>% 
  unnest(out) %>% 
  mutate(is_average = region=="Average") %>% 
  mutate(region = fct_relevel(region, "Average")) %>% 
  mutate(panel = if_else(str_detect(Hypothesis, "ale"), "Sex", "Age")) %>% 
  mutate(
    side = if_else(Hypothesis %in% c("10 to 14", "Female"), "top", "bottom")
  )

tmp_regions <- tmp %>% 
  filter(is.na(country)) %>% 
  filter(Hypothesis != "15 to 19")

tmp_countries <- tmp %>% 
  filter(!is.na(country)) %>% 
  filter(Hypothesis != "15 to 19") %>% 
  mutate(is_average = FALSE)

tmp_text <- tmp_regions %>% 
  select(cause, region, Hypothesis, value) %>% 
  group_by(cause, region, Hypothesis) %>% 
  mutate(.draw = 1:n()) %>% 
  pivot_wider(names_from = Hypothesis, values_from = value) %>%
  mutate(Age = `20 to 24` - `10 to 14`, Sex = Female - Male) %>% 
  summarise(
    parameters(
      cur_data_all() %>% select(Age, Sex), 
      test = "pd", 
      centrality = "mean",
      ci_method = "quantile"
    )
  ) %>% 
  mutate(
    across(
      where(is.numeric), 
      ~if_else(
        cause=="Selfharm", 
        format(round(., 3), nsmall = 3), 
        format(round(., 2), nsmall = 2)
      )
    )
  ) %>% 
  mutate(is_average = region=="Average") %>% 
  mutate(region = fct_relevel(region, "Average")) %>% 
  mutate(panel = Parameter)

tmp_regions %>%   
  ggplot(aes(value, region, col = Hypothesis, fill = Hypothesis)) +
  scale_alpha_manual(values = c(.3, .6)) +
  scale_color_brewer(
    "Group",
    palette = "Set1",
    aesthetics = c("color", "fill")
  ) +
  scale_shape_manual(
    values = c(21, 19), guide = "none"
  ) +
  geom_vline(xintercept = 0, lty = 2, size = .2) +
  scale_y_discrete(
    expand = expansion(c(0.1, .1)),
    labels = function(x) if_else(x == "Average", "**Average**", x)
  ) +
  scale_x_continuous(
    "Conditional effect of 100% increase in internet adoption on outcome", 
    breaks = pretty_breaks(), 
    labels = function(x) percent(x/100, .01) %>% str_remove("\\.00"),
    expand = expansion(c(.01, .1))
  ) +
  stat_halfeye(
    point_interval = NULL, normalize = "panels", 
    height = .75, adjust = 1,
    aes(side = side, group = side, alpha = is_average), 
    show.legend = FALSE
  ) +
  # geom_point(
  #   data = tmp_countries %>% 
  #     drop_na(region),
  #   aes(x = Estimate, shape = Star=="*"),
  #   size = .5, alpha = .4, fill = "white",
  #   position = position_dodge2v(.5)
  # ) +
  stat_pointinterval(
    alpha = 1, .width = c(.95),
    interval_size = .4,
    point_size = 1.5,
    fill = "white",
    aes(shape = after_stat(xmin > 0 | xmax < 0), group = side),
    position = position_dodgev(.2), key_glyph = draw_key_point
  ) +
  geom_richtext(
    data = tmp_text %>% 
      mutate(Hypothesis = NA) %>% 
      mutate(
        Mean = if_else(
          as.numeric(pd) >= .95,
          str_glue("**{Mean}**"), 
          Mean
        ),
      ),
    aes(
      x = Inf,
      label = str_glue("{Mean} [{CI_low}, {CI_high}]")
    ),
    size = 2.5, hjust = 1, col = "black", 
    family = Font, label.color = NA, 
    label.padding = unit(0, "pt"),
    show.legend = FALSE
  ) +
  facet_grid2(panel ~ cause, scales = "free_x", axes = "x") +
  theme(
    legend.position = "right",
    axis.title.y = element_blank(),
    axis.text.y = element_markdown()
  )
```


```{r}
# Get some stuff and transform
get_draws <- function(x) {
  draws_region <- spread_draws(
    x, 
    b_i1_cw, `b_sex1:i1_cw`, `b_age1:i1_cw`, `b_age2:i1_cw`,
    r_region[region, term] | term
  ) %>% 
    mutate(
      `10 to 14` = b_i1_cw + i1_cw + 
        `age1:i1_cw`*1 + `b_age1:i1_cw`*1 +
        `age2:i1_cw`*0 + `b_age2:i1_cw`*0,
      `15 to 19` = b_i1_cw + i1_cw + 
        `age1:i1_cw`*0 + `b_age1:i1_cw`*0 +
        `age2:i1_cw`*1 + `b_age2:i1_cw`*1,
      `20 to 24` = b_i1_cw + i1_cw + 
        `age1:i1_cw`*-1 + `b_age1:i1_cw`*-1 +
        `age2:i1_cw`*-1 + `b_age2:i1_cw`*-1,
      Female = b_i1_cw + i1_cw + `sex1:i1_cw`*1 + `b_sex1:i1_cw`*1,
      Male = b_i1_cw + i1_cw + `sex1:i1_cw`*-1 + `b_sex1:i1_cw`*-1,
      Age = `20 to 24` - `10 to 14`,
      Sex = Female - Male
    ) %>% 
    select(region, `10 to 14`:Sex)
  
  draws_avg <- spread_draws(
    x, 
    b_i1_cw, `b_sex1:i1_cw`, `b_age1:i1_cw`, `b_age2:i1_cw`,
  ) %>% 
    mutate(
      `10 to 14` = b_i1_cw + `b_age1:i1_cw`*1 + `b_age2:i1_cw`*0,
      `15 to 19` = b_i1_cw + `b_age1:i1_cw`*0 + `b_age2:i1_cw`*1,
      `20 to 24` = b_i1_cw + `b_age1:i1_cw`*-1 + `b_age2:i1_cw`*-1,
      Female = b_i1_cw + `b_sex1:i1_cw`*1,
      Male = b_i1_cw + `b_sex1:i1_cw`*-1,
      Age = `20 to 24` - `10 to 14`,
      Sex = Female - Male
    ) %>% 
    select(`10 to 14`:Sex) %>% 
    mutate(region = "**Average**")
  
  draws <- bind_rows(
    "regions" = draws_region,
    "average" = draws_avg, 
    .id = "Level"
  ) %>% 
    mutate(region = str_replace(region, "\\.", "\n")) %>% 
    ungroup()
  draws
}

draws <- fits_2c %>% 
  mutate(out = map(fit, get_draws)) %>% 
  select(-fit) %>% 
  unnest(out)

# Summaries of differences
draws_sum <- draws %>% 
  select(cause, region, Age, Sex) %>% 
  group_by(cause, region) %>% 
  summarise(
    describe_posterior(
      cur_data(), centrality = "mean", test = "pd"
    )
  ) %>% 
  rename(panel = Parameter) %>% 
  mutate(across(where(is.numeric), ~round(., 2)))

draws %>% 
  select(cause, Level, region, c(`10 to 14`, `20 to 24`, Female, Male)) %>% 
  pivot_longer(-c(region, Level, cause), names_to = "Group") %>% 
  mutate(panel = if_else(str_detect(Group, "ale"), "Sex", "Age")) %>% 
  mutate(
    side = if_else(Group %in% c("10 to 14", "Female"), "top", "bottom")
  ) %>% 
  mutate(region = str_replace(region, "\\.", " ")) %>% 
  mutate(region = fct_relevel(region, "**Average**")) %>% 
  ggplot(aes(value, region, col = Group, fill = Group)) +
  scale_alpha_manual(values = c(.6, .3)) +
  geom_vline(xintercept = 0, lty = 2, size = .2) +
  scale_shape_manual(
    values = c(21, 19), guide = "none"
  ) +
  scale_y_discrete(expand = expansion(c(0.1, 0.1))) +
  scale_x_continuous(
    "Magnitude of association between internet adoption and well-being", 
    breaks = pretty_breaks(), 
    expand = expansion(c(0, .05))
  ) +
  stat_halfeye(
    point_interval = NULL, normalize = "panels", 
    height = .75, adjust = 1.5,
    aes(side = side, group = side, alpha = Level), 
    show.legend = FALSE
  ) +
  stat_pointinterval(
    alpha = 1, .width = c(.9),
    interval_size = .33,
    point_size = 1.25,
    fill = "white",
    aes(shape = after_stat(xmin > 0 | xmax < 0), group = side),
    position = position_dodgev(.25), key_glyph = draw_key_point
  ) +
  geom_richtext(
    data = draws_sum %>% 
      mutate(Group = NA) %>% 
      filter(cause %in% c("Anxiety", "Depression", "Selfharm")),
    aes(
      x = Inf, 
      label = str_glue("*d* = {Mean} (p<sup>d</sup> = {percent(pd, 1)})")
    ),
    size = 2.5, hjust = 1,
    family = Font,
    fill = NA, label.color = NA,
    show.legend = FALSE
  ) +
  facet_grid2(panel ~ cause, scales = "free_x", axes = "x") +
  guides(
    alpha = "none"
  ) +
  theme(
    legend.position = "right",
    axis.title.y = element_blank(),
    axis.text.y = element_markdown()
  )
```

### Fitted lines

Plot of fitted lines

```{r}
# Prediction dataframe: Min and max vals are enough for line
x_country <- fits$fit2[[1]]$data %>% 
  group_by(country) %>% 
  mutate(
    xmin = min(i1_cw, na.rm = TRUE), 
    xmax = max(i1_cw, na.rm = TRUE)
  ) %>% 
  filter(i1_cw %in% c(xmin, xmax)) %>% 
  mutate(year = 0) %>% 
  ungroup()

pred_country <- fits %>% 
  mutate(
    pred_country = map(
      fit2, ~epred_draws(
        .x, 
        x_country,
        ndraws = 100
      ) %>% 
        group_by(region, country, i1_cw) %>% 
        mean_qi(.epred)
    )
  )

x_region <- x_country %>% 
  distinct(region, sex, age, i1_cb) %>% 
  group_by(region) %>% 
  mutate(i1_cb = mean(i1_cb, na.rm = T)) %>% 
  crossing(i1_cw = seq(-.4, .4, length = 10)) %>% 
  mutate(year = 0, se = 1)

pred_region <- fits %>% 
  mutate(
    pred_region = map(
      fit2, ~epred_draws(
        .x, 
        x_region,
        re_formula = 
          ~(year * sex + year * age + i1_cw * sex + i1_cw * age | region),
        ndraws = 100
      ) %>% 
        group_by(region, i1_cw) %>% 
        mean_qi(.epred)
    )
  )

pred_region <- pred_region %>% 
  select(-fit1, -fit2) %>%
  unnest(pred_region) %>%
  mutate(cause = fct_rev(fct_inorder(factor(cause))))

pred_country %>% 
  select(-fit1, -fit2) %>% 
  unnest(pred_country) %>% 
  bind_rows(select(pseudo_gwp, region, cause), .) %>% 
  mutate(cause = fct_inorder(cause)) %>%
  ggplot(aes(i1_cw, .epred)) +
  scale_x_continuous(
    "Previous year's internet adoption relative to country average in 2000-2020",
    breaks = c(-.35, 0, .35),
    labels = function(x) percent(x, 1)
  ) +
  scale_y_continuous(
    "Estimated rate or scale score",
    breaks = pretty_breaks(),
    labels = function(x) percent(x/100, .01) %>% str_remove("\\.00")
  ) +
  geom_blank() +
  geom_ribbon(
    data = pred_region,
    aes(ymin = .lower, ymax = .upper),
    alpha = .15, fill = "dodgerblue4"
  ) +
  geom_line(
    data = pred_region,
    col = "dodgerblue4", size = .6
  ) +
  geom_line(
    aes(group = country), 
    size = .4, alpha = .35, col = "dodgerblue1"
  ) +
  facet_grid(cause~region, scales = "free_y") +
  theme(
    panel.spacing = unit(2, "pt"),
    axis.title.y = element_blank()
  )
```
