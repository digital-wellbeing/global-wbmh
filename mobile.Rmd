# Other internet metrics

In this section we reproduce Model 2 results from @sec-associations but instead of using the ITU internet user proportions, we look at mobile broadband subscription percentages as the predictor.

```{r setup}
#| cache: false
# Packages
library(scales)
library(ggtext)
library(lubridate)
library(kableExtra)
library(memoise)
library(cachem)
library(ggstance)
library(mgcv)
library(brms)
library(cmdstanr)
library(ellipse)
library(ggh4x)
library(tidybayes)
library(bayestestR)
library(ggdist)
library(posterior)
library(parameters)
library(emmeans)
library(broom)
library(tidyverse)

cd <- cache_disk("memoise_cache", max_size = Inf)
```


```{r}
# Load data sets
dat <- read_rds("data/data-all.rds")
itu <- read_rds("data/itu.rds")

# Countries and regions
countries <- dat %>% 
  distinct(region, country)

# Load models
oo <- c(
  "Life_satisfaction", "Negative_experiences", "Positive_experiences",
  "Anxiety", "Depression", "Selfharm"
)
fits <- tibble(outcome = oo) %>% 
  mutate(outcome = factor(outcome, levels = oo))
```

## Data figures

```{r}
itu %>% 
  filter(year > 2007) %>% 
  mutate(year = make_date(year)) %>%
  ggplot(aes(year, mobile)) +
  scale_y_continuous(
    "Value",
    labels = function(x) percent(x, .01) %>% str_remove("\\.00"),
    breaks = pretty_breaks()
  ) +
  scale_x_date(
    "Year",
    date_breaks = "3 years",
    date_labels = "'%y",
    expand = expansion(.01)
  ) +
  geom_line(
    aes(group = country),
    alpha = .25, size = .4, color = "dodgerblue1"
  ) +
  stat_summary(
    fun = mean, geom = "line",
    size = .6, color = "dodgerblue4"
  ) +
  facet_wrap(
    ~region,
    labeller = as_labeller(function(x) str_replace(x, "_", "\n")),
    nrow = 1
  ) +
  theme(
    aspect.ratio = 2,
    legend.position = "none",
    panel.spacing = unit(3, "pt"),
    axis.title.y = element_blank()
  )
```

## Main result: Association

```{r}
get_fixef <- function(outcome, var = "m1_cw"){
  fixef(
    readRDS(str_glue("models/brm-{outcome}-2-mobile.rds")), 
    summary = FALSE
  )[,var , drop = FALSE] %>% 
    summarise_draws(
      mean, sd,
      ~quantile2(., probs = c(.025, .1, .5, .9, .975)),
      pd = ~pd(as.numeric(.)), 
      rhat
    ) %>% 
    mutate(pd = percent(pd, .1))
}
get_fixef <- memoise(get_fixef, cache = cd)

fits_fixef <- fits %>% 
  mutate(out = map(outcome, ~get_fixef(.x))) %>% 
  select(outcome, out) %>% 
  unnest(out)

fits_fixef %>%   
  mutate(across(mean:q97.5, ~./10)) %>% 
  kbl(
    digits = 2, 
    caption = "Model 2 population level associations (% increase per 10% increase in mobile broadband subscriptions)"
  ) %>% 
  kable_custom()
```

This table shows the population-level (average across region, country, age) associations. We then summarise the region- and country-level trends in a table.

```{r}
# Region coefficients
get_region_coef <- function(outcome) {
  coef(
    readRDS(str_glue("models/brm-{outcome}-2-mobile.rds")), 
    summary = FALSE
  )$region[,,"m1_cw"] %>% 
    summarise_draws(
      mean, sd,
      ~quantile2(., probs = c(.025, .1, .5, .9, .975)),
      pd = ~pd(as.numeric(.)), 
      rhat
    ) %>% 
    mutate(pd = percent(pd, .1))
}
get_region_coef <- memoise(get_region_coef, cache = cd)

cw_region <- fits %>% 
  mutate(out = map(outcome, ~get_region_coef(.x))) %>% 
  select(outcome, out) %>% 
  unnest(out)
cw_region <- rename(cw_region, region = variable)

# Country random deviations + region coefficients
get_country_ranef <- function(outcome) {
  ranef(
    readRDS(str_glue("models/brm-{outcome}-2-mobile.rds")), 
    summary = FALSE
  )$country[,,"m1_cw"] %>% 
    summarise_draws(
      mean, sd,
      ~quantile2(., probs = c(.025, .1, .5, .9, .975)),
      pd = ~pd(as.numeric(.)), 
      rhat
    ) %>% 
    mutate(pd = percent(pd, .1))
}
get_country_ranef <- memoise(get_country_ranef, cache = cd)

cw_country <- fits %>% 
  mutate(out = map(outcome, ~get_country_ranef(.x))) %>% 
  select(outcome, out) %>% 
  unnest(out)

# Add region coefs
cw_country <- cw_country %>% 
  rename(country = variable) %>% 
  left_join(countries) %>% 
  left_join(
    select(cw_region, outcome, region, mean_region = mean)
  ) %>% 
  mutate(across(mean:q97.5, ~. + mean_region)) %>% 
  # pd doesn't work without the region coefs
  select(-mean_region, -pd)

cw_region %>% 
  mutate(across(mean:q97.5, ~./10)) %>% 
  arrange(outcome, mean) %>% 
  kbl(
    digits = 2, 
    caption = "Region-specific associations, arranged by outcome and magnitude"
  ) %>% 
  kable_custom() %>% 
  scroll_box("500px")

cw_country %>% 
  mutate(across(mean:q97.5, ~./10)) %>% 
  select(outcome, country, everything()) %>% 
  arrange(outcome, mean) %>% 
  kbl(
    digits = 2, 
    caption = "Country-specific associations, ordered by outcome and magnitude"
  ) %>% 
  kable_custom() %>% 
  scroll_box("500px")
```

### Coefficient plot

Putting these together into a plot

```{r}
tmp <- cw_country %>%
  mutate(Level = "Country") %>% 
  mutate(s = sign(q2.5) == sign(q97.5))

bind_rows(
  "Average" = fits_fixef %>% mutate(region = "**Average**"),
  "Region" = cw_region,
  .id = "Level"
) %>% 
  mutate(region = fct_relevel(region, "**Average**")) %>% 
  mutate(s = sign(q2.5) == sign(q97.5)) %>% 
  # Effect of 10% increase
  # mutate(across(c(mean:q97.5), ~./10)) %>% 
  ggplot(aes(mean, region, shape = s)) +
  scale_shape_manual(values = c(21, 19)) +
  scale_y_discrete(
    labels = ~str_replace(., "_", " "),
    expand = expansion(c(0.05, 0.125))
  ) +
  scale_x_continuous(
    "Conditional lagged effect of 10% increase in mobile broadband subscriptions",
    breaks = pretty_breaks(5),
    # Effect of 10% increase
    # X is 0-1, y is 0-100, so x/1000
    labels = function(x) percent(x / 1000, .001) %>% 
      str_remove("\\.000") %>% 
      str_remove("!^0(?=%)"),
    expand = expansion(c(0.05, .05))
  ) +
  geom_vline(xintercept = 0, lty = 2, size = .2) +
  geom_point(
    data = tmp %>%
      mutate(across(c(mean:q97.5))),
    size = .5, col = "dodgerblue1",
    position = ggbeeswarm::position_quasirandom(width = .25, groupOnX = F)
  ) +
  geom_linerange(
    aes(xmin = q10, xmax = q90), size = 1, col = "dodgerblue4"
  ) +
  geom_pointrangeh(
    aes(xmin = q2.5, xmax = q97.5), col = "dodgerblue4",
    fatten = 4, fill = "white", stroke = .75
  ) +
  # geom_richtext(
  #   aes(x = Inf, label = str_glue("{percent(mean/100, .01)}<br>[{percent(q2.5/100, .01)} {percent(q97.5/100, .01)}]")), 
  #   hjust = 1, vjust = 0.15, size = 2.7, lineheight = .9,
  #   col = "black", fill = NA, label.color = NA
  # ) +
  facet_wrap(
    "outcome", scales = "free_x", ncol = 3,
    labeller = as_labeller(~str_replace(., "_", " "))) +
  theme(
    axis.title.y = element_blank(),
    axis.text.y = element_markdown(), 
    panel.spacing.x = unit(12, "pt"),
    legend.position = "none"
  )
```

## Between-country correlation

```{r}
#| column: page-right
#| fig.width: 8
#| fig.height: 6
#| fig-cap: "Between-country associations"
#| label: fig-cb1

fitted_cb1 <- function(outcome) {
  fit <- readRDS(str_glue("models/brm-{outcome}-2-mobile.rds"))
  newx <- fit$data %>%
    group_by(region, country) %>%
    summarise(m1_cb = unique(m1_cb), val = mean(val, na.rm = TRUE)) %>% 
    mutate(m1_cw = 0, year = 0, sex = NA, age = NA, se = 0) %>% 
    ungroup()
  
  newy <- bind_cols(
    newx,
    as.data.frame(
      fitted(
        fit, 
        newdata = newx, 
        re_formula = NA
      )
    )
  )
  newy
}
fitted_cb1 <- memoise(fitted_cb1, cache = cd)

tmp <- fits %>% 
  mutate(out = map(outcome, fitted_cb1)) %>% 
  select(outcome, out) %>%
  unnest(out)

cb1_pars <- fits %>%
  mutate(
    out = map(
      outcome,
      ~ as_draws_df(
        readRDS(str_glue("models/brm-{.x}-2-mobile.rds")),
        variable = "b_m1_cb"
      ) %>%
        summarise_draws(mean, sd, ~ quantile2(., probs = c(.025, .975)))
    )
  ) %>%
  select(outcome, out) %>%
  unnest(out) %>%
  mutate(across(where(is.numeric), ~ number(., .01)))

tmp %>% 
  ggplot(aes(m1_cb, val)) +
  scale_x_continuous(
    "Between-country centered mobile broadband subscription rate",
    labels = ~percent(.)
  ) +
  scale_y_continuous(
    "Value",
    labels = ~percent(./100),
    breaks = extended_breaks()
  ) +
  geom_point(
    shape = 1, size = 1, alpha = .75, col = "dodgerblue1"
  ) +
  geom_ribbon(
    aes(ymin = Q2.5, ymax = Q97.5),
    alpha = .2, fill = "dodgerblue1"
  ) +
  geom_line(
    aes(y = Estimate), 
    col = "dodgerblue4", size = 1
  ) +
  geom_smooth(
    method = "lm", se = F, 
    size = .5, col = "black", lty = 2
  ) +
  geom_text(
    data = cb1_pars,
    aes(
      x = -Inf, 
      y = Inf, 
      label = str_glue("{mean} [{q2.5}, {q97.5}]")
    ),
    vjust = 1.3, hjust = -0.025, size = 2.8, family = Font
  ) +
  facet_wrap(
    "outcome",
    scales = "free_y", nrow = 1,
    labeller = as_labeller(~str_replace(., "_", " "))
  ) +
  theme(
    aspect.ratio = 1,
    axis.title.y = element_blank()
  )
```

Here are these correlations calculated from data

```{r}
# From data
tmp <- dat %>% 
  mutate(outcome = factor(outcome, levels = oo)) %>% 
  group_by(outcome, region, country) %>% 
  summarise(
    val = mean(val, na.rm = TRUE),
    internet = mean(m1_cb, na.rm = TRUE)
  )
tmp_tab <- tmp %>% 
  summarise(
    tidy(
      lm(
        scale(val) ~ scale(internet), 
        data = cur_data()
      ), 
      conf.int = TRUE
    )
  ) %>% 
  ungroup() %>%
  filter(term != "(Intercept)") %>% 
  mutate(across(where(is.numeric), ~number(., .01))) %>% 
  transmute(
    outcome = outcome,
    r_CI = str_glue("{estimate}, [{conf.low}, {conf.high}]")
  )

tmp %>% 
  group_by(region) %>% 
  # mutate(r = mean(val, na.rm = TRUE), val = val - r) %>%  
  ggplot(aes(internet, val)) +
  scale_x_continuous(
    "Between-country centered mobile subscription rate",
    labels = ~percent(.)
  ) +
  scale_y_continuous(
    "Value",
    labels = ~percent(./100)
  ) +
  geom_point(
    shape = 1, size = 1, alpha = .75, col = "dodgerblue1"
  ) +
  geom_smooth(method = "lm") +
  facet_wrap(
    "outcome",
    scales = "free_y", nrow = 2,
    labeller = as_labeller(~str_replace(., "_", " "))
  ) +
  theme(
    aspect.ratio = 1,
    axis.title.y = element_blank()
  )
```

## Demographics 

Associations

```{r}
h <- c(
  # Intercept_Male = "Intercept + sex1 * -1 = 0",
  # Intercept_Female = "Intercept + sex1 * 1 = 0",
  Slope_Male = "m1_cw + m1_cw:sex1 * -1 = 0",
  Slope_Female = "m1_cw + m1_cw:sex1 * 1 = 0"
)

get_hyp <- function(outcome, h, model) {
  fit <- readRDS(str_glue("models/brm-{outcome}-{model}.rds"))
  hypothesis(fit, h, scope = "coef", group = "age")$hypothesis
}
get_hyp <- memoise(get_hyp, cache = cd)

tmp <- fits %>% 
  mutate(
    out = map(
      outcome,
      ~get_hyp(.x, h = h, model = "2-mobile")
    )
  )
  
p_tmp <- tmp %>%
  unnest(out) %>% 
  mutate(Group = fct_relevel(Group, "10 to 14")) %>% 
  select(outcome:CI.Upper) %>% 
  separate(Hypothesis, c("Parameter", "Sex")) %>% 
  mutate(s = sign(CI.Lower) == sign(CI.Upper)) %>% 
  ggplot(aes(Group, Estimate, col = Sex, shape = s)) +
  scale_color_brewer(
    "", palette = "Set1", direction = -1
  ) +
  scale_shape_manual(values = c(21, 19), guide = NULL) +
  scale_y_continuous(
    breaks = extended_breaks(),
    labels = ~percent(./1000), 
    expand = expansion(.4)
  ) +
  geom_hline(yintercept = 0, lty = 2, size = .2) +
  geom_pointrange(
    aes(ymin = CI.Lower, ymax = CI.Upper),
    position = position_dodge(.5),
    size = .5, fatten = 2.5, fill = "white", stroke = .75,
  ) +
  facet_wrap(
    ~outcome, scales = "free_y", ncol = 3,
    labeller = as_labeller(~str_replace(., "_", " "))) +
  theme(
    axis.text.x = element_text(angle = 90),
    axis.title.x = element_blank()
  )
p_tmp %+% 
  filter(p_tmp$data, Parameter == "Slope") +
  geom_hline(yintercept = 0, lty = 2, size = .2) +
  labs(y = "Conditional lagged effect of\n10% increase in internet adoption")
```

And for all regions too

```{r}
get_region_association_demo <- function(outcome) {
  x <- readRDS(str_glue("models/brm-{outcome}-2-mobile.rds"))
  tmp <- x$data %>% 
    group_by(region, age, sex) %>% 
    summarise(m1_cb = mean(m1_cb, na.rm = TRUE)) %>% 
    ungroup() %>% 
    # Note .1 for 10% change
    crossing(m1_cw = c(0, .1), se = 0, year = 0) %>% 
    add_epred_draws(
      x,
      re_formula = ~ (m1_cw*sex | age) + 
        (m1_cw*sex | region) + (m1_cw*sex | age:region),
      ndraws = 1000
    ) %>% 
    ungroup()
  tmp %>% 
    select(-.row, -se, -.chain, -.iteration) %>% 
    pivot_wider(names_from = m1_cw, values_from = .epred) %>% 
    mutate(delta = `0.1` - `0`) %>% 
    select(region, sex, age, .draw, delta) %>% 
    group_by(region, sex, age) %>% 
    mean_qi(delta)
}
get_region_association_demo <- memoise(
  get_region_association_demo, cache = cd
)

tmp <- fits %>% 
  mutate(out = map(outcome, get_region_association_demo))

x <- sort(unique(dat$age))
tmp %>% 
  unnest(out) %>% 
  mutate(star = sign(.lower) == sign(.upper)) %>% 
  mutate(age = fct_relevel(age, "10 to 14")) %>% 
  ggplot(aes(age, delta, col = sex, group = sex)) +
  geom_hline(yintercept = 0, lty = 2, size = .25) +
  scale_color_brewer(
    "", palette = "Set1", direction = -1, 
    aesthetics = c("color", "fill")
  ) +
  scale_x_discrete(
    "Age",
    breaks = x[seq(1, length(x), 2)],
  ) +
  scale_y_continuous(
    "Conditional lagged effect of\n10% increase in mobile broadband subscriptions",
    labels = ~percent(./1000, .01) %>% 
      str_remove("\\.00(?=%)") %>% 
      str_remove("\\.0(?=%)")
  ) +
  # geom_linerange(
  #   aes(ymin = .lower, ymax = .upper), 
  #   size = .2,
  #   position = position_dodge2(.1)
  # ) +
  geom_ribbon(
    aes(ymin = .lower, ymax = .upper, fill = sex), 
    alpha = .2, col = NA
    ) +
  geom_line(size = .6) +
  # geom_point(
  #   size = .8, fill = "white"
  # ) +
  facet_grid(
    outcome~region, scales = "free_y",
    labeller = as_labeller(~str_replace(., "_", "\n"))
  ) +
  theme(
    text = element_text(size = 10),
    axis.text.x = element_text(angle = 90)
  )
```

Post hoc?

```{r}
yvo_association <- function(outcome) {
  x <- readRDS(str_glue("models/brm-{outcome}-2-internet.rds"))
  y <- coef(x, summary = FALSE)$age[,,"i1_cw"]
  delta <- mean_qi(
    rowMeans(y[,c("15 to 19", "20 to 24")]) - 
      rowMeans(y[,c("25 to 29", "30 to 34")])
    )
  delta
}

yvo_association <- memoise(
  yvo_association, cache = cd
)

tmp <- fits %>% 
  mutate(out = map(outcome, yvo_association))

tmp %>% 
  unnest(out) %>% 
  select(-.point, -.interval) %>% 
  mutate(across(y:ymax, ~percent(./1000)))
```


