## Demographics

```{r setup}
#| cache: false
# Packages
library(scales)
library(ggtext)
library(lubridate)
library(kableExtra)
library(ggstance)
library(mgcv)
library(brms)
library(cmdstanr)
library(ellipse)
library(ggh4x)
library(tidybayes)
library(ggdist)
library(posterior)
library(parameters)
library(emmeans)
library(broom)
library(dtplyr)
library(patchwork)
library(tidyverse)
```


```{r}
# Load data sets
itu <- read_rds("data/itu.rds")
gwp <- read_rds("data/gwp.rds")
gbd <- read_rds("data/gbd.rds")

oo <- c(
  "Life_satisfaction", "Negative_experiences", "Positive_experiences",
  "Anxiety", "Depression", "Selfharm"
)
```

We then turn to the third research question, to what extent are the changes in well-being, and associations between internet adoption and well-being different between the different demographic groups within adolescents? To answer, Models 1 and 2 also included age and sex as moderators of the trends and associations. In this section, we present results based on the moderated effects.

### Trends

```{r model1-demographics}
#| column: screen-inset-right
#| fig-width: 12
#| fig-height: 8
#| fig-cap: "Forest plot of linear trends in outcomes by demographic group"
#| label: fig-forest-trends-demo

fits <- tibble(outcome = oo) %>% 
  mutate(outcome = factor(outcome, levels = oo)) %>% 
  mutate(
    fit1 = map(
      outcome, 
      ~read_rds(str_glue("models/brm-{.x}-1-internet.rds"))
    )
  )

h_gwp <- c(
  `Female_15 to 19` =
    "val_year + val_year:sex1 * 1 + val_year:age1 * 1 + val_year:sex1:age1 * 1 = 0",
  `Female_20 to 24` =
    "val_year + val_year:sex1 * 1 + val_year:age1 * -1 + val_year:sex1:age1 * -1 = 0",
  `Male_15 to 19` =
    "val_year + val_year:sex1 * -1 + val_year:age1 * 1 + val_year:sex1:age1 * -1 = 0",
  `Male_20 to 24` =
    "val_year + val_year:sex1 * -1 + val_year:age1 * -1 + val_year:sex1:age1 * 1 = 0"
)

h_gbd <- c(
  `Female_10 to 14` =
    "val_year + val_year:sex1 * 1 + val_year:age1 * 1 + val_year:age2 * 0 + val_year:sex1:age1 * 1 + val_year:sex1:age2 * 0 = 0",
  `Female_15 to 19` =
    "val_year + val_year:sex1 * 1 + val_year:age1 * 0 + val_year:age2 * 1 + val_year:sex1:age1 * 0 + val_year:sex1:age2 * 1 = 0",
  `Female_20 to 24` =
    "val_year + val_year:sex1 * 1 + val_year:age1 * -1 + val_year:age2 * -1 + val_year:sex1:age1 * -1 + val_year:sex1:age2 * -1 = 0",
  `Male_10 to 14` =
    "val_year + val_year:sex1 * -1 + val_year:age1 * 1 + val_year:age2 * 0 + val_year:sex1:age1 * -1 + val_year:sex1:age2 * 0 = 0",
  `Male_15 to 19` =
    "val_year + val_year:sex1 * -1 + val_year:age1 * 0 + val_year:age2 * 1 + val_year:sex1:age1 * 0 + val_year:sex1:age2 * -1 = 0",
  `Male_20 to 24` =
    "val_year + val_year:sex1 * -1 + val_year:age1 * -1 + val_year:age2 * -1 + val_year:sex1:age1 * 1 + val_year:sex1:age2 * 1 = 0"
)

sexage_draws <- fits %>%
  mutate(h = list(h_gwp, h_gwp, h_gwp, h_gbd, h_gbd, h_gbd)) %>%
  mutate(
    samples = map2(
      fit1, h,
      ~ simple_effects_samples(.x, .y)
    )
  ) %>%
  select(outcome, samples) %>%
  unnest(samples)

sexage_draws <- sexage_draws %>%
  filter(region == "Average")

trends_demo <- sexage_draws %>%
  mutate(Hypothesis = str_replace(Hypothesis, "_", " ")) %>% 
  ggplot(
    aes(value, Hypothesis)
  ) +
  geom_vline(xintercept = 0, lty = 2, size = .2) +
  scale_shape_manual(values = c(21, 19), guide = "none") +
  scale_y_discrete(
    expand = expansion(c(0.1, .1))
  ) +
  scale_x_continuous(
    "Estimated linear change per decade",
    breaks = extended_breaks(5),
    labels = ~percent(. / 100, .001) %>% 
      # Remove trailing zeroes
      str_remove("[\\.000](?=%)") %>% 
      str_remove("[\\.00](?=%)"),
    expand = expansion(c(.05, .05))
  ) +
  stat_halfeye(
    point_interval = mean_qi, normalize = "xy",
    height = 1, alpha = .5, point_fill = "white",
    .width = .95, interval_alpha = 1, interval_size = .2,
    point_alpha = 1, point_size = 1.75, stroke = .75,
    fill = "dodgerblue1", adjust = 0.8,
    aes(
      shape = after_stat(xmin > 0 | xmax < 0)
    )
  ) +
  guides(
    color = guide_legend(
      override.aes = list(size = 3, alpha = 1),
      nrow = 2, ncol = 3, byrow = TRUE
    ),
    fill = guide_legend(
      nrow = 2, ncol = 3, byrow = TRUE
    )
  ) +
  facet_wrap(
    "outcome",
    scales = "free_x", nrow = 1,
    labeller = as_labeller(~ str_replace(., "_", " "))
  ) +
  theme(
    axis.title.y = element_blank(),
    axis.text.y = element_markdown(),
    legend.position = "bottom"
  )
trends_demo
```

```{r}
fits %>% 
  mutate(
    out = map(
      fit1,
      ~fixef(.x) %>% as.data.frame() %>% rownames_to_column("term")
    )
  ) %>% 
  select(outcome, out) %>% 
  unnest(out) %>% 
  filter(str_detect(term, "year:")) %>% 
  mutate(across(where(is.numeric), ~number(., .001))) %>% 
  kbl(caption = "Model 1 interaction parameters") %>% 
  kable_custom()
# contrasts(fits$fit1[[4]]$data$age)
# fixef(fits$fit1[[3]])
```


### Associations

```{r}
fits <- tibble(outcome = oo) %>% 
  mutate(outcome = factor(outcome, levels = oo)) %>% 
  mutate(
    fit2 = map(
      outcome, 
      ~read_rds(str_glue("models/brm-{.x}-2-internet.rds"))
    )
  )
```


```{r model2-demographics}
#| column: screen-inset-right
#| fig-width: 12
#| fig-height: 8
#| fig-cap: "Forest plot of associations by demographic group"
#| label: fig-forest-association-demo

tmp <- fits %>% 
  mutate(
    out = map(
      fit2,
      ~emtrends(.x, specs = c("sex", "age"), var = "year")
    )
  )

tmp <- tmp %>% 
  mutate(
    out2 = map(
      out,
      ~gather_emmeans_draws(.x)
    )
  ) %>% 
  select(outcome, out2)

associations_demo <- tmp %>% 
  unnest(out2) %>% 
  mutate(Hypothesis = paste(sex, age, sep = " ")) %>% 
  ggplot(
    aes(.value, Hypothesis)
  ) +
  geom_vline(xintercept = 0, lty = 2, size = .2) +
  scale_shape_manual(values = c(21, 19), guide = "none") +
  scale_y_discrete(
    expand = expansion(c(0.1, .1))
  ) +
  scale_x_continuous(
    "Conditional lagged effect of 10% increase in internet adoption",
    breaks = extended_breaks(5),
    labels = ~percent(. / 1000, .001) %>% 
      # Remove trailing zeroes
      str_remove("[\\.000](?=%)") %>% 
      str_remove("[\\.00](?=%)"),
    expand = expansion(c(.05, .05))
  ) +
  stat_halfeye(
    point_interval = mean_qi, normalize = "xy",
    height = 1, alpha = .5, point_fill = "white",
    .width = .95, interval_alpha = 1, interval_size = .2,
    point_alpha = 1, point_size = 1.75, stroke = .75,
    fill = "dodgerblue1", adjust = 0.8,
    aes(
      shape = after_stat(xmin > 0 | xmax < 0)
    )
  ) +
  guides(
    color = guide_legend(
      override.aes = list(size = 3, alpha = 1),
      nrow = 2, ncol = 3, byrow = TRUE
    ),
    fill = guide_legend(
      nrow = 2, ncol = 3, byrow = TRUE
    )
  ) +
  facet_wrap(
    "outcome",
    scales = "free_x", nrow = 1,
    labeller = as_labeller(~ str_replace(., "_", " "))
  ) +
  theme(
    axis.title.y = element_blank(),
    axis.text.y = element_markdown(),
    legend.position = "bottom"
  )
associations_demo
```

```{r}
trends_demo /
  associations_demo
```

```{r}
fits %>% 
  mutate(
    out = map(
      fit2,
      ~fixef(.x) %>% as.data.frame() %>% rownames_to_column("term")
    )
  ) %>% 
  select(outcome, out) %>% 
  unnest(out) %>% 
  filter(str_detect(term, ":i1_cw")) %>% 
  mutate(across(where(is.numeric), ~number(., .001))) %>% 
  kbl(caption = "Model 2 interaction parameters") %>% 
  kable_custom()
```

