# Models

```{r setup}
#| cache: false
# Packages
library(scales)
library(ggtext)
library(lubridate)
library(kableExtra)
library(ggstance)
library(mgcv)
library(cmdstanr)
library(ellipse)
library(ggh4x)
library(tidybayes)
library(ggdist)
library(posterior)
library(parameters)
library(emmeans)
library(broom)
library(brms)
library(tidyverse)
```

## Model 1

### Specification

We first tackle RQ1: To what extent did the outcomes change over time (1a), and were changes in outcomes correlated with changes in internet adoption between countries (1b). Model 1, a three-level bayesian meta-regression model, will provide answers, by simultaneously estimating trends over time for the outcome (e.g. Life satisfaction) and internet adoption, with shared covariance matrices over the two outcomes across regions and countries. We also include contrast-coded demographic factors as main effects and moderators, and can therefore examine whether the trends differ between demographic groups (RQ3)

We fit the model separately for each outcome. Although a full multivariate would additionally allow examining correlations in time trends of the outcomes, it is not plausible with the differential groups in the data sets (contrast coded demographic groups would be harder to interpret). We therefore estimate six separate bivariate models

In this model, internet adoption is treated as Beta-distributed and the outcomes are treated as gaussian. All the regression coefficients are allowed to vary randomly across regions and countries, with a shared correlation matrix of the random effects across the two model outcomes. This latter specification is important to allow answering RQ1b.

The GBD data are estimates with standard errors, and thus suggest that a model that incorporates the SEs would be appropriate. For this reason, and for reducing computational complexity, we have reshaped the GWP data similarly to aggregates per cell (mean and SE for each country \* year \* sex \* age). The one downside of this modelling strategy is that it does not converge for self-harm, probably because the means and SEs are highly correlated in those data. Therefore we estimate the model with SEs for all outcomes except self-harm, where we set the SEs to zero, leading to a regular (three-level) regression model.

We write the model as

$$
\begin{align*}
y_i &\sim \text{Normal}(\mu^y_i, \sigma^{2}v_i) \\
\mu^y_i &= \beta^{y}_{0} + \delta^{y}_{0\text{region}[i]} + 
\gamma^{y}_{0\text{country}[i]} + \\ &(\beta^y_{1} + \delta^{y}_{1\text{region}[i]} + \gamma^{y}_{1\text{country}[i]})\text{Time}_i + 
\\ &(\beta^y_{2} + \delta^{y}_{2\text{region}[i]} + \gamma^{y}_{2\text{country}[i]})\text{Sex}_i + 
\\ &(\beta^y_{3} + \delta^{y}_{3\text{region}[i]} + \gamma^{y}_{3\text{country}[i]})\text{Age}_i + 
\\ &(\beta^y_{4} + \delta^{y}_{4\text{region}[i]} + \gamma^{y}_{4\text{country}[i]})\text{Sex}_i \times \text{Time}_i + 
\\ &(\beta^y_{5} + \delta^{y}_{5\text{region}[i]} + \gamma^{y}_{5\text{country}[i]})\text{Age}_i \times \text{Time}_i \\ \\
x_i &\sim \text{Beta}(\mu^x_i, \phi) \\ 
\text{logit}(\mu^x_i) &= \beta^{x}_{0} + \delta^{x}_{0\text{region}[i]} + \gamma^{x}_{0\text{country}[i]} + \\ &(\beta^x_{1} + \delta^{x}_{1\text{region}[i]} + \gamma^{x}_{1\text{country}[i]})\text{Time}_i  \\ \\
\left[\begin{array}{c}
\delta^y_{0\text{region}} \\ \delta^y_{1\text{region}} \\ 
\delta^y_{2\text{region}} \\ \delta^y_{3\text{region}} \\ 
\delta^y_{4\text{region}} \\ \delta^y_{5\text{region}} \\ 
\delta^x_{0\text{region}} \\ \delta^x_{1\text{region}}
\end{array}\right] 
&\sim MVN(
\mathbf{0},
\Sigma^\text{r}
),
\left[\begin{array}{c}
\gamma^y_{0\text{country}} \\ \gamma^y_{1\text{country}} \\ 
\gamma^y_{2\text{country}} \\ \gamma^y_{3\text{country}} \\ 
\gamma^y_{4\text{country}} \\ \gamma^y_{5\text{country}} \\ 
\gamma^x_{0\text{country}} \\ \gamma^x_{1\text{country}}
\end{array}\right] 
\sim MVN(
\mathbf{0},
\Sigma^\text{c}
)
\end{align*}
$$ {#eq-model1}

Where $y_i$ are the outcomes, $x_i$ the internet adoption values, and $v_i$ indicate the known sampling variances.

We then define the model formulas in brms' formula syntax. First, for internet adoption, we take care to indicate that each internet adoption datum should be modelled only once, because the values are repeated in the outcome data table. To do this we use `resp_subset(itu)`, where `itu` indicates first unique rows of ITU data in the model. The `|c|` and `|r|` separating the random effects from their grouping factors indicate shared correlation matrices with other modelled parameters in the model (see the next model formula below).

```{r model1-itu-bf}
#| echo: true
```

Here, we specify the outcome model. Note the `|c|` and `|r|` that link the countries' and regions', respectively, random effects of this model with the previous' model. Then, we specify `resp_se(se, sigma = TRUE)` to enable "meta-regression" with known standard errors. In addition, it leads to the residual variance to be estimated.

```{r model1-val-bf}
#| echo: true
```

Finally, after numerous attempts we were unable to fit a model with meta-analytic standard errors with self-harm as the outcome in a way that would have converged. We therefore effectively removed the SEs from self-harm by setting them to zero

### Fitting

```{r fit-model-1}
#| cache: false

```

### Summary

Here is a summary of the data modelled for each outcome

```{r model-1-data-summary}
#| column: body-outset
#| tbl-cap: "Summaries of data included in Model 1"
#| label: tbl-m1-data

fits %>%
  mutate(summary = map(fit1, msum)) %>%
  select(outcome, summary) %>%
  unnest(summary) %>%
  kbl(caption = "Model 1 data summary") %>%
  kable_custom() %>% 
  row_spec(0, bold = TRUE)
```

### Model checking

Now that the models are fit we proceed to check them. We only do this for the "prototypical" model 1, and so can discard the rest for the rest of this section

#### MCMC diagnostics

First we take a look at numeric summaries of convergence and posterior effective sample sizes. The former should approach 1, the latter should approach the number of hmc iterations.

We can see that the models have converged nicely, apart from the self-harm outcome.

```{r model-1-diagnostics}
#| column: body-outset-right
#| label: tab-model1-diagnostic
#| tbl-cap: "HMC Diagnostics, Model 1 population-level regression coefficients and country-level (co)variance parameters."

diagnostic_table <- function(fit, rx, cp) {
  diag_1 <- fits %>%
    select(fit = {{ fit }}, outcome) %>% 
    mutate(
      out =
        map(
          fit,
          ~ as_draws_df(., variable = {{ rx }}, regex = TRUE) %>%
            summarise_draws(samples = length, default_convergence_measures())
        )
    ) %>%
    select(outcome, out) %>%
    unnest(out)
  diag_1 %>%
    kbl(
      caption = cp,
      digits = c(0, 0, 0, 2, 0, 0)
    ) %>%
    column_spec(
      4,
      color = "white",
      background = spec_color(
        log(diag_1$rhat),
        direction = 1,
        option = "C",
        end = .6
      )
    ) %>%
    column_spec(
      c(5, 6),
      color = "white",
      background = spec_color(
        log(diag_1$ess_tail / diag_1$samples),
        direction = 1,
        option = "C",
        end = 0,
        begin = .6
      )
    ) %>%
    kable_custom()
}
diagnostic_table(
  fit1,
  rx = c("^b_", "^sd_", "^cor_country__internet_year__val_year$"),
  cp = "Model 1 MCMC diagnostics."
) %>% 
  scroll_box(height = "300px")
```

#### Posterior predictive check

We then take a coarse look at how well the models reproduce the input data.

```{r ppcheck-density}
#| column: page-right
#| fig-height: 6
#| fig-width: 9
#| fig-cap: "Graphical posterior predictive check by region (Model 1). Thin red lines indicate model replicates, whereas the blue lines indicate data; the model is mostly in smooth agreement with data, but has greater discrepancies in some regions (e.g. Anglo Depression)."
#| label: fig-ppcheck-1

ppcheck_1 <- fits %>%
  group_by(outcome) %>%
  mutate(
    out = map(
      fit1,
      ~ pp_check(
        .x,
        ndraws = 10,
        type = "dens_overlay_grouped",
        group = "region",
        resp = "val",
        newdata = .x$data
      )[[1]]
    )
  ) %>%
  ungroup() %>% 
  select(outcome, out) %>%
  unnest(out)

ppcheck_1 %>%
  ggplot(aes(value, col = is_y, alpha = is_y, group = rep_id)) +
  scale_color_brewer(palette = "Set1") +
  scale_alpha_manual(values = c(.2, 1)) +
  stat_density(
    geom = "line",
    size = .75,
    position = position_identity()
  ) +
  labs(x = "Value", y = "Density") +
  facet_grid2(
    outcome ~ group,
    scales = "free", independent = "x",
    labeller = as_labeller(function(x) str_replace(x, "_", "\n"))
  ) +
  theme(
    legend.position = "none",
    panel.spacing = unit(3, "pt"),
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank()
  )
rm(ppcheck_1)
```

## Model 2

Model 2 was similar to Model 1, but the internet outcome was dropped, and the regression equation for outcomes expanded to include the lagged internet predictor and its two-way interactions


$$
\begin{align*}
y_i &\sim \text{Normal}(\mu_i, \sigma^2v_i) \\
\mu_i &= \beta_{0} + \delta_{0\text{region}[i]} + 
\gamma_{0\text{country}[i]} + \\ &(\beta_{1} + \delta_{1\text{region}[i]} + \gamma_{1\text{country}[i]})\text{Time}_i + 
\\ &(\beta_{2} + \delta_{2\text{region}[i]} + \gamma_{2\text{country}[i]})\text{Sex}_i + 
\\ &(\beta_{3} + \delta_{3\text{region}[i]} + \gamma_{3\text{country}[i]})\text{Age}_i + 
\\ &(\beta_{4} + \delta_{4\text{region}[i]} + \gamma_{4\text{country}[i]})\text{Sex}_i \times \text{Time}_i + 
\\ &(\beta_{5} + \delta_{5\text{region}[i]} + \gamma_{5\text{country}[i]})\text{Age}_i \times \text{Time}_i +
\\ &(\beta_{6} + \delta_{6\text{region}[i]} + \gamma_{6\text{country}[i]})\text{Internet}^{\text{t-1}}_i + 
\\ &(\beta_{7} + \delta_{7\text{region}[i]} + \gamma_{7\text{country}[i]})\text{Sex}_i \times \text{Internet}^{\text{t-1}}_i + 
\\ &(\beta_{8} + \delta_{8\text{region}[i]} + \gamma_{8\text{country}[i]})\text{Sex}_i \times \text{Internet}^{\text{t-1}}_i + 
\\ &\beta_9\text{Internet}^{\text{between}}_i\\ \\
\left[\begin{array}{c}
\delta_{0\text{region}} \\ \delta_{1\text{region}} \\ 
\delta_{2\text{region}} \\ \delta_{3\text{region}} \\ 
\delta_{4\text{region}} \\ \delta_{5\text{region}} \\ 
\delta_{6\text{region}} \\ \delta_{7\text{region}} \\ 
\delta_{8\text{region}}
\end{array}\right] 
&\sim MVN(
\mathbf{0},
\Sigma^\text{r}
),
\left[\begin{array}{c}
\gamma_{0\text{country}} \\ \gamma_{1\text{country}} \\ 
\gamma_{2\text{country}} \\ \gamma_{3\text{country}} \\ 
\gamma_{4\text{country}} \\ \gamma_{5\text{country}} \\ 
\gamma_{6\text{country}} \\ \gamma_{7\text{country}} \\ 
\gamma_{8\text{country}}
\end{array}\right] 
\sim MVN(
\mathbf{0},
\Sigma^\text{c}
)
\end{align*}
$$ {#eq-model2}

Where $\text{Internet}^{\text{t-1}}_i$ is the within-country centered 1-year-lagged internet user proportion, and $\text{Internet}^{\text{between}}_i$ is the between-country-centered internet adoption proportion.

```{r fit-model-2}
#| cache: false
#| results: hide

```

## Other predictors

Here we further fit model 2 using the different internet predictors

```{r fixed-mobile}
#| cache: false
#| results: hide



```
