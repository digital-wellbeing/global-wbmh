# Associations {#sec-associations}

```{r setup}
#| cache: false
# Packages
library(scales)
library(ggtext)
library(lubridate)
library(kableExtra)
library(ggstance)
library(mgcv)
library(brms)
library(cmdstanr)
library(ellipse)
library(ggh4x)
library(tidybayes)
library(ggdist)
library(posterior)
library(parameters)
library(emmeans)
library(broom)
library(tidyverse)
```


```{r load}
#| cache: false
# Load data sets
itu <- read_rds("data/itu.rds")
gwp <- read_rds("data/gwp.rds")
gbd <- read_rds("data/gbd.rds")

# Load models
oo <- c(
  "Life_satisfaction", "Negative_experiences", "Positive_experiences",
  "Anxiety", "Depression", "Selfharm"
)
fits <- tibble(outcome = oo) %>% 
  mutate(outcome = factor(outcome, levels = oo)) %>% 
  mutate(
    fit2 = map(
      outcome, 
      ~read_rds(str_glue("models/brm-{.x}-2-internet.rds"))
    )
  )
```

We then turned to the second research question: To what extent are changes in well-being predicted by internet adoption? To answer, we investigate the results of Model 2.

## Model comparison

First, we compared the R2 values between Models 1 and 2. This comparison is not perfect because the datasets differed slightly (each country had at least 1 fewer values in Model 2 because of the inclusion of the lagged internet predictor in Model 2). However it gives a rough idea of the added explanatory power of internet adoption on the well-being outcomes.

```{r model21-compare}
#| results: hold
#| tbl-cap: "Model 1 and 2 proportions variance explained"
#| label: tbl-m12-r2

# Takes a while so save to file
r2_file_path <- "models/m12r2.rds"
if (!file.exists(r2_file_path)) {
  fits <- fits %>% 
    mutate(
      fit1 = map(
        outcome, 
        ~read_rds(str_glue("models/brm-{.x}-1-internet.rds"))
      )
    )
  
  r2_tab <- fits %>%
    select(outcome, fit1, fit2) %>% 
    pivot_longer(c(fit1, fit2)) %>% 
    mutate(
      r2 = map(
        value,
        ~ bayes_R2(., resp = "val") %>%
          as.data.frame() %>%
          mutate(across(everything(), ~ percent(., .1))) %>%
          transmute(result = str_glue("{Estimate} [{Q2.5}, {Q97.5}]"))
      )
    ) %>%
    select(-value) %>%
    unnest(r2) %>% 
    pivot_wider(
      names_from = name,
      values_from = result,
      names_prefix = "Model "
    ) %>%
    mutate(outcome = str_replace(outcome, "_", " "))
  write_rds(r2_tab, r2_file_path)
  fits <- select(fits, -fit1)
} else {r2_tab <- read_rds(r2_file_path)}

r2_tab %>% 
  kbl(caption = "Model 1 and 2 R-squared values") %>%
  kable_custom()

read_docx() %>% 
  body_add_table(
    r2_tab,
    first_column = TRUE
  ) %>% 
  print("Table-R2.docx")
```

## Forest plot

We then display summaries of the parameters' posterior distributions as forest plots, like above. Recall the scales of the variables: Internet adoption is a proportion (0-1), and outcomes are percentages (0-100).

```{r forest-internet}
#| column: screen-inset-right
#| fig-width: 13
#| fig-height: 8
#| fig-cap: "Forest plot of internet associations"
#| label: fig-forest-internet

# Calculate parameters at all levels of analysis
p_draws <- fits %>%
  mutate(pdraws = map(fit2, ~pdraws(.x, "i1_cw"))) %>%
  select(outcome, pdraws) %>%
  unnest(pdraws)
p_sums <- fits %>%
  mutate(psums = map(fit2, ~psums(.x, "i1_cw"))) %>%
  select(outcome, psums) %>%
  unnest(psums)
p_draws <- p_draws %>%
  mutate(region = fct_relevel(region, "Average")) %>%
  mutate(outcome = str_replace(outcome, "_", " ")) %>%
  mutate(outcome = factor(outcome, levels = str_replace(oo, "_", " ")))
p_sums <- p_sums %>%
  mutate(region = fct_relevel(region, "Average")) %>%
  mutate(outcome = str_replace(outcome, "_", " ")) %>%
  mutate(outcome = factor(outcome, levels = str_replace(oo, "_", " ")))

p_draws %>%
  mutate(is_average = region == "Average") %>%
  ggplot(aes(value, region, fill = is_average)) +
  scale_fill_manual(values = c("dodgerblue1", "dodgerblue4")) +
  scale_alpha_manual(values = c(.4, .8)) +
  geom_vline(xintercept = 0, lty = 2, size = .2) +
  scale_shape_manual(values = c(21, 19)) +
  scale_y_discrete(
    expand = expansion(c(0.01, .1)),
    labels = function(x) {
      if_else(x == "Average", "**Average**", x) %>%
        str_replace("_", " ")
    }
  ) +
  scale_x_continuous(
    "Conditional lagged effect of 10% increase in internet adoption",
    breaks = pretty_breaks(),
    labels = function(x) percent(x / 1000, .001) %>% 
      str_remove("\\.000") %>% 
      # Remove trailing zero (twice)
      str_remove("(?<=[:digit:])0(?=%)") %>% 
      str_remove("(?<=[:digit:])0(?=%)"),
    expand = expansion(c(.15, .15))
  ) +
  stat_halfeye(
    point_interval = NULL, normalize = "panels",
    height = .75, adjust = 1,
    aes(alpha = is_average)
  ) +
  # Add country points
  geom_point(
    data = p_sums %>%
      drop_na(country) %>%
      filter(!(outcome=="Selfharm" & abs(Estimate) > .05)) %>% 
      mutate(is_average = TRUE),
    aes(x = Estimate), size = 1, col = "dodgerblue1",
    position = position_nudge(0, -0.075), alpha = .4
  ) +
  stat_pointinterval(
    alpha = 1, .width = c(.95),
    interval_size = 1,
    point_size = 1.75,
    fill = "white",
    aes(shape = after_stat(xmin > 0 | xmax < 0)),
    position = position_nudge(0, 0)
  ) +
  geom_richtext(
    data = p_sums %>%
      filter(is.na(country)) %>%
      mutate(is_average = region == "Average") %>%
      mutate(
        across(
          where(is.numeric),
          ~ if_else(
            outcome == "Selfharm",
            percent(. / 1000, .0001),
            percent(. / 1000, .01)
          )
        )
      ),
    family = Font, lineheight = 1,
    alpha = 1, size = 3, hjust = 1, vjust = 0.2,
    fill = NA, label.color = NA,
    aes(
      x = Inf,
      label = str_glue("{Estimate}<br>[{Q2.5}, {Q97.5}]")
    )
  ) +
  facet_wrap(
    "outcome",
    nrow = 2, scales = "free_x"
  ) +
  theme(
    axis.title.y = element_blank(),
    axis.text.y = element_markdown(),
    panel.spacing.x = unit(10, "pt"), 
    plot.margin = unit(rep(10, 4), "pt"),
    legend.position = "none"
  )
x <- percent(fixef(fits$fit2[[1]])["i1_cw",-2]/1000)
x2 <- percent(hypothesis(fits$fit2[[3]], "i1_cw > 0")$hypothesis$Post.Prob, .1)

# How many selfharm countries not shown on plot for clarity?
p_sums %>%
  filter(outcome=="Selfharm") %>% 
  drop_na(country) %>% 
  mutate(extreme = abs(Estimate) > .05) %>% 
  janitor::tabyl(extreme)

# Numbers
p_sums %>% 
  filter(region=="Average") %>% 
  mutate(across(where(is.numeric), ~percent(./1000, .0001))) %>% 
  transmute(
    outcome,
    result = str_glue("{Estimate} [{Q2.5}, {Q97.5}]")
  )
```

This figure shows that, on the whole, the predictive associations between internet adoption and well-being were somewhat small. First, on average across regions and countries, a 10% increase in internet adoption was associated with a `r x[1]` increase in life satisfaction, but with 95% confidence this number could range from `r x[2]` to `r x[3]`. However, in the African region, increased internet adoption was associated with increases in life satisfaction at a confidence level exceeding 95%. Somewhat confusingly, internet adoption was positively associated with negative experiences also in the African region. However, none of the average associations were credibly different from zero. The association between internet adoption and positive experiences came closest with a `r x2` posterior probability of a positive association.

## Counterfactual plot

To help illustrate the magnitudes of associations, we draw figures of the fitted lines, or so called counterfactual plots.

```{r model2-fitted-values}
#| column: screen-inset-right
#| fig-width: 13
#| fig-height: 8
#| fig-cap: "Counterfactual plot of internet associations"
#| label: fig-fitted-internet

fitted_country <- function(x) {
  newx <- x$data %>%
    group_by(country) %>%
    mutate(
      xmin = min(i1_cw, na.rm = TRUE),
      xmax = max(i1_cw, na.rm = TRUE)
    ) %>%
    filter(i1_cw %in% c(xmin, xmax)) %>%
    ungroup() %>%
    distinct(country, region, i1_cw, i1_cb) %>%
    mutate(year = 0, sex = NA, age = NA, se = 0)
  newy <- bind_cols(
    newx, 
    as.data.frame(fitted(x, newdata = newx))
  )
  newy
}

fitted_region <- function(x) {
  newx <- x$data %>%
    group_by(region) %>%
    summarise(i1_cb = mean(i1_cb, na.rm = TRUE)) %>%
    crossing(i1_cw = seq(-.4, .4, length = 10)) %>%
    mutate(year = 0, sex = NA, age = NA, se = 0)

  newy <- bind_cols(
    newx,
    as.data.frame(
      fitted(
        x, 
        newdata = newx, 
        re_formula = ~ 
          (year * sex * age + i1_cw * sex * age | region)
        )
    )
  )
  newy
}

f_country <- fits %>%
  mutate(fc = map(fit2, fitted_country)) %>%
  select(outcome, fc) %>%
  unnest(fc)

f_region <- fits %>%
  mutate(fr = map(fit2, fitted_region)) %>%
  select(outcome, fr) %>%
  unnest(fr)

f_country %>%
  ggplot(aes(i1_cw, Estimate)) +
  scale_x_continuous(
    "Previous year's internet adoption relative to country average in 2000-2020",
    breaks = c(-.35, 0, .35),
    labels = function(x) percent(x, 1)
  ) +
  scale_y_continuous(
    "Estimate",
    breaks = pretty_breaks(),
    labels = function(x) percent(x / 100, .01) %>% str_remove("\\.00")
  ) +
  geom_blank() +
  geom_ribbon(
    data = f_region,
    aes(ymin = Q2.5, ymax = Q97.5),
    alpha = .15, fill = "dodgerblue4"
  ) +
  geom_line(
    data = f_region,
    col = "dodgerblue4", size = .6
  ) +
  geom_line(
    aes(group = country),
    size = .4, alpha = .35, col = "dodgerblue1"
  ) +
  facet_grid(
    outcome ~ region,
    scales = "free_y",
    labeller = as_labeller(function(x) str_replace(x, "_", "\n"))
  ) +
  theme(
    panel.spacing = unit(2, "pt"),
    aspect.ratio = 1,
    axis.title.y = element_blank()
  )
```

## Between-country associations

We then focused on the between-country association between internet adoption and well-being. Recall that the model does not adjust for between-country differences so these associations are likely to reflect many other factors covarying with internet adoption (e.g. wealth and development factors).

```{r}
#| column: page-right
#| fig.width: 8
#| fig.height: 6
#| fig-cap: "Between-country associations"
#| label: fig-cb1

fitted_cb1 <- function(x) {
  newx <- x$data %>%
    group_by(region, country) %>%
    summarise(i1_cb = unique(i1_cb), val = mean(val, na.rm = TRUE)) %>% 
    mutate(i1_cw = 0, year = 0, sex = NA, age = NA, se = 0) %>% 
    ungroup()

  newy <- bind_cols(
    newx,
    as.data.frame(
      fitted(
        x, 
        newdata = newx, 
        re_formula = NA
        )
    )
  )
  newy
}
tmp <- fits %>% 
  mutate(out = map(fit2, fitted_cb1)) %>% 
  select(outcome, out) %>%
  unnest(out)

cb1_pars <- fits %>%
  mutate(
    out = map(
      fit2,
      ~ as_draws_df(
        .x,
        variable = "b_i1_cb"
      ) %>%
        summarise_draws(mean, sd, ~ quantile2(., probs = c(.025, .975)))
    )
  ) %>%
  select(outcome, out) %>%
  unnest(out) %>%
  mutate(across(where(is.numeric), ~ number(., .01)))

tmp %>% 
  ggplot(aes(i1_cb, val)) +
  scale_x_continuous(
    "Between-country centered internet adoption",
    labels = ~percent(.)
  ) +
  scale_y_continuous(
    "Value",
    labels = ~percent(./100)
  ) +
  geom_point(
    shape = 1, size = 1, alpha = .75, col = "dodgerblue1"
  ) +
  geom_ribbon(
    aes(ymin = Q2.5, ymax = Q97.5),
    alpha = .2, fill = "dodgerblue1"
    ) +
  geom_line(aes(y = Estimate), col = "dodgerblue4") +
  geom_text(
    data = cb1_pars,
    aes(x = -Inf, y = Inf, label = str_glue("{mean} [{q2.5}, {q97.5}]")),
    vjust = 1.3, hjust = -0.025, family = Font
  ) +
  facet_wrap(
    "outcome",
    scales = "free_y", nrow = 2,
    labeller = as_labeller(~str_replace(., "_", " "))
  ) +
  theme(
    aspect.ratio = 1,
    axis.title.y = element_blank()
  )
```
