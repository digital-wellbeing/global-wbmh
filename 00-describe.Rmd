# Describe

```{r setup, include = FALSE}
#| cache: false
# Packages
library(scales)
library(ggtext)
library(lubridate)
library(kableExtra)
library(ggstance)
library(ggh4x)
library(gtsummary)
library(mgcv)
library(plotly)
library(tidyverse)

# Common options
source("_common.R")

# Load data sets
itu <- read_rds("data/itu.rds")
gwp <- read_rds("data/gwp.rds")
gbd <- read_rds("data/gbd.rds")
d <- read_rds("data/data-all.rds")

oo <- c(
  "Life_satisfaction", "Negative_experiences", "Positive_experiences",
  "Anxiety", "Depression", "Selfharm"
)
```

Here are some descriptives of the datasets.

## Sample summaries

Number of countries/years/people per outcome

```{r}
bind_rows(
  "GWP" = gwp,
  "GBD" = gbd,
  .id = "Dataset"
) %>% 
  mutate(Dataset = fct_inorder(Dataset)) %>% 
  group_by(Dataset, region, outcome, country) %>% 
  summarise(
    n_n = sum(n),
    n_year = length(unique(year))
  ) %>% 
  summarise(
    N = sum(n_n), 
    Years = mean(n_year)
  ) %>%
  summarise(
    N_sum = round(mean(N)), 
    Years_mean = round(mean(Years))
  ) %>%
  kbl(caption = "Number of respondents and years by outcome and region") %>% 
  kable_custom()
tmp <- gwp %>% 
  group_by(outcome) %>% 
  summarise(n=sum(n)) %>% 
  summarise(N=comma(median(n))) %>% 
  pull(N)
```

The median number of respondents per Gallup well-being outcome was `r tmp`, and the unique age bins in the GWP data were `r unique(gwp$age)`. 

We then examined the total number of observations (cell means and SEs) per outcome

```{r}
bind_rows(
  "GWP" = gwp,
  "GBD" = gbd,
  .id = "Dataset"
) %>% 
  mutate(Dataset = fct_inorder(Dataset)) %>% 
  count(Dataset, outcome) %>% 
  bind_rows(
    itu %>% 
      select(internet, mobile) %>% 
      pivot_longer(everything(), names_to = "outcome") %>% 
      drop_na(value) %>% 
      count(outcome) %>% 
      mutate(Dataset = "ITU")
  ) %>% 
  kbl(caption = "Observations per outcome") %>% 
  kable_custom()
```

And noted that the number of Gallup respondents decreases with age:

```{r}
gwp %>% 
  # filter(age %in% c("15 to 19", "50 to 54", "85 to 89")) %>% 
  group_by(age) %>% 
  summarise(
    n = quantile(n, probs = c(.1, .5, .9)),
    quantile = c("10%", "50%", "90%")
  ) %>% 
  pivot_wider(names_from = quantile, values_from = n) %>% 
  kbl(caption = "Quantiles of numbers of observations per age group") %>% 
  kable_custom()
```

## ITU summary table

Here is a table summarising the ITU internet predictor over time to region average percentage and number of coutries.

```{r itu-summary-table}
#| column: page-right
#| tbl-cap: "Mean internet user percentages across regions and time."
#| label: tbl-itusummary

itu %>%
  select(region, country, year, internet) %>%
  mutate(internet = internet * 100) %>%
  pivot_wider(names_from = year, values_from = internet) %>%
  select(-country) %>%
  tbl_summary(
    by = region,
    missing = "no",
    statistic = list(all_continuous() ~ "{mean}% ({N_nonmiss})")
  ) %>%
  add_overall(col_label = "Total") %>%
  as_kable_extra(caption = "ITU summary") %>%
  row_spec(0, bold = TRUE) %>%
  kable_custom()
```

## Data figure

:::{.panel-tabset .column-body-outset-right}

### Static

```{r trends-regions, message = FALSE}
#| fig-width: 10
#| fig-height: 8
#| fig-cap: "Trends in all variables across regions"
#| label: fig-trends-regions

# Stack data sets
# Assume all outcomes are proportions (0-1)
# Draw small multiples figure, outcomes x regions
d <- bind_rows(
  read_rds("data/gwp.rds"),
  read_rds("data/gbd.rds")
)

itu <- read_rds("data/itu.rds") %>%
  select(
    region, country, year,
    Internet = internet,
    Mobile = mobile,
  ) %>%
  # Truncate mobile percentages for figure
  mutate(Mobile = if_else(Mobile > 1.5, NaN, Mobile)) %>%
  pivot_longer(
    c(Internet, Mobile),
    names_to = "outcome", values_to = "val"
  )

tmp_country <- bind_rows(itu, d) %>%
  mutate(outcome = fct_inorder(str_replace(outcome, "_", "_"))) %>%
  group_by(region, country, year, outcome) %>%
  summarise(mean = mean(val, na.rm = TRUE)) %>%
  ungroup() %>% 
  mutate(outcome = factor(outcome, levels = c("Internet", "Mobile", oo)))

tmp_region <- tmp_country %>%
  group_by(region, outcome) %>%
  group_modify(~broom::augment(gam(mean ~ s(year, bs = "cs", k = 5), data = .))) %>%
  ungroup() %>% 
  mutate(outcome = factor(outcome, levels = c("Internet", "Mobile", oo)))

tmp_world <- tmp_country %>%
  group_by(outcome) %>%
  group_modify(~broom::augment(gam(mean ~ s(year, bs = "cs", k = 5), data = .))) %>%
  ungroup() %>%
  mutate(region = "World") %>% 
  mutate(outcome = factor(outcome, levels = c("Internet", "Mobile", oo)))

p1 <- tmp_country %>%
  mutate(year = make_date(year)) %>%
  ggplot(aes(year, mean)) +
  scale_y_continuous(
    "Value (%)",
    # Display percentages
    labels = ~. * 100,
    breaks = pretty_breaks(),
    expand = expansion(.05)
  ) +
  scale_x_date(
    "Year",
    breaks = make_date(c(2005, 2010, 2015, 2020)),
    date_labels = "'%y",
    expand = expansion(.02)
  ) +
  geom_line(
    aes(
      group = interaction(country, outcome), 
      text = str_glue("{country} {year(year)} ({percent(mean)})")
    ),
    alpha = .45, size = .3, color = "dodgerblue1"
  ) +
  # geom_line(
  #   data = tmp_region %>% mutate(year = make_date(year)),
  #   aes(
  #     y = .fitted, 
  #     group = interaction(region, outcome),
  #     text = str_glue("{region} {year(year)} ({percent(.fitted)})")
  #   ),
  #   alpha = 1, size = .6, color = "dodgerblue4"
  # ) +
  # geom_line(
  #   data = tmp_world %>% mutate(year = make_date(year)),
  #   aes(
  #     y = .fitted, 
  #     group = interaction(region, outcome),
  #     text = str_glue("{region} {year(year)} ({percent(.fitted)})")
  #   ),
  #   alpha = 1, size = .8, color = "dodgerblue4"
  # ) +
  facet_grid(
    outcome ~ region,
    scales = "free_y",
    labeller = as_labeller(function(x) str_replace(x, "_", "\n"))
  ) +
  theme(
    # aspect.ratio = 1,
    legend.position = "none",
    panel.spacing.x = unit(4, "pt"),
    panel.spacing.y = unit(6, "pt")
  )
p1
```

```{r include = FALSE}
agg_png(
  "figures/Trends-data.png",
  width = W, height = W*0.85, units = "in", res = 300
)
p1
dev.off()
```

### Interactive

```{r out.height = 860}
#| fig-cap: "Trends in all variables across regions. Hover over years to show the country's name."
#| label: fig-trends-regions-i
gp <- ggplotly(p1, tooltip = "text")
gp %>% 
  layout(
    margin = list(t = 30, r = 20, b = 40, l = 30),
    width = 840, height = 840
    )
```

### HDI

```{r fig.height = 1.8}
read_rds("data/itu.rds") %>% 
  mutate(year = make_date(year)) %>%
  ggplot(aes(year, hdi)) +
  scale_y_continuous(
    "Value",
    labels = ~percent(., .1),
    breaks = pretty_breaks(),
    expand = expansion(.05)
  ) +
  scale_x_date(
    "Year",
    breaks = make_date(c(2005, 2010, 2015, 2020)),
    date_labels = "'%y",
    expand = expansion(.02)
  ) +
  geom_line(
    aes(
      group = country, 
      text = str_glue("{country} {year(year)} ({hdi})")
    ),
    alpha = .45, size = .3, color = "dodgerblue1"
  ) +
  facet_wrap(
    ~ region,
    scales = "free_y",
    nrow = 1,
    labeller = as_labeller(function(x) str_replace(x, "_", "\n"))
  ) +
  theme(
    # aspect.ratio = 1,
    legend.position = "none",
    panel.spacing.x = unit(4, "pt"),
    panel.spacing.y = unit(6, "pt"),
    axis.title.y = element_blank()
  )
```

:::
