# Time trends

```{r packages}
#| results: 'hide'
# Packages
library(ggtext)
library(brms)
library(cmdstanr)
library(ellipse)
library(broom.mixed)
library(scales)
library(ggh4x)
library(tidybayes)
library(ggdist)
library(posterior)
library(parameters)
library(lme4)
library(emmeans)
library(patchwork)
library(bayestestR)
library(lubridate)
library(broom)
library(kableExtra)
library(ggstance)
library(multidplyr)
library(tidyverse)

# MCMC settings
options(brms.backend = "cmdstanr")
hmc <- list(
  chains = 6,
  cores = 6,
  threads = 2,
  iter = 300, 
  warmup = 200,
  refresh = 10,
  adapt_delta = .9, 
  max_treedepth = 10
)

# Parallelisation options: I have hard coded 12 cores here
# n_cores <- 12
# n_workers <- floor(n_cores / 4) # 4 chains always
# cluster <- new_cluster(n_workers)
# cluster_library(cluster, c("stringr", "dplyr"))

# Run this to delete fitted models and refit
# unlink(list.files(pattern = "output/brm-.*\\.rds"))
```

```{r}
itu <- read_rds("data/itu.rds")
gbd <- read_rds("data/gbd.rds") # 10 to 24 year olds
```

## Prepare data for models

Preparing the variables:

- Transform edge values of internet variable to fit beta
- center year on 2010 (roughly in the middle)
  - Intercept and simple effects at 2010
  - 1 unit: year
- create 1-year lagged internet adoption variables
  - Intercepts are country/grand means
  - 1 unit: 100%
- Contrast code factors

```{r data-prepare}
# Predictors

# Transform edge proportions to fit beta distribution
itu <- itu %>% 
  mutate(internet = if_else(internet == 0, .0000001, internet)) %>% 
  mutate(internet = if_else(internet == 1, .9999999, internet))

# Create lagged predictors
itu <- itu %>% 
  arrange(country, year) %>% 
  group_by(country) %>% 
  mutate(
    across(
      c(internet, fixed, mobile), 
      list(`1` = ~lag(., 1)), 
      .names = "{str_sub(.col, 1, 1)}{.fn}"
    )
  )

# Centering within and between countries
itu <- itu %>%
  group_by(country) %>% 
  mutate(
    i1_cb = mean(i1, na.rm = TRUE), # Country average
    i1_cw = i1 - i1_cb # Year-specific deviation from country average
  ) %>% 
  ungroup() %>% 
  # Grand-mean center the country averages
  mutate(i1_cb = i1_cb - mean(i1, na.rm = TRUE))

# Outcomes

# Merge predictors to outcomes
dat <- left_join(gbd, itu)

# Center and scale year, and contrast code factors
dat <- dat %>% 
  mutate(year = (year - 2010) / 10)
dat$sex <- factor(dat$sex)
contrasts(dat$sex) <- "contr.sum"
dat$age <- factor(dat$age)
contrasts(dat$age) <- "contr.sum"

# For brms multivariate data subsetting: variable to indicate unique ITU values
dat <- dat %>% 
  group_by(country, year) %>% 
  mutate(itu = 1:n() == 1) %>% 
  ungroup()
```

All the outcome variables are proportions (0-1) at this point. This creates problems with the HMC because the self-harm rates are so low. HMC works better with variables roughly on the unit scale. 

```{r}
# Save this so its easy to use later to back-transform
dat %>%
  group_by(cause) %>%
  summarise(median = median(val), min = min(val), max = max(val))

# Important: do this for both val AND se
# Multiply by 1000
dat <- dat %>% 
  group_by(cause) %>% 
  mutate(across(val:se, ~.x*1000)) %>% 
  ungroup()

dat %>%
  group_by(cause) %>%
  summarise(median = median(val), min = min(val), max = max(val))

# # It is then easy to back-transform
# dat %>% 
#   left_join(dat_scales) %>% 
#   group_by(cause) %>% 
#   mutate(
#     val = rescale(val, to = c(unique(min), unique(max))),
#     se = rescale(val, to = c(unique(min), unique(max)))
#   ) %>% 
#   summarise(median = median(val), min = min(val), max = max(val))
```

## Model 1

The first model addresses our first research question: To what extent did the outcomes change over time. It will also answer whether changes were different across the demographic groups.

It will also begin to address the issue of associations between internet adoption and well-being, by including a correlation between the country-specific trends in internet adoption and outcomes.

We fit three incrementally more complex versions of this model. First, without demographic covariates, second with, and third with the two-way interactions with time.

We fit the model separately for each outcome.

### Model 1a

Model 1a is a multivariate multilevel model of internet adoption and outcome (e.g. Anxiety) over time. The intercepts and coefficients of time are allowed to vary across regions and countries, with a shared correlation matrix of the random effects across the two outcomes.

Internet adoption is treated as Beta-distributed. Outcome rates, the GBD estimates, are treated as Gaussian with a known standard error, resulting in a "meta-regression" model of the outcomes.

$$
\begin{align*}
y_{i[c][r]} &\sim \text{Normal}(\mu^y_{i[c][r]}, \sigma^{2y}v_i) \\

\mu^y_{i[c][r]} &= \beta^{y}_{0} + \gamma^{y}_{0[c]} + \delta^{y}_{0[r]} +
\beta^y_{1}\text{t}_i + \gamma^{y}_{1[c]}\text{t}_i + \delta^{y}_{1[r]}\text{t}_i  \\

x_{i[c][r]} &\sim 
\text{Beta}(\mu^x_{i[c][r]}, \phi^x) \\

\mu^x_{i[c][r]} &= \text{logit}(
\beta^{x}_{0} + \gamma^{x}_{0[c]} + \delta^{x}_{0[r]} +
\beta^x_{1}\text{t}_i + \gamma^{x}_{1[c]}\text{t}_i + \delta^{x}_{1[r]}\text{t}_i) \\

\left[\begin{array}{c}
\gamma^y_{0[c]} \\ \gamma^y_{1[c]} \\ \gamma^x_{0[c]} \\ \gamma^x_{1[c]}
\end{array}\right] 
&\sim MVN(
\left[\begin{array}{c}
0 \\ 0 \\ 0 \\ 0
\end{array}\right],
\Sigma^c
),

\left[\begin{array}{c}
\delta^y_{0[r]} \\ \delta^y_{1[r]} \\ \delta^x_{0[r]} \\ \delta^x_{1[r]}
\end{array}\right] 
\sim MVN(
\left[\begin{array}{c}
0 \\ 0 \\ 0 \\ 0
\end{array}\right],
\Sigma^r
)
\end{align*}
$$

We then define the model formulas in brms' formula syntax. First, for internet adoption, we take care to indicate that each internet adoption datum should be modelled only once, because the values are repeated in the outcome data table. To do this we use `resp_subset(itu)`, which includes only unique rows of ITU data in the model. The `|c|` and `|r|` separating the random effects from their grouping factors indicate a shared correlation matrix, also indicated in the next model formula.

```{r}
# Define a model of internet proportion over year
bf_itu <- bf(
  internet | resp_subset(itu) ~ 
    year + 
    (year |c| country) +
    (year |r| region), 
  family = Beta()
)
```

Here, we specify the outcome model. Note the `|c|` and `|r|` that link the countries' and regions', respectively, random effects of this model with the previous' model. Then, we specify `resp_se(se, sigma = TRUE)` to enable "meta-regression" with known standard errors. In addition, it leads to the residual variance to be estimated.

```{r}
# Define models of outcomes
bf_1a <- bf(
  val | resp_se(se, sigma = TRUE) ~ 
    year + 
    (year |c| country) +
    (year |r| region),
  family = gaussian()
)
```

We then compile the model once, such that it can be updated with subsets of the data (the different outcomes) without having to compile again. 

```{r}
fit_1a <- brm(
  bf_itu + bf_1a + set_rescor(FALSE),
  data = filter(dat, cause == "Anxiety"),
  chains = 0,
  threads = hmc$threads,
  file = "output/brm-1a"
)
```

Then fit the model. Note we don't need this for now because the relevant estimates are provided by model 1c.

```{r eval = FALSE}
fits_1a <- dat %>% 
  group_by(cause) %>% 
  summarise(
    fit = list(
      update(
        fit_1a, 
        newdata = cur_data_all(),
        chains = hmc$chains, cores = hmc$cores, threads = hmc$threads,
        iter = hmc$iter, warmup = hmc$warmup,
        control = list(adapt_delta = hmc$d, max_treedepth = hmc$m),
        file = str_glue("output/brm-1a-{cur_group()}")
      )
    )
  )
```

### Model 1b

Model 1b is as 1a but we include age (10 to 14, 15 to 19, 20 to 24) and sex as covariates.

```{r}
bf_1b <- bf(
  val | resp_se(se, sigma = TRUE) ~ 
    year + sex + age + 
    (year + sex + age |c| country) +
    (year + sex + age |r| region),
  family = gaussian()
)
```

Then fit the model as above, first compiling and then updating for each outcome. Note not fitted for now--relevant estimates are in model 1c.

```{r}
fit_1b <- brm(
  bf_itu + bf_1b + set_rescor(FALSE),
  data = filter(dat, cause == "Anxiety"),
  chains = 0,
  threads = hmc$threads,
  file = "output/brm-1b"
)

fits_1b <- dat %>% 
  group_by(cause) %>% 
  summarise(
    fit = list(
      update(
        fit_1b, 
        newdata = cur_data_all(),
        chains = hmc$chains, cores = hmc$cores, threads = hmc$threads,
        iter = hmc$iter, warmup = hmc$warmup,
        control = list(adapt_delta = hmc$d, max_treedepth = hmc$m),
        file = str_glue("output/brm-1b-{cur_group()}")
      )
    )
  )
```

### Model 1c

Model 1c further expands 1b to include the two-way interactive terms between age and year, and sex and year. Thus we get age and sex-specific trajectories over time. We reuse the prior distributions from 1b.

This takes about 3.5 hours per 1000 iterations (per model).

```{r}
bf_1c <- bf(
  val | resp_se(se, sigma = TRUE) ~ 
    year * sex + year * age + 
    (year * sex + year * age |c| country) +
    (year * sex + year * age |r| region),
  family = gaussian()
)

fit_1c <- brm(
  bf_itu + bf_1c + set_rescor(FALSE),
  data = filter(dat, cause == "Anxiety"),
  chains = 0,
  threads = hmc$threads,
  file = "output/brm-1c"
)

fits_1c <- dat %>% 
  group_by(cause) %>% 
  summarise(
    fit = list(
      update(
        fit_1c, 
        newdata = cur_data_all(),
        chains = hmc$chains, cores = hmc$cores, threads = hmc$threads,
        iter = hmc$iter, warmup = hmc$warmup, refresh = hmc$refresh,
        control = list(
          adapt_delta = hmc$adapt_delta, 
          max_treedepth = hmc$max_treedepth
        ),
        file = str_glue("output/brm-1c-{cur_group()}")
      )
    )
  )

```

### Checking

Diagnostics: convergence and effective samples size

```{r}
f1d <- fits_1c %>% 
  mutate(
    out = 
      map(
        fit, 
        ~as_draws_df(., variable = "^b_|^sd_|^cor_", regex = TRUE) %>% 
          summarise_draws(samples = length, default_convergence_measures())
        )
    ) %>% 
  select(-fit) %>% 
  unnest(out)
f1d %>%  
  kbl(
    caption = "HMC Diagnostics, Model 1c",
    digits = c(0,0,0,2,0,0)
  ) %>% 
  kable_paper(html_font = Font) %>% 
  column_spec(
    4, 
    color = "white",
    background = spec_color(
      f1d$rhat, 
      direction = 1, 
      option = "C", 
      end = .7
    )
  )
```

### Summary

We then display the model's population-level parameters

```{r}
fits_1 <- reduce(
  list(
    fits_1a %>% rename(fit_1a = fit), 
    fits_1b %>% rename(fit_1b = fit),
    fits_1c %>% rename(fit_1c = fit)
  ), 
  left_join
) %>% 
  pivot_longer(fit_1a:fit_1c, names_to = "model", values_to = "fit")
fits_1 %>% 
  mutate(
    out = map(
      fit, 
      ~as_draws_df(.x, variable = "^b_", regex = TRUE) %>% 
        summarise_draws(
          mean, quantile, rhat, 
          .args = list(probs = c(.025, .975))
        )
    )
  ) %>% 
  select(-fit) %>% 
  unnest(out) %>% 
  mutate(across(where(is.numeric), ~round(., 2))) %>% 
  mutate(
    result = str_glue(
      "{mean} ({`2.5%`}, {`97.5%`}) [rh = {round(rhat, 1)}]"
    )
  ) %>% 
  select(-c(mean, `2.5%`, `97.5%`, rhat)) %>% 
  pivot_wider(names_from = model, values_from = result) %>% 
  kbl() %>% 
  kable_paper(html_font = Font)
```

## Model 2

Model 2 is a modification of Model 1. First, we now switch to looking at internet use more specifically as a predictor, and therefore implement a univariate model of each outcome. Second, we include within- and between-country centred 1-year-lagged internet adoption values as predictors in the model. 

We fit this model in two increasingly complex forms, corresponding to models 1b and 1c, but with the addition of the internet adoption predictors, and one outcome model only.

2c takes about 5 hours per 1000 iterations.

```{r}
bf_2b <- bf(
  val | resp_se(se, sigma = TRUE) ~ 
    year + sex + age + i1_cw + i1_cb +
    (year + sex + age + i1_cw | country) +
    (year + sex + age + i1_cw | region),
  family = gaussian()
)
fit_2b <- brm(
  bf_2b,
  data = filter(dat, cause == "Anxiety"),
  chains = 0,
  threads = hmc$threads,
  file = "output/brm-2b"
)
fits_2b <- dat %>% 
  group_by(cause) %>% 
  summarise(
    fit = list(
      update(
        fit_2b, 
        newdata = cur_data_all(),
        chains = hmc$chains, cores = hmc$cores, threads = hmc$threads,
        iter = hmc$iter, warmup = hmc$warmup, refresh = hmc$refresh,
        control = list(
          adapt_delta = hmc$adapt_delta, 
          max_treedepth = hmc$max_treedepth
        ),
        file = str_glue("output/brm-2b-{cur_group()}")
      )
    )
  )

bf_2c <- bf(
  val | se(se, sigma = TRUE) ~ 
    year * sex + year * age + i1_cw * sex + i1_cw * age + i1_cb + 
    (year * sex + year * age + i1_cw * sex + i1_cw * age | country) +
    (year * sex + year * age + i1_cw * sex + i1_cw * age | region),
  family = gaussian()
)

fit_2c <- brm(
  bf_2c,
  data = filter(dat, cause == "Anxiety"),
  chains = 0,
  threads = hmc$threads,
  file = "output/brm-2c"
)

fits_2c <- dat %>% 
  group_by(cause) %>% 
  summarise(
    fit = list(
      update(
        fit_2c, 
        newdata = cur_data_all(),
        chains = hmc$chains, cores = hmc$cores, threads = hmc$threads,
        iter = hmc$iter, warmup = hmc$warmup,
        control = list(adapt_delta = hmc$d, max_treedepth = hmc$m),
        file = str_glue("output/brm-2c-{cur_group()}")
      )
    )
  )
```

### Checking

Diagnostics: convergence and effective samples size

```{r}
f2d <- fits_2c %>% 
  mutate(
    out = 
      map(
        fit, 
        ~as_draws_df(., variable = "^b_|^sd_|^cor_", regex = TRUE) %>% 
          summarise_draws(samples = length, default_convergence_measures())
        )
    ) %>% 
  select(-fit) %>% 
  unnest(out)
f2d %>%  
  kbl(
    caption = "HMC Diagnostics, Model 2c",
    digits = c(0,0,0,2,0,0)
  ) %>% 
  kable_paper(html_font = Font, full_width = FALSE) %>% 
  column_spec(
    4, 
    color = "white",
    background = spec_color(
      f2d$rhat, 
      direction = 1, 
      option = "C", 
      end = .7
    )
  ) %>% 
  scroll_box(height = "600px", width = "800px")
```

### Summary

We then display the model's population-level parameters

```{r}
fits_2 <- reduce(
  list(
    fits_2b %>% rename(fit_2b = fit), 
    fits_2c %>% rename(fit_2c = fit)
  ), 
  left_join
) %>% 
  pivot_longer(fit_2b:fit_2c, names_to = "model", values_to = "fit")
fits_2 %>% 
  mutate(
    out = map(
      fit, 
      ~as_draws_df(.x, variable = "^b_", regex = TRUE) %>% 
        summarise_draws(
          mean, quantile, rhat, 
          .args = list(probs = c(.025, .975))
        )
    )
  ) %>% 
  select(-fit) %>% 
  unnest(out) %>% 
  mutate(across(where(is.numeric), ~round(., 2))) %>% 
  mutate(
    result = str_glue(
      "b = {mean} ({`2.5%`}, {`97.5%`}) [rhat = {round(rhat, 2)}]"
    )
  ) %>% 
  select(-c(mean, `2.5%`, `97.5%`, rhat)) %>% 
  pivot_wider(names_from = model, values_from = result) %>% 
  kbl() %>% 
  kable_paper(html_font = Font)
```





## OLD

### brms

correlating temporal trends in outcomes and internet use using multilevel model with shared correlation matrix

note we use beta so transform edge values

we start with non interactive model--demographics are covariates. later to be expanded to interaction but slow

##### Time: Main effects

We first fit a multivariate model of time effects on internet penetration and each of the well-being outcomes.

```{r}
# Define a model of internet proportion over time
bf_int <- bf(
  internet ~ 1 + time + 
    (1 + time |c| country) +
    (1 + time |r| region), 
  family = Beta()
)

# Define models of outcomes
bf_anx <- bf(
  Anxiety ~ 1 + time + sex + age + 
    (1 + time + sex + age |c| country) +
    (1 + time + sex + age |r| region),
  family = gaussian()
)
bf_dep <- bf(
  Depression ~ 1 + time + sex + age + 
    (1 + time + sex + age |c| country) +
    (1 + time + sex + age |r| region),
  family = gaussian()
)
bf_sel <- bf(
  Selfharm ~ 1 + time + sex + age + 
    (1 + time + sex + age |c| country) +
    (1 + time + sex + age |r| region),
  family = gaussian()
)

# Fit models
fit_anx <- brm(
  bf_int + bf_anx + set_rescor(FALSE),
  data = dat_10,
  file = "output/brm-gbd-time-anxiety",
  chains = 4,
  cores = 4,
  iter = hmc$iter, warmup = hmc$warmup, 
  control = list(adapt_delta = hmc$d)
)
fit_dep <- brm(
  bf_int + bf_dep + set_rescor(FALSE),
  data = dat_10,
  file = "output/brm-gbd-time-depression",
  chains = 4,
  cores = 4,
  iter = hmc$iter, warmup = hmc$warmup, 
  control = list(adapt_delta = hmc$d)
)
fit_sel <- brm(
  bf_int + bf_sel + set_rescor(FALSE),
  data = dat_10,
  file = "output/brm-gbd-time-selfharm",
  chains = 4,
  cores = 4,
  iter = hmc$iter, warmup = hmc$warmup, 
  control = list(adapt_delta = hmc$d)
)
fits_brm_time_main <- tibble(
  outcome = c("Anxiety", "Depression", "Selfharm"),
  fit = list(fit_anx, fit_dep, fit_sel)
)
```

Coefficients

```{r}
fits_brm_time_main %>% 
  mutate(
    out = map(
      fit, 
      ~as_draws(.x, variable = "b_", regex = TRUE) %>% 
        summarise_draws(quantile, rhat, .args = list(probs = c(.5, .05, .95)))
    )
  ) %>% 
  select(-fit) %>% 
  unnest(out) %>% 
  # filter(str_detect(Parameter, "_time$")) %>% 
  kbl(digits = 3) %>% 
  kable_minimal(full_width = FALSE)
```

Revisit figure of temporal trends with coefficients. Note we back-transform the estimated numbers to rates in 100,000

```{r}
tmp_pars <- fits_brm_time_main %>% 
  mutate(
    out = map2(
      fit, 
      outcome,
      ~hypothesis(
        .x, 
        c(str_glue("{.y}_time = 0")),
        scope = "coef",
        group = "region"
      )$hypothesis
    )
  ) %>% 
  select(-fit) %>% 
  unnest(out) %>% 
  # Internet trend is estimated in all models--keep first
  distinct(Group, Hypothesis, .keep_all = TRUE) %>% 
  # Transform back to rates in 100k
  mutate(across(where(is.numeric), ~round(.*1000, 0))) %>% 
  mutate(result = str_glue('**{Estimate}** [{CI.Lower}, {CI.Upper}]')) %>% 
  select(cause = Hypothesis, region = Group, result) %>% 
  mutate(cause = str_sub(cause, 2, -6) %>% str_remove("_time"))

p_vars +
  geom_richtext(
    data = tmp_pars %>% mutate(cause = fct_inorder(str_to_title(cause))),
    aes(x = make_date(2000), y = Inf, label = result),
    size = 2.2, vjust = .9, hjust = 0.1, color = "dodgerblue4",
    family = Font,
    fill = NA, label.color = NA
  )
ggsave(
  "output/Fig-vars-timeseries-estimates.png", 
  device = agg_png,
  height = 2400, width = 3600, res = 300, units = "px"
)
```

A figure of coefficients

```{r}
anx_draws <- spread_draws(
  fit_anx, 
  b_Anxiety_time, r_region__Anxiety[region, term] | region
) %>% 
  filter(term == "time") %>% 
  ungroup() %>% 
  select(-term) %>% 
  rename(Average = b_Anxiety_time) %>% 
  mutate(outcome = "Anxiety")
dep_draws <- spread_draws(
  fit_dep, 
  b_Depression_time, r_region__Depression[region, term] | region
) %>% 
  filter(term == "time") %>% 
  ungroup() %>% 
  select(-term) %>% 
  rename(Average = b_Depression_time) %>% 
  mutate(outcome = "Depression")
sel_draws <- spread_draws(
  fit_sel, 
  b_Selfharm_time, r_region__Selfharm[region, term] | region
) %>% 
  filter(term == "time") %>% 
  ungroup() %>% 
  select(-term) %>% 
  rename(Average = b_Selfharm_time) %>% 
  mutate(outcome = "Selfharm")

p_time_main_coefs <- bind_rows(anx_draws, dep_draws, sel_draws) %>% 
  mutate(across(Africa:Southern.Asia, ~.+Average)) %>% 
  pivot_longer(Average:Southern.Asia, names_to = "region") %>% 
  mutate(region = fct_relevel(factor(region), "Average")) %>% 
  mutate(outcome = factor(outcome)) %>% 
  mutate(is_average = region == "Average") %>% 
  mutate(region = str_replace(region, "\\.", " ")) %>% 
  mutate(region = if_else(region=="Average", "**Average**", region)) %>% 
  ggplot(aes(value, region, fill = is_average, alpha = is_average)) +
  scale_fill_manual(values = c("dodgerblue1", "dodgerblue4")) +
  scale_alpha_manual(values = c(.5, .9)) +
  geom_vline(xintercept = 0, lty = 2, size = .2) +
  scale_x_continuous("Linear trend", breaks = pretty_breaks()) +
  stat_halfeye(
    point_interval = NULL, normalize = "panels"
  ) +
  facet_wrap("outcome", nrow = 1, scales = "free_x") +
  theme(
    axis.title.y = element_blank(),
    axis.text.y = element_markdown(),
    legend.position = "none"
  )
p_time_main_coefs
```


###### Correlations

Calculate country coefficients and show scatterplots

```{r time-correlation-anxiety}
# Function to wrangle draws at multiple levels and create scatterplots + ellipses
draw_scatterplot <- function(fit, beta, r_region, r_country, sd_country, cor_country) {
  # Get average and region-specific slopes
  r_region_draws <- fit %>% 
    spread_draws(
      {{beta}}, 
      b_internet_time,
      {{r_region}}[region, term],
      r_region__internet[region, term]
    ) %>% 
    filter(term == "time") %>% 
    ungroup() %>% 
    # Fix names by replacing dot with line break
    mutate(region = str_replace(region, "\\.", "\n"))
  
  # Then country
  r_country_draws <- fit %>% 
    spread_draws(
      {{r_country}}[country, term],
      r_country__internet[country, term]
    ) %>% 
    filter(term == "time") %>% 
    ungroup() %>% 
    # Fix names by taking labels from original names
    mutate(
      country = factor(
        country, 
        labels = sort(unique(fit$data$country))
      )
    ) %>% 
    left_join(distinct(dat, region, country))
  
  # Calculate country coefficients
  country_coefs <- left_join(r_country_draws, r_region_draws) %>% 
    mutate(
      internet = b_internet_time + r_region__internet + r_country__internet,
      outcome = {{beta}} + {{r_region}} + {{r_country}}
    ) %>% 
    group_by(country, region) %>% 
    median_qi(internet, outcome)
  
  # Create country ellipse data
  country_ellipse <- spread_draws(
    fit,
    {{beta}}, 
    b_internet_time,
    {{sd_country}},
    sd_country__internet_time,
    {{cor_country}}, 
    ndraws = 100
  ) %>% 
    rename(
      cor = {{cor_country}}, 
      sd_outcome = {{sd_country}},
      sd_i = sd_country__internet_time,
      b_outcome = {{beta}},
      b_i = b_internet_time
    ) %>% 
    mutate(
      e = pmap(
        list(cor, sd_outcome, sd_i, b_outcome, b_i), 
        function(cor, sd_a, sd_i, b_a, b_i) 
          ellipse(
            cor, 
            scale = c(sd_i, sd_outcome), 
            centre = c(b_i, b_outcome), 
            level = .90
          ) %>% 
          as_tibble()
      )
    ) %>% 
    unnest(e)
  
  # Correlation
  country_cor_result <- spread_draws(fit, {{cor_country}}) %>% 
    median_qi(.width = .90) %>% 
    mutate(across(where(is.numeric), ~round(., 2))) %>%
    {str_glue("{.[,1]} [{.[,2]}, {.[,3]}]")}
  
  # Plot
  country_coefs %>% 
    ggplot(aes(internet, outcome)) +
    geom_path(
      data = country_ellipse,
      aes(x = x, y = y), 
      alpha = .2, size = .1, col = "dodgerblue1"
    ) +
    geom_vline(xintercept = 0, lty = 2, size = .2) +
    geom_hline(yintercept = 0, lty = 2, size = .2) +
    geom_point(col = "dodgerblue1", size = 1, alpha = .5) +
    scale_x_continuous(
      "Internet trend",
      breaks = pretty_breaks()
    ) +
    scale_y_continuous(
      breaks = pretty_breaks()
    ) +
    annotate(
      "text",
      x = Inf, y = Inf, label = country_cor_result,
      size = 4, vjust = 1.5, hjust = 1.05, color = "dodgerblue4",
      family = Font
    )
}
```

```{r}
p_cor_country_anx <- draw_scatterplot(
  fit_anx, 
  b_Anxiety_time, 
  r_region__Anxiety, 
  r_country__Anxiety,
  sd_country__Anxiety_time,
  cor_country__internet_time__Anxiety_time
) + labs(y = "Anxiety trend")
p_cor_country_dep <- draw_scatterplot(
  fit_dep, 
  b_Depression_time, 
  r_region__Depression, 
  r_country__Depression,
  sd_country__Depression_time,
  cor_country__internet_time__Depression_time
) + labs(y = "Depression trend")
p_cor_country_sel <- draw_scatterplot(
  fit_sel, 
  b_Selfharm_time, 
  r_region__Selfharm, 
  r_country__Selfharm,
  sd_country__Selfharm_time,
  cor_country__internet_time__Selfharm_time
) + labs(y = "Self-harm trend")
```

```{r}
p_time_main_correlations <- (p_cor_country_anx |
                               p_cor_country_dep |
                               p_cor_country_sel) &
  # Transform to rate in 100k
  scale_y_continuous(labels = function(x) x*1000)

(wrap_elements(grid::textGrob('Negative experiences\nTBD')) |
    wrap_elements(grid::textGrob('Positive experiences\nTBD')) |
    wrap_elements(grid::textGrob('Life satisfaction\nTBD'))) /
  p_time_main_correlations

p_time_main_coefs /
  p_time_main_correlations
```


```{r time-correlation-depression}
# Get average and region
r_region_depression <- fit_dep %>% 
  spread_draws(
    b_Depression_time, 
    b_internet_time,
    r_region__Depression[region, term],
    r_region__internet[region, term]
  ) %>% 
  filter(term == "time") %>% 
  ungroup() %>% 
  # Fix names by replacing dot with line break
  mutate(region = str_replace(region, "\\.", "\n"))

# Then country
r_country_depression <- fit_dep %>% 
  spread_draws(
    r_country__Depression[country, term],
    r_country__internet[country, term]
  ) %>% 
  filter(term == "time") %>% 
  ungroup() %>% 
  # Fix names by taking labels from original names
  mutate(
    country = factor(
      country, 
      labels = sort(unique(fit_dep$data$country))
    )
  ) %>% 
  left_join(distinct(dat, region, country))

# Calculate country coefficients
country_depression <- left_join(r_country_depression, r_region_depression) %>% 
  mutate(
    internet = b_internet_time + r_region__internet + r_country__internet,
    depression = b_Depression_time + r_region__Depression + r_country__Depression
  ) %>% 
  group_by(country, region) %>% 
  median_qi(internet, depression)

country_depression_ellipse <- spread_draws(
  fit_dep,
  b_Depression_time, b_internet_time,
  cor_country__internet_time__Depression_time, 
  ndraws = 100
) %>% 
  mutate(
    e = pmap(
      list(
        x = cor_country__internet_time__Depression_time, 
        y = b_internet_time, 
        z = b_Depression_time
      ), 
      function(x, y, z) ellipse::ellipse(x, centre = c(y, z), level = .8) %>% 
        as_tibble()
    )
  ) %>% 
  unnest(e)

region_depression_ellipse <- spread_draws(
  fit_dep,
  b_Depression_time, b_internet_time,
  cor_region__internet_time__Depression_time, 
  ndraws = 100
) %>% 
  mutate(
    e = pmap(
      list(
        x = cor_region__internet_time__Depression_time, 
        y = b_internet_time, 
        z = b_Depression_time
      ), 
      function(x, y, z) ellipse::ellipse(x, centre = c(y, z), level = .8) %>% 
        as_tibble()
    )
  ) %>% 
  unnest(e)

country_depression_cor <- fit_dep %>%
  as_draws_df(
    variable = c(
      "cor_country__internet_time__Depression_time",
      "cor_region__internet_time__Depression_time"
    ),
    regex = TRUE
  ) %>% 
  as_tibble()
country_depression_result <- country_depression_cor %>%   
  summarise_draws(quantile, rhat, .args = list(probs = c(.5, .05, .95))) %>% 
  mutate(across(where(is.numeric), ~round(., 2))) %>% 
  mutate(result = str_glue("{`50%`} [{`5%`}, {`95%`}]"))

p_cor_country_dep <- country_depression %>% 
  ggplot(aes(internet, depression)) +
  # geom_path(
  #   data = region_depression_ellipse, 
  #   aes(x=x, y=y), alpha = .2, size = .1, col = "dodgerblue4"
  # ) +
  # geom_path(
  #   data = country_depression_ellipse, 
  #   aes(x=x, y=y), alpha = .2, size = .1, col = "dodgerblue1"
  # ) +
  geom_vline(xintercept = 0, lty = 2, size = .2) +
  geom_hline(yintercept = 0, lty = 2, size = .2) +
  geom_point(col = "dodgerblue1", size = 1, alpha = .75) +
  scale_x_continuous(
    "Linear internet trend",
    breaks = pretty_breaks()
  ) +
  scale_y_continuous(
    "Linear depression trend",
    breaks = pretty_breaks()
  ) +
  geom_richtext(
    data = country_depression_result %>% 
      filter(variable == "cor_country__internet_time__Depression_time"),
    aes(x = -Inf, y = Inf, label = result),
    size = 3, vjust = 1, hjust = -0.1, color = "dodgerblue4",
    family = Font,
    fill = NA, label.color = NA
  ) +
  theme(aspect.ratio = 1)
```

```{r time-correlation-selfharm}
# Get average and region
r_region_selfharm <- fit_sel %>% 
  spread_draws(
    b_Selfharm_time, 
    b_internet_time,
    r_region__Selfharm[region, term],
    r_region__internet[region, term]
  ) %>% 
  filter(term == "time") %>% 
  ungroup() %>% 
  # Fix names by replacing dot with line break
  mutate(region = str_replace(region, "\\.", "\n"))

# Then country
r_country_selfharm <- fit_sel %>% 
  spread_draws(
    r_country__Selfharm[country, term],
    r_country__internet[country, term]
  ) %>% 
  filter(term == "time") %>% 
  ungroup() %>% 
  # Fix names by taking labels from original names
  mutate(
    country = factor(
      country, 
      labels = sort(unique(fit_sel$data$country))
    )
  ) %>% 
  left_join(distinct(dat, region, country))

# Calculate country coefficients
country_selfharm <- left_join(r_country_selfharm, r_region_selfharm) %>% 
  mutate(
    internet = b_internet_time + r_region__internet + r_country__internet,
    selfharm = b_Selfharm_time + r_region__Selfharm + r_country__Selfharm
  ) %>% 
  group_by(country, region) %>% 
  median_qi(internet, selfharm)

country_selfharm_ellipse <- spread_draws(
  fit_sel,
  b_Selfharm_time, b_internet_time,
  cor_country__internet_time__Selfharm_time, 
  ndraws = 100
) %>% 
  mutate(
    e = pmap(
      list(
        x = cor_country__internet_time__Selfharm_time, 
        y = b_internet_time, 
        z = b_Selfharm_time
      ), 
      function(x, y, z) ellipse::ellipse(x, centre = c(y, z), level = .8) %>% 
        as_tibble()
    )
  ) %>% 
  unnest(e)

region_selfharm_ellipse <- spread_draws(
  fit_sel,
  b_Selfharm_time, b_internet_time,
  cor_region__internet_time__Selfharm_time, 
  ndraws = 100
) %>% 
  mutate(
    e = pmap(
      list(
        x = cor_region__internet_time__Selfharm_time, 
        y = b_internet_time, 
        z = b_Selfharm_time
      ), 
      function(x, y, z) ellipse::ellipse(x, centre = c(y, z), level = .8) %>% 
        as_tibble()
    )
  ) %>% 
  unnest(e)

country_selfharm_cor <- fit_sel %>%
  as_draws_df(
    variable = c(
      "cor_country__internet_time__Selfharm_time",
      "cor_region__internet_time__Selfharm_time"
    ),
    regex = TRUE
  ) %>% 
  as_tibble()
country_selfharm_result <- country_selfharm_cor %>%   
  summarise_draws(quantile, rhat, .args = list(probs = c(.5, .05, .95))) %>% 
  mutate(across(where(is.numeric), ~round(., 2))) %>% 
  mutate(result = str_glue("{`50%`} [{`5%`}, {`95%`}]"))

p_cor_country_sel <- country_selfharm %>% 
  ggplot(aes(internet, selfharm)) +
  # geom_path(
  #   data = region_selfharm_ellipse, 
  #   aes(x=x, y=y), alpha = .2, size = .1, col = "dodgerblue4"
  # ) +
  # geom_path(
  #   data = country_selfharm_ellipse, 
  #   aes(x=x, y=y), alpha = .2, size = .1, col = "dodgerblue1"
  # ) +
  geom_vline(xintercept = 0, lty = 2, size = .2) +
  geom_hline(yintercept = 0, lty = 2, size = .2) +
  geom_point(col = "dodgerblue1", size = 1, alpha = .75) +
  scale_x_continuous(
    "Linear internet trend",
    breaks = pretty_breaks()
  ) +
  scale_y_continuous(
    "Linear selfharm trend",
    breaks = pretty_breaks()
  ) +
  geom_richtext(
    data = country_selfharm_result %>% 
      filter(variable == "cor_country__internet_time__Selfharm_time"),
    aes(x = -Inf, y = Inf, label = result),
    size = 3, vjust = 1, hjust = -0.1, color = "dodgerblue4",
    family = Font,
    fill = NA, label.color = NA
  ) +
  theme(aspect.ratio = 1)
```

```{r}
p_cor_country_anx + theme(axis.title.x = element_blank()) | 
  p_cor_country_dep | 
  p_cor_country_sel + theme(axis.title.x = element_blank())
```


##### Time: Interactions

```{r}
# Define models of outcomes
bf_anx <- bf(
  Anxiety ~ 1 + time * sex + time * age + 
    (1 + time * sex + time * age |c| country) +
    (1 + time * sex + time * age |r| region),
  family = gaussian()
)
bf_dep <- bf(
  Depression ~ 1 + time + sex + age + 
    (1 + time * sex + time * age |c| country) +
    (1 + time * sex + time * age |r| region),
  family = gaussian()
)
bf_sel <- bf(
  Selfharm ~ 1 + time + sex + age + 
    (1 + time * sex + time * age |c| country) +
    (1 + time * sex + time * age |r| region),
  family = gaussian()
)

# Fit models
fit_anx <- brm(
  bf_int + bf_anx + set_rescor(FALSE),
  data = dat_10,
  file = "output/brm-gbd-time-anxiety-int2",
  chains = 4,
  cores = 4,
  iter = hmc$iter, warmup = hmc$warmup, 
  control = list(adapt_delta = hmc$d)
)
fit_dep <- brm(
  bf_int + bf_dep + set_rescor(FALSE),
  data = dat_10,
  file = "output/brm-gbd-time-depression-int2",
  chains = 4,
  cores = 4,
  iter = hmc$iter, warmup = hmc$warmup, 
  control = list(adapt_delta = hmc$d)
)
fit_sel <- brm(
  bf_int + bf_sel + set_rescor(FALSE),
  data = dat_10,
  file = "output/brm-gbd-time-selfharm-int2",
  chains = 4,
  cores = 4,
  iter = hmc$iter, warmup = hmc$warmup, 
  control = list(adapt_delta = hmc$d)
)
fits_brm_time_interactions <- tibble(
  outcome = c("Anxiety", "Depression", "Selfharm"),
  fit = list(fit_anx, fit_dep, fit_sel)
)
```

Coefficients

```{r}
fits_brm_time_interactions %>% 
  mutate(
    out = map(
      fit, 
      ~as_draws(.x, variable = "b_", regex = TRUE) %>% 
        summarise_draws(quantile, rhat, .args = list(probs = c(.05, .5, .95)))
    )
  ) %>% 
  select(-fit) %>% 
  unnest(out) %>% 
  # filter(str_detect(Parameter, "_time$")) %>% 
  kbl(digits = 2) %>% 
  kable_minimal(full_width = FALSE)
```

Model comparison using waic shows that interactive model is favored across the board.

```{r eval = FALSE}
waics <- left_join(
  rename(fits_brm_time_main, fit_main = fit),
  rename(fits_brm_time_interactions, fit_intr = fit)
) %>% 
  mutate(waic = map2(fit_main, fit_intr, ~waic(.x, .y)))
waics$waic[[3]]
```

Show main effects

Plot fixed effects and by demographic

```{r}
# Fixed effects parameters
fixed_effects <- fits_brm_time_interactions %>% 
  mutate(out = map(fit, ~tidy(., conf.int = TRUE))) %>% 
  select(-fit) %>% 
  unnest(out) %>% 
  standardize_names() %>% 
  as_tibble() %>% 
  filter(
    Effects == "fixed", 
    Parameter != "(Intercept)"
  ) 
# Fixed effects per demographic
fixed_effects_demographics <- fits_brm_time_interactions %>% 
  mutate(
    out = map2(
      fit, outcome,
      ~emtrends(
        .x, 
        var = "time", 
        by = c("sex", "age"), 
        resp = .y
      ) %>% 
        parameters() %>% 
        as.data.frame()
    )
  )
fixed_effects_demographics %>% 
  select(-fit) %>% 
  unnest(out) %>% 
  standardize_names() %>% 
  as_tibble() %>% 
  mutate(Parameter = str_glue("{sex}\n({age})"))

# Random effects parameters
random_effects <- fits_lmer %>% 
  mutate(
    coef_region = map(
      fit, 
      ~bind_rows(
        coef(.x)$region %>% 
          as.data.frame() %>% 
          rownames_to_column("region"),
        coef(.x)$country %>% 
          as.data.frame() %>% 
          rownames_to_column("country"),
        .id = "cluster"
      ) %>% 
        mutate(cluster = factor(cluster, labels = c("region", "country")))
    )
  ) %>% 
  select(-fit) %>% 
  unnest(coef_region) %>% 
  mutate(Type = "Effects") %>%
  select(-`(Int      ,nc ercept)`)

bind_rows(
  fixed_effects,
  fixed_effects_demographics, 
  .id = "Type"
) %>% 
  mutate(Type = factor(Type, labels = c("Effects", "Time by demographic"))) %>% 
  mutate(Parameter = fct_inorder(Parameter)) %>%
  mutate(cause = factor(cause)) %>% 
  rowwise() %>% 
  mutate(
    sig = factor(
      !between(0, CI_low, CI_high), 
      levels = c(TRUE, FALSE)
    )
  ) %>% 
  ggplot(aes(Coefficient, Parameter, col = cause, shape = sig)) +
  scale_color_discrete(
    "Outcome"
  ) +
  scale_x_continuous(
    "Estimate (95%CI)"
  ) +
  scale_shape_manual(values = c(19, 21)) +
  geom_vline(xintercept = 0, size = .2, alpha = .2) +
  geom_pointrangeh(
    aes(xmin = CI_low, xmax = CI_high),
    position = position_dodge2v(.5),
    fill = "white", size = .3, fatten = 5
  ) +
  guides(shape = "none") +
  facet_wrap("Type", ncol = 2, scales = "free") +
  theme(axis.title.y = element_blank())
```

```{r}
library(modelbased)
x <- parameters(fits_brm$fit[[1]], test = "pd", effects = "random", group_level = TRUE, keep = "time_Intercept")
tmp <- fits_brm %>% 
  mutate(
    # Average effect
    avg = map2(
      fit, 
      Outcome, 
      ~hypothesis(.x, str_glue("{.y}_time = 0"))
    ),
    # By country effect
    by_country = map2(
      fit, 
      Outcome, 
      ~hypothesis(
        .x, str_glue("{.y}_time = 0"), 
        scope = "coef", group = "country"
      )
    ),
    # By region effect
    by_region = map2(
      fit, 
      Outcome, 
      ~hypothesis(
        .x, str_glue("{.y}_time = 0"), 
        scope = "coef", group = "region"
      )
    )
  ) %>% 
  select(-fit)

tmp %>% 
  select(Outcome, avg) %>% 
  mutate(avg = map(avg, ))

tmp$by_region[[1]] %>% str

h <- paste(
  c("valAnxiety_Time", "valDepression_Time", "valSelfharm_Time"), 
  "= 0"
)

# Prepare average samples
time_avg <- hypothesis(fit_gbd_time, h)
time_avg_samples <- time_avg$samples
names(time_avg_samples) <- time_avg$hypothesis$Hypothesis
time_avg_samples <- time_avg_samples %>% 
  pivot_longer(everything(), names_to = "Parameter") %>% 
  mutate(region = "Average")

# Prepare region samples
time_region <- hypothesis(fit_gbd_time, h, scope = "coef", group = "region")
time_region_samples <- time_region$samples
names(time_region_samples) <- paste(
  time_region$hypothesis$Hypothesis, 
  time_region$hypothesis$Group, sep = ":"
)
time_region_samples <- time_region_samples %>% 
  pivot_longer(everything(), names_to = "Parameter") %>% 
  separate(Parameter, c("Parameter", "region"), sep = ":")

# Prepare country point estimates
time_country <- hypothesis(fit_gbd_time, h, scope = "coef", group = "country")
time_country_hypothesis <- time_country$hypothesis %>% 
  rename(country = Group, Parameter = Hypothesis)
time_country_hypothesis <- left_join(
  time_country_hypothesis, 
  distinct(fit_gbd_time$data, country, region)
)

time_sum <- bind_rows(
  time_region$hypothesis,
  time_avg$hypothesis %>% mutate(Group = "Average")
) %>% 
  as_tibble() %>% 
  rename(region = Group, Parameter = Hypothesis)

bind_rows(
  time_region_samples,
  time_avg_samples
) %>% 
  mutate(region = fct_relevel(region, "Average")) %>% 
  mutate(Average = region == "Average") %>% 
  ggplot(aes(value/10, region)) +
  scale_y_discrete(
    expand = expansion(c(0.025, 0.075)),
    labels = function(x) ifelse(x == "Average", "**Average**", x)
  ) +
  scale_x_continuous(
    "Estimated yearly change",
    breaks = pretty_breaks(5)
  ) +
  scale_alpha_manual(values = c(.5, 1)) +
  geom_vline(xintercept = 0, size = .2, alpha = .25) +
  stat_eye(
    side = "top",
    aes(col = region, fill = region, alpha = Average),
    point_interval = NULL,
    normalize = "panels", 
    height = .75
  ) +
  geom_pointrangeh(
    data = time_sum,
    aes(x = Estimate/10, xmin = CI.Lower/10, xmax = CI.Upper/10),
    size = .3, fatten = 1.4
  ) +
  geom_point(
    data = time_country_hypothesis,
    aes(col = region, x = Estimate/10), 
    size = .5,
    alpha = .25,
    position = position_nudge(y = -.05)
  ) +
  facet_wrap(
    "Parameter", ncol = 3, scales = "free_x",
    labeller = as_labeller(
      function(x) str_extract(x, "Anxiety|Depression|Selfharm"))
  ) +
  theme(
    axis.text.y = element_markdown(),
    legend.position = "none",
    axis.title.y = element_blank()
  )
ggsave(
  "output/Fig-brm-time-forest.png", 
  device = agg_png,
  height = 1200, width = 3200, res = 300, units = "px"
)
```
