# Results

```{r setup, include = FALSE}
#| cache: false
# Packages
library(scales)
library(kableExtra)
library(ggstance)
library(brms)
library(tidybayes)
library(ggdist)
library(lme4)
library(broom.mixed)
library(memoise)
library(cachem)
library(flextable)
library(posterior)
library(ggh4x)
library(parameters)
library(emmeans)
library(patchwork)
library(bayestestR)
library(plotly)
library(tidyverse)

# Common options
source("_common.R")
cd <- cache_disk("memoise_cache", max_size = Inf)

oo <- c(
  "Life_satisfaction", "Negative_experiences", "Positive_experiences",
  "Anxiety", "Depression", "Selfharm"
)
fits <- tibble(outcome = oo) %>%
  mutate(outcome = factor(outcome, levels = oo))

dat <- readRDS("data/data-all.rds")
```

Here, we examine the models to answer

1. To what extent have the well-being and mental health outcomes changed over time
2. To what extent do lagged internet/mobile adoption values predict changes in the outcomes above and beyond the temporal trends
2b. Variance across country, sex, and age in the above
3. Correlations between country-level parameters

```{r}
# Before drawing any plots, we need to extract/compute the relevant parameters from the models. We do that here: For each outcome, we get the countries' average changes over time (in the outcome, internet, and mobile) and associations with internet and mobile
country_post_fun <- function(outcome) {
  
  fit1 <- readRDS(str_glue("models-small/brm-{outcome}-1.rds"))
  fit2 <- readRDS(str_glue("models-small/brm-{outcome}-2.rds"))
  fit3 <- readRDS(str_glue("models-small/brm-{outcome}-3.rds"))
  fit4 <- readRDS(str_glue("models-small/brm-{outcome}-4.rds"))
  
  out_outcome_year <- spread_draws(
    fit1,
    b_val_year, r_country__val[country, x] | country
  ) %>% 
    filter(x == "year") %>% 
    ungroup() %>% 
    rename(World = b_val_year) %>% 
    mutate(y = "outcome")
  
  out_internet_year <- spread_draws(
    fit1,
    b_internet_year, r_country__internet[country, x] | country
  ) %>% 
    filter(x == "year") %>% 
    ungroup() %>% 
    rename(World = b_internet_year) %>% 
    mutate(y = "Internet")
  
  out_mobile_year <- spread_draws(
    fit2,
    b_mobile_year, r_country__mobile[country, x] | country
  ) %>% 
    filter(x == "year") %>% 
    ungroup() %>% 
    rename(World = b_mobile_year) %>% 
    mutate(y = "Mobile")
    
  out_outcome_internet <- spread_draws(
    fit3,
    b_i1_cw, r_country[country, x] | country
  ) %>% 
    filter(x == "i1_cw") %>% 
    ungroup() %>% 
    rename(World = b_i1_cw) %>% 
    mutate(y = "outcome")
  
  out_outcome_mobile <- spread_draws(
    fit4,
    b_m1_cw, r_country[country, x] | country
  ) %>% 
    filter(x == "m1_cw") %>% 
    ungroup() %>% 
    rename(World = b_m1_cw) %>% 
    mutate(y = "outcome")
  
  out <- bind_rows(
    out_outcome_year, 
    out_internet_year,
    out_mobile_year,
    out_outcome_internet,
    out_outcome_mobile
  ) %>%  
    select(x, y, everything(), -c(.chain, .iteration, .draw)) %>% 
    mutate(across(-c(x, y, World), ~. + World)) %>% 
    rename_with(~str_replace_all(., "\\.(?!\\.)", " ")) %>% 
    mutate(
      x = factor(
        x, 
        levels = c("year", "i1_cw", "m1_cw"),
        labels = c("Time", "Internet", "Mobile")
        )
    )
  
  out 
}
country_post_fun <- memoise(country_post_fun, cache = cd)
country_post <- fits %>% 
  mutate(
    samples = map(outcome, country_post_fun),
    summary = map(
      samples, 
      ~.x %>% 
        group_by(x, y) %>% 
        summarise_draws(
          mean, 
          ~quantile2(., probs = c(.025, .975)),
          pd = ~pd(as.numeric(.))
        ) %>% 
        rename(country = variable)
    )
  )
```

## Time courses

::: {.panel-tabset .column-body-outset-right}

### Countries

```{r}
#| fig.width: 10
#| fig.height: 8
country_year_plot <- country_coefs %>% 
  filter(x == "Time", y == "outcome") %>% 
  # Arrange each panel
  group_by(outcome) %>% 
  arrange(outcome, mean) %>% 
  mutate(n = 1:n(), y = factor(n)) %>% 
  ungroup() %>% 
  mutate(
    level = country != "World", 
    mh = outcome %in% oo[4:6],
    text = str_glue("{country} ({number(mean, .01)} [{number(q2.5, .01)}, {number(q97.5, .01)}])")
  ) %>% 
  ggplot(aes(mean, y, color = level)) +
  scale_size_manual(values = c(1.25, 0.25)) +
  scale_color_manual(values = c("dodgerblue4", "dodgerblue1")) +
  scale_y_discrete(expand = expansion(.01)) +
  scale_x_continuous(
    "Estimated change per decade",
    breaks = extended_breaks(),
    expand = expansion(.01),
    labels = ~percent(./100)
  ) +
  geom_vline(xintercept = 0, lty = 2, size = .2) +
  geom_segment(
    aes(
      x = q2.5, xend = q97.5, yend = y, 
      text = text
    ),
    size = .15
  ) +
  # Put world in top layer
  geom_point(
    data = . %>% filter(country == "World"), 
    aes(text = text, size = level)
  ) +
  facet_wrap(
    "outcome", 
    nrow = 2, 
    scales = "free",
    labeller = as_labeller(~str_replace(., "_", " "))
  ) +
  labs(y = "Country") +
  theme(
    legend.position = "none",
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )

country_year_plot
```

### Countries interactive

```{r out.height = 860}
gp <- ggplotly(country_year_plot, tooltip = "text")
gp %>% 
  layout(
    margin = list(t = 40, r = 20, b = 60, l = 30),
    width = 970,
    height = 830
  )
```

### Age and sex

```{r}
#| fig.width: 10
#| fig.height: 8
sex_year_sum <- function(fit) {
  spread_draws(
    fit, 
    b_val_year, `b_val_year:sex1`, r_age__val[age, term] | term
  ) %>% 
    transmute(
      female = b_val_year + year + (`b_val_year:sex1` + `year:sex1`)*1,
      male = b_val_year + year + (`b_val_year:sex1` + `year:sex1`)*-1
    ) %>% 
    pivot_longer(-age) %>% 
    group_by(age, name) %>% 
    mean_qi()
}
sex_year_sum <- memoise(sex_year_sum, cache = cd)

sex_year_coefs <- fits %>% 
  mutate(
    fit = map(outcome, ~readRDS(str_glue("models-small/brm-{.x}-1.rds"))),
    sex_year = map(fit, sex_year_sum)
  ) %>% 
  select(-fit) %>% 
  unnest(sex_year)

sex_year_plot <- sex_year_coefs %>% 
  mutate(Sex = str_to_title(name)) %>% 
  mutate(age = str_replace_all(age, "\\.(?!\\.)", " ")) %>% 
  ggplot(aes(value, age, col = Sex)) +
  scale_color_vibrant() +
  scale_x_continuous(
    "Estimated change per decade",
    breaks = extended_breaks(),
    expand = expansion(.1),
    labels = ~percent(./100)
  ) +
  geom_vline(xintercept = 0, lty = 2, size = .2) +
  geom_pointrangeh(
    aes(xmin = .lower, xmax = .upper),
    position = position_dodge2v(.35),
    size = .25, fatten = 1.5
  ) +
  facet_wrap(
    "outcome", 
    nrow = 2, 
    scales = "free_x",
    labeller = as_labeller(~str_replace(., "_", " "))
  ) +
  theme(
    axis.title.y = element_blank()
  )
sex_year_plot
```

#### Table

```{r}
country_year_coefs %>% 
  filter(country == "World") %>% 
  mutate(
    across(
      c(mean, q2.5, q97.5), ~percent(./100, .01)
    ),
    pd = percent(pd, .1)
  ) %>% 
  kbl(caption = "Average changes per decade") %>% 
  kable_custom()
```


:::

### Average trends

```{r}
country_year_coefs %>% 
  filter(country == "World") %>% 
  transmute(
    Outcome = str_replace(outcome, "_", " "),
    Trend = str_glue("{number(mean, .01)} [{number(q2.5, .01)}, {number(q97.5, .01)}]")
  ) %>% 
  kbl(caption = "Estimated world average changes per decade") %>% 
  kable_custom()
```


## Associations

### Internet

::: {.panel-tabset}

#### Countries

```{r}
#| fig.width: 10
#| fig.height: 8
country_internet_plot <- country_coefs %>% 
  filter(x == "Internet", y == "outcome") %>% 
  # Arrange each panel
  group_by(outcome) %>% 
  arrange(outcome, mean) %>% 
  mutate(n = 1:n(), y = factor(n)) %>% 
  ungroup() %>% 
  mutate(
    level = country != "World", 
    mh = outcome %in% oo[4:6],
    text = str_glue("{country} ({number(mean, .01)} [{number(q2.5, .01)}, {number(q97.5, .01)}])")
  ) %>% 
  # mutate(star = sign(.lower) == sign(.upper)) %>% 
  ggplot(aes(mean, y, color = level)) +
  scale_size_manual(values = c(1.25, 0.25)) +
  scale_color_manual(values = c("dodgerblue4", "dodgerblue1")) +
  scale_y_discrete(expand = expansion(.01)) +
  # Association with 10% change
  scale_x_continuous(
    "Estimated association with 10% increase in\nper capita internet users",
    breaks = extended_breaks(),
    labels = ~percent(./1000)
  ) +
  geom_vline(xintercept = 0, lty = 2, size = .2) +
  geom_segment(
    aes(
      x = q2.5, xend = q97.5, yend = y, 
      text = text
    ),
    size = .15
  ) +
  geom_point(aes(text = text, size = level)) +
  # Put world in top layer
  geom_point(
    data = . %>% filter(country == "World"), 
    aes(text = text, size = level)
  ) +
  facet_wrap(
    "outcome", 
    nrow = 2, 
    scales = "free",
    labeller = as_labeller(~str_replace(., "_", " "))
  ) +
  labs(y = "Country") +
  theme(
    legend.position = "none",
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )
country_internet_plot
```

#### Countries interactive

```{r out.height = 860}
gp <- ggplotly(country_internet_plot, tooltip = "text")
gp %>% 
  layout(
    margin = list(t = 40, r = 20, b = 60, l = 30),
    width = 970,
    height = 830
  )
```

#### Age and sex

```{r}
#| fig.width: 10
#| fig.height: 8
sex_internet_sum <- function(fit) {
  spread_draws(
    fit, 
    b_i1_cw, `b_i1_cw:sex1`, r_age[age, term] | term
  ) %>% 
    transmute(
      female = b_i1_cw + i1_cw + (`b_i1_cw:sex1` + `i1_cw:sex1`)*1,
      male = b_i1_cw + year + (`b_i1_cw:sex1` + `i1_cw:sex1`)*-1
    ) %>% 
    pivot_longer(-age) %>% 
    group_by(age, name) %>% 
    mean_qi()
}
sex_internet_sum <- memoise(sex_internet_sum, cache = cd)

sex_internet_coefs <- fits %>% 
  mutate(
    fit = map(outcome, ~readRDS(str_glue("models-small/brm-{.x}-3.rds"))),
    sex_internet = map(fit, sex_internet_sum)
  ) %>% 
  select(-fit) %>% 
  unnest(sex_internet)

sex_internet_plot <- sex_internet_coefs %>% 
  mutate(Sex = str_to_title(name)) %>% 
  mutate(age = str_replace_all(age, "\\.(?!\\.)", " ")) %>% 
  ggplot(aes(value, age, col = Sex)) +
  scale_color_vibrant() +
  scale_x_continuous(
    "Estimated association with 10% increase in\nper capita internet users",
    breaks = extended_breaks(),
    labels = ~percent(./1000)
  ) +
  geom_vline(xintercept = 0, lty = 2, size = .2) +
  geom_pointrangeh(
    aes(xmin = .lower, xmax = .upper),
    position = position_dodge2v(.35),
    size = .25, fatten = 1.5
  ) +
  facet_wrap(
    "outcome", 
    nrow = 2, 
    scales = "free_x",
    labeller = as_labeller(~str_replace(., "_", " "))
  ) +
  theme(
    axis.title.y = element_blank()
  )
sex_internet_plot
```

#### Table

```{r}
country_internet_coefs %>% 
  filter(country == "World") %>% 
  mutate(
    across(
      c(mean, q2.5, q97.5), ~percent(./1000, .001)
    )
  ) %>% 
  kbl(caption = "Estimated world associations with 10% increase in internet adoption") %>% 
  kable_custom()
```

:::

### Mobile

::: {.panel-tabset}

#### Countries

```{r}
#| fig.width: 10
#| fig.height: 8
country_mobile_plot <- country_coefs %>% 
  filter(x == "Mobile", y == "outcome") %>% 
  # Arrange each panel
  group_by(outcome) %>% 
  arrange(outcome, mean) %>% 
  mutate(n = 1:n(), y = factor(n)) %>% 
  ungroup() %>% 
  mutate(
    level = country != "World", 
    mh = outcome %in% oo[4:6],
    text = str_glue("{country} ({number(mean, .01)} [{number(q2.5, .01)}, {number(q97.5, .01)}])")
  ) %>% 
  # mutate(star = sign(.lower) == sign(.upper)) %>% 
  ggplot(aes(mean, y, color = level)) +
  scale_size_manual(values = c(1.25, 0.25)) +
  scale_color_manual(values = c("dodgerblue4", "dodgerblue1")) +
  scale_y_discrete(expand = expansion(.01)) +
  # Association with 10% change
  scale_x_continuous(
    "Estimated association with 10% increase in\nper capita mobile broadband subscriptions",
    breaks = extended_breaks(),
    labels = ~percent(./1000)
  ) +
  geom_vline(xintercept = 0, lty = 2, size = .2) +
  geom_segment(
    aes(
      x = q2.5, xend = q97.5, yend = y, 
      text = text
    ),
    size = .15
  ) +
  geom_point(aes(text = text, size = level)) +
  # Put world in top layer
  geom_point(
    data = . %>% filter(country == "World"), 
    aes(text = text, size = level)
  ) +
  facet_wrap(
    "outcome", 
    nrow = 2, 
    scales = "free",
    labeller = as_labeller(~str_replace(., "_", " "))
  ) +
  labs(y = "Country") +
  theme(
    legend.position = "none",
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )
country_mobile_plot
```

#### Countries interactive

```{r out.height = 860}
gp <- ggplotly(country_mobile_plot, tooltip = "text")
gp %>% 
  layout(
    margin = list(t = 40, r = 20, b = 60, l = 30),
    width = 970,
    height = 830
  )
```

#### Age and sex

```{r}
#| fig.width: 10
#| fig.height: 8
sex_mobile_sum <- function(fit) {
  spread_draws(
    fit, 
    b_m1_cw, `b_m1_cw:sex1`, r_age[age, term] | term
  ) %>% 
    transmute(
      female = b_m1_cw + m1_cw + (`b_m1_cw:sex1` + `m1_cw:sex1`)*1,
      male = b_m1_cw + year + (`b_m1_cw:sex1` + `m1_cw:sex1`)*-1
    ) %>% 
    pivot_longer(-age) %>% 
    group_by(age, name) %>% 
    mean_qi()
}
sex_mobile_sum <- memoise(sex_mobile_sum, cache = cd)

sex_mobile_coefs <- fits %>% 
  mutate(
    fit = map(outcome, ~readRDS(str_glue("models-small/brm-{.x}-4.rds"))),
    sex_mobile = map(fit, sex_mobile_sum)
  ) %>% 
  select(-fit) %>% 
  unnest(sex_mobile)

sex_mobile_plot <- sex_mobile_coefs %>% 
  mutate(Sex = str_to_title(name)) %>% 
  mutate(age = str_replace_all(age, "\\.(?!\\.)", " ")) %>% 
  ggplot(aes(value, age, col = Sex)) +
  scale_color_vibrant() +
  scale_x_continuous(
    "Estimated association with 10% increase in\nper capita mobile broadband subscriptions",
    breaks = extended_breaks(),
    labels = ~percent(./1000)
  ) +
  geom_vline(xintercept = 0, lty = 2, size = .2) +
  geom_pointrangeh(
    aes(xmin = .lower, xmax = .upper),
    position = position_dodge2v(.35),
    size = .25, fatten = 1.5
  ) +
  facet_wrap(
    "outcome", 
    nrow = 2, 
    scales = "free_x",
    labeller = as_labeller(~str_replace(., "_", " "))
  ) +
  theme(
    axis.title.y = element_blank()
  )
sex_mobile_plot
```

#### Table

```{r}
country_mobile_coefs %>% 
  filter(country == "World") %>% 
  mutate(
    across(
      c(mean, q2.5, q97.5), ~percent(./100, .01)
    )
  ) %>% 
  kbl(caption = "Estimated world associations with 10% increase in mobile internet subscriptions") %>% 
  kable_custom()
```

:::

## Figure 2

For this one, we rescale the outcome~internet and outcome~mobile associations to be in units of decade-equivalent changes of internet and mobile.

```{r}
# There is a different scaling factor for each outcome,
# even though they used the same internet/mobile values. That's because 
# different countries were included by outcome, and its then most faithful
# to the data to keep these separate by outcome.
scaling_factors <- country_post %>% 
  select(-samples) %>% 
  unnest(summary) %>% 
  filter(x == "Time", y != "outcome") %>% 
  select(outcome, y, country, scaling = mean)

country_coefs_scaled <- country_post %>% 
  select(-samples) %>% 
  unnest(summary) %>%
  filter(y == "outcome") %>% 
  select(-y) %>% 
  # Get internet-decade changes
  left_join(scaling_factors, by = c("x" = "y", "outcome", "country")) %>%
  mutate(scaling = if_else(x == "Time", 1, scaling)) %>% 
  # Scale associations
  mutate(across(c(mean, q2.5, q97.5), ~ . * scaling)) %>% 
  # Arrange panels
  mutate(x = factor(x, levels = c("Time", "Internet", "Mobile")))

# Arrange points within panels such that the order of countries is same in the rows of each column, running from smallest time change to greatest time change. This is a rudimentary way to show correlation between the two.
tmp <- country_coefs_scaled %>% 
  filter(x == "Time", country != "World") %>% 
  arrange(mean) %>% 
  group_by(outcome) %>% 
  mutate(x_order = 1:n()) %>% 
  select(outcome, country, x_order) %>% 
  ungroup()

p_country <- country_coefs_scaled %>% 
  left_join(tmp) %>% 
  mutate(
    sig = sign(q2.5) == sign(q97.5),
    color = case_when(
      !sig ~ "c",
      sig & sign(mean) == -1 ~ "b",
      sig & sign(mean) == 1 ~ "a"
    )
  ) %>%
  drop_na(mean) %>% 
  ggplot(aes(x_order, mean, col = color)) +
  scale_color_brewer(palette = "Dark2") +
  scale_x_continuous("Country") +
  scale_y_continuous(
    "Estimated linear association (%)"
  ) +
  geom_hline(yintercept = 0, lty = 2, size = .2) +
  geom_linerange(
    data = . %>% filter(country != "World"),
    size = .15,
    aes(ymin = q2.5, ymax = q97.5)
  ) +
  geom_linerange(
    data = . %>% filter(country == "World") %>% mutate(x_order = -10L),
    size = .3, 
    aes(ymin = q2.5, ymax = q97.5)
  ) +
  geom_point(
    data = . %>% filter(country != "World"),
    size = .2
  ) +
  geom_point(
    data = . %>% filter(country == "World") %>% mutate(x_order = -10L),
    size = .75
  ) +
  facet_grid2(
    x~outcome, 
    scales = "free",
    independent = "all",
    labeller = labeller(
      .cols = as_labeller(~str_replace(., "_", " "))
    )
  ) +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    legend.position = "none"
  )
p_country
agg_png(
  "figures/SCA-countries.png",
  width = W, height = W*0.5, units = "in", res = 300
)
p_country
dev.off()
```

```{r}
country_coefs_scaled %>% 
  filter(country != "World") %>% 
  drop_na(mean) %>% 
  transmute(
    Outcome = fct_inorder(str_replace(outcome, "_", " ")),
    Predictor = x,
    country, mean
  ) %>% 
  arrange(Outcome, Predictor, desc(mean)) %>% 
  group_by(Predictor, Outcome) %>% 
  do(rbind(head(., n = 3), tail(., n = 3))) %>% 
  transmute(
    country = str_glue("{country} ({number(mean, .1)})")
  ) %>% 
  mutate(position = c(str_c("Top ", 1:3), str_c("Bottom ", rev(1:3)))) %>% 
  pivot_wider(names_from = position, values_from = country) %>% 
  flextable() %>% 
  flextable::set_caption("Top and bottom 3 countries for each parameter")
```


```{r}
country_coefs_scaled %>% 
  filter(country != "World") %>% 
  drop_na(mean) %>% 
  mutate(
    case = case_when(
      sign(q2.5) == sign(q97.5) & sign(mean) == -1 ~ "Negative",
      sign(q2.5) == sign(q97.5) & sign(mean) == 1 ~ "Positive",
      TRUE ~ "Inconclusive"
    )
  ) %>% 
  mutate(
    case = factor(case, levels = c("Negative", "Inconclusive", "Positive"))
  ) %>% 
  count(x, outcome, case) %>% 
  group_by(x, outcome) %>% 
  mutate(p = percent(n / sum(n), .1)) %>% 
  ungroup() %>% 
  transmute(
    Outcome = fct_inorder(str_replace(outcome, "_", " ")),
    Predictor = x,
    case,
    count = as.character(str_glue("{n} ({p})"))
  ) %>%
  complete(Outcome, Predictor, case, fill = list(count = "0")) %>%
  pivot_wider(names_from = case, values_from = count) %>% 
  flextable() %>% 
  set_caption(
    "Counts of countries with negative, positive, and inconclusive results"
  )
```


This table shows
- Coefficients: change per decade and 10% shift in internet/mobile
- Coefficients: change per decade-equivalent shift in internet/mobile
- Posterior probability of latter being smaller than change per decade

```{r}
# Changes per decade per outcome
change_factors <- country_post %>% 
  select(outcome, summary) %>% 
  unnest(summary) %>% 
  filter(x == "Time", y == "outcome") %>% 
  select(outcome, country, change_per_decade = mean)


# Posterior samples of all effects on outcomes
tab <- country_post %>% 
  select(outcome, samples) %>% 
  unnest(samples) %>% 
  filter(y == "outcome") %>%
  select(-y) %>%
  pivot_longer(-c(outcome, x), names_to = "country") %>% 
  # Drop NAs because some country-outcome combinations don't exist
  drop_na(value)

# Scale internet and mobile to decade-equivalents
scaling_factors %>% 
  filter(country == "World") %>% 
  group_by(y, country) %>% 
  summarise(scaling = mean(scaling))
tab <- tab %>% 
  left_join(
    scaling_factors %>% 
      rename(x = y)
  ) %>% 
  mutate(scaling = if_else(x == "Time", 1, scaling)) %>% 
  mutate(scaled = value * scaling) %>% 
  select(-scaling)

# Change associations with internet and mobile to units of 10% not 100%
tab <- tab %>% 
  mutate(
    value = if_else(x == "Time", value, value / 10)
  )

# Add ROPE limits (change in outcome per decade) and
# compute posterior summaries

# Function to replace extreme percentages
percent2 <- function(x, accuracy = .1) {
  x <- percent(x, accuracy = accuracy)
  x <- if_else(x == "100.0%", ">99.9%", x)
  x <- if_else(x == "0.0%", "<0.1%", x)
  x
}

path <- "models/pub-table.rds"
if (!file.exists(path)) {
  tab <- tab %>% 
    nest(data = c(value, scaled)) %>% 
    left_join(change_factors) %>% 
    mutate(change_per_decade = if_else(x == "Time", 1, change_per_decade)) %>% 
    mutate(
      out = map2(
        data, change_per_decade,
        ~describe_posterior(
          .x, 
          centrality = "mean", 
          ci_method = "eti",
          rope_range = c(-.y, .y), 
          rope_ci = 1
        )
      )
    ) %>% 
    mutate(
      Predictor = fct_inorder(x), 
      Outcome = fct_inorder(str_replace(outcome, "_", " "))
    ) %>% 
    select(Predictor, Outcome, country, out) %>% 
    arrange(Predictor, Outcome) %>% 
    unnest(out) %>% 
    mutate(
      across(c(Mean, CI_low, CI_high), ~number(., .001, trim = TRUE))
    ) %>% 
    mutate(
      pd = percent2(pd, .1),
      ROPE_Percentage = percent2(ROPE_Percentage, .1)
    ) %>% 
    mutate(
      Result = case_when(
        Parameter == "value" ~ 
          str_glue("{Mean} [{CI_low}, {CI_high}] ({pd})"),
        Predictor == "Time" & Parameter == "scaled" ~ "",
        Predictor != "Time" & Parameter != "value" ~ 
          str_glue("{Mean} [{CI_low}, {CI_high}] ({ROPE_Percentage})"),
      )
    ) %>% 
    transmute(
      Predictor,
      Outcome,
      Country = country,
      Parameter,
      Result
    ) %>% 
    select(Predictor, Outcome, Country, Result, Parameter) %>% 
    pivot_wider(names_from = Parameter, values_from = Result) %>% 
    rename(`Raw association` = value, `Scaled association` = scaled)
  saveRDS(tab, path)
} else {tab <- readRDS(path)}

tab %>% 
  filter(Country == "World") %>% 
  select(-Country) %>% 
  flextable(cwidth = c(.8,1.4,2.3,2.3)) %>% 
  autofit() %>% 
  # footnote(
  #   i = 1, 
  #   j = c(3, 4), 
  #   part = "header",
  #   value = as_paragraph(
  #     c(
  #       "Posterior mean, [95%CI], and (posterior probability of direction). Associations are in units of decades (change in outcome (%) as a function of a decade) or 10% (change in outcome as a function of 10% increase in Internet or Mobile).",
  #       "Decade-equivalent posterior mean associations, [95%CI], and (posterior probability outside the region of practical equivalence). Decade-equivalent associations indicate contrasts in the outcome as a function of the extent to which the predictor changed in a decade."
  #     )
  #   ), 
  # ) %>% 
  save_as_docx(path = "figures/parameter-table.docx")
```

## Correlations

Next, we examine how the average levels, and changes in, countries internet adoption and mental health / well-being parameters correlate. That is, we ask whether

- Countries with greater levels of internet adoption on average tend to be those with greater/lesser mental health and well-being?
- Countries where internet adoption increased most tend to be those where mental health / well-being increased/decreased the most?

### OLS

We begin by a look at the ordinary least squares (OLS) estimates, recognizing that this approach is limited by ignoring the noise in the parameters used as data in the analysis.

:::{.panel-tabset}

#### Scatterplot

```{r}
dat <- readRDS("data/data-all.rds")
itu <- readRDS("data/itu.rds")

# Some countries don't have mobile data, enable computation still
pcoef <- possibly(coef, NA)

# Get all regression parameters
ols_itu <- itu %>%
  mutate(year = (year-2010)/10) %>% 
  group_by(country) %>%
  summarise(
    internet_mean = mean(internet, na.rm = TRUE),
    internet_slope = coef(lm(internet ~ year, data = cur_data()))[2],
    mobile_mean = mean(mobile, na.rm = TRUE),
    mobile_slope = pcoef(lm(mobile ~ year, data = cur_data()))[2],
    hdi_mean = mean(hdi, na.rm = TRUE),
    hdi_slope = pcoef(lm(hdi ~ year, data = cur_data()))[2]
  )
ols_val <- dat %>%
  drop_na(val) %>%
  group_by(outcome, country) %>%
  summarise(
    val_mean = mean(val, na.rm = TRUE),
    val_slope = coef(lm(val ~ year, data = cur_data()))[2]
  )

ols <- left_join(ols_itu, ols_val)
ols_internet_mean_plot <- ols %>% 
  ggplot(aes(internet_mean, val_mean)) +
  scale_x_continuous(
    breaks = extended_breaks(),
    labels = ~percent(., 01)
  ) +
  scale_y_continuous(
    breaks = extended_breaks(),
    labels = ~percent(./100, .01)
  ) +
  geom_point(aes(text = country), size = .75, shape = 1) +
  geom_smooth(method = "lm", size = .5) +
  labs(
    x = "Mean internet users per capita",
    y = "Mean outcome"
  ) +
  facet_wrap(
    "outcome", 
    scales = "free", 
    nrow = 1, 
    labeller = as_labeller(~str_replace(., "_", " "))
  ) +
  theme(aspect.ratio = 1)

ols_mobile_mean_plot <- ols_internet_mean_plot +
  aes(mobile_mean, val_mean) +
  labs(
    x = "Mean mobile broadband subscriptions per capita",
    y = "Mean outcome"
  )

ols_internet_slope_plot <- ols_internet_mean_plot + 
  aes(internet_slope, val_slope) +
  labs(
    x = "Change per decade in internet users per capita",
    y = "Change in outcome"
  )

ols_mobile_slope_plot <- ols_internet_mean_plot + 
  aes(mobile_slope, val_slope) +
  labs(
    x = "Change per decade in mobile broadband subscriptions per capita",
    y = "Change in outcome"
  )

ols_internet_mean_plot /
  ols_internet_slope_plot /
  ols_mobile_mean_plot /
  ols_mobile_slope_plot

# (ols_internet_mean_plot /
#   ols_internet_slope_plot /
#   ols_mobile_mean_plot /
#   ols_mobile_slope_plot) & stat_ellipse()
```

#### Interactive scatterplot

```{r}
p1 <- ggplotly(ols_internet_mean_plot, tooltip = "text") %>% 
  layout(
    margin = list(t = 40, r = 20, b = 60, l = 30)
  )
p2 <- ggplotly(ols_internet_slope_plot) %>% 
  layout(
    margin = list(t = 40, r = 20, b = 60, l = 30)
  )
p3 <- ggplotly(ols_mobile_mean_plot) %>% 
  layout(
    margin = list(t = 40, r = 20, b = 60, l = 30)
  )
p4 <- ggplotly(ols_mobile_slope_plot) %>% 
  layout(
    margin = list(t = 40, r = 20, b = 60, l = 30)
  )
subplot(
  p1, p2, p3, p4, 
  nrows = 4, 
  shareX = FALSE, 
  shareY = FALSE, 
  titleX = TRUE,
  margin = 0.05
)
```

:::

### Model based

#### Correlation parameters

```{r}
get_cor_pars <- function(outcome, predictor, model) {
  x <- readRDS(str_glue("models-small/brm-{outcome}-{model}.rds"))
  as_draws_df(
    x,
    variable = c(
      str_glue("b_{predictor}_Intercept"),
      "b_val_Intercept",
      str_glue("b_{predictor}_year"),
      "b_val_year",
      str_glue("sd_country__{predictor}_Intercept"),
      "sd_country__val_Intercept",
      str_glue("sd_country__{predictor}_year"),
      "sd_country__val_year",
      str_glue("cor_country__{predictor}_year__val_year"),
      str_glue("cor_country__{predictor}_Intercept__val_Intercept")
    )
  )
}
get_cor_pars <- memoise(get_cor_pars, cache = cd)

cor_pars_brm <- fits %>%
  mutate(
    internet = map(outcome, ~get_cor_pars(.x, "internet", "1")),
    mobile = map(outcome, ~get_cor_pars(.x, "mobile", "2"))
  )

cor_sum <- cor_pars_brm %>% 
  mutate(
    across(
      internet:mobile, 
      ~map(., ~summarise_draws(., mean, ~quantile2(., probs = c(.025, .975))))
    )
  )
cor_sum %>% 
  pivot_longer(-outcome, names_to = "predictor") %>% 
  unnest(value) %>% 
  filter(str_detect(variable, "cor_")) %>% 
  mutate(
    across(mean:q97.5, ~number(., .01))
  ) %>% 
  transmute(
    Outcome = str_replace(outcome, "_", " "),
    Predictor = str_to_title(predictor),
    Correlation = if_else(str_detect(variable, "Intercept"), "Averages", "Slopes"),
    Summary = str_glue("{mean} [{q2.5}, {q97.5}]")
  ) %>% 
  pivot_wider(names_from = Predictor, values_from = Summary) %>% 
  mutate(Outcome = factor(Outcome, levels = str_replace(oo, "_", " "))) %>% 
  arrange(Correlation, Outcome) %>% 
  kbl(caption = "Correlation parameters") %>% 
  kable_custom()
```

::: {.panel-tabset .column-body-outset-right}

#### Scatterplot

```{r}
#| fig.width: 10
#| fig.height: 8
mcoef <- memoise(brms:::coef.brmsfit, cache = cd)
country_pars <- fits %>% 
  mutate(
    internet = map(
      outcome,
      ~mcoef(readRDS(str_glue("models/brm-{.x}-1.rds")))$country %>% 
        as.data.frame.array() %>% 
        rownames_to_column("country")
    ),
    mobile = map(
      outcome,
      ~mcoef(readRDS(str_glue("models/brm-{.x}-2.rds")))$country %>% 
        as.data.frame.array() %>% 
        rownames_to_column("country")
    )
  )

c1 <- country_pars %>% 
  select(outcome, internet) %>% 
  unnest(internet) %>% 
  transmute(
    outcome, country,
    internet_intercept = Estimate.internet_Intercept,
    internet_slope = Estimate.internet_year,
    val_intercept = Estimate.val_Intercept,
    val_slope = Estimate.val_year
  )
c2 <- country_pars %>% 
  select(outcome, mobile) %>% 
  unnest(mobile) %>% 
  transmute(
    outcome, country,
    mobile_intercept = Estimate.mobile_Intercept,
    mobile_slope = Estimate.mobile_year,
    val2_intercept = Estimate.val_Intercept,
    val2_slope = Estimate.val_year
  )

brm_internet_intercept_plot <- left_join(c1, c2) %>% 
  ggplot(aes(internet_intercept, val_intercept)) +
  scale_x_continuous(
    breaks = extended_breaks(),
    labels = ~percent(., 01)
  ) +
  scale_y_continuous(
    breaks = extended_breaks(),
    labels = ~percent(./100, .1)
  ) +
  geom_point(
    aes(text = country), 
    col = "dodgerblue1", size = .75, shape = 1) +
  labs(
    x = "Average internet users per capita",
    y = "Average outcome"
  ) +
  facet_wrap(
    "outcome", 
    scales = "free", 
    nrow = 1, 
    labeller = as_labeller(~str_replace(., "_", " "))
  ) +
  theme(aspect.ratio = 1)

brm_mobile_intercept_plot <- brm_internet_intercept_plot +
  aes(mobile_intercept, val2_intercept) +
  labs(
    x = "Average mobile broadband subscriptions per capita",
    y = "Average outcome"
  )

brm_internet_slope_plot <- brm_internet_intercept_plot + 
  aes(internet_slope, val_slope) +
  labs(
    x = "Change in internet users per capita",
    y = "Change in outcome"
  )

brm_mobile_slope_plot <- brm_internet_intercept_plot + 
  aes(mobile_slope, val_slope) +
  labs(
    x = "Change in mobile broadband subscriptions per capita",
    y = "Change in outcome"
  )

brm_internet_intercept_plot /
  brm_internet_slope_plot /
  brm_mobile_intercept_plot /
  brm_mobile_slope_plot
```

## Publication figures

Here we combine and further edit the figures from above to a format for publication.

:::{.panel-tabset}

### Timecourses

```{r}
#| fig.width: 10
#| fig.height: 8
pa <- country_year_plot +
  facet_wrap(
    "outcome", 
    nrow = 1, 
    scales = "free",
    labeller = as_labeller(~str_replace(., "_", " "))
  ) +
  theme(axis.title.x = element_blank())
pb <- sex_year_plot +
  facet_wrap(
    "outcome", 
    nrow = 1, 
    scales = "free_x",
    labeller = as_labeller(~str_replace(., "_", " "))
  )
pc <- pa / pb +
  plot_annotation(tag_levels = "A") +
  plot_layout(heights = c(5.5, 4.5)) &
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90)
  )
pc
```

```{r include = FALSE}
agg_png(
  "figures/Parameters-timecourses.png",
  width = W, height = W*0.55, units = "in", res = 300
)
pc
dev.off()
```


### Internet associations

```{r}
#| fig.width: 10
#| fig.height: 8
pa <- country_internet_plot +
  facet_wrap(
    "outcome", 
    nrow = 1, 
    scales = "free",
    labeller = as_labeller(~str_replace(., "_", " "))
  ) +
  theme(axis.title.x = element_blank())
pb <- sex_internet_plot +
  facet_wrap(
    "outcome", 
    nrow = 1, 
    scales = "free_x",
    labeller = as_labeller(~str_replace(., "_", " "))
  ) +
  theme(legend.position = "none")
pc <- pa / pb +
  plot_annotation(tag_levels = "A") +
  plot_layout(heights = c(5.5, 4.5)) &
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90)
  )
pc
```

```{r include = FALSE}
agg_png(
  "figures/Parameters-associations-internet.png",
  width = W, height = W*0.55, units = "in", res = 300
)
pc
dev.off()
```

### Mobile associations

```{r}
#| fig.width: 10
#| fig.height: 8
pa <- country_mobile_plot +
  facet_wrap(
    "outcome", 
    nrow = 1, 
    scales = "free",
    labeller = as_labeller(~str_replace(., "_", " "))
  ) +
  theme(axis.title.x = element_blank())
pb <- sex_mobile_plot +
  facet_wrap(
    "outcome", 
    nrow = 1, 
    scales = "free_x",
    labeller = as_labeller(~str_replace(., "_", " "))
  ) +
  theme(legend.position = "none")
pc <- pa / pb +
  plot_annotation(tag_levels = "A") +
  plot_layout(heights = c(5.5, 4.5)) &
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 90)
  )
pc
```

```{r include = FALSE}
agg_png(
  "figures/Parameters-associations-mobile.png",
  width = W, height = W*0.55, units = "in", res = 300
)
pc
dev.off()
```

### Correlations

```{r}
#| fig.width: 10
#| fig.height: 8
library(ellipse)
# This is hairy because of two different internet metrics
ellipses <- cor_pars_brm %>% 
  pivot_longer(-outcome) %>% 
  unnest(value) %>% 
  group_by(outcome, name) %>% 
  slice_sample(n = 30) %>% 
  select(
    # Intercept parameters
    i_int_mu = b_internet_Intercept,
    i_int_sd = sd_country__internet_Intercept,
    i_val_mu = b_val_Intercept,
    i_val_sd = sd_country__val_Intercept,
    i_pxy = cor_country__internet_Intercept__val_Intercept,
    i_mob_mu = b_mobile_Intercept,
    i_mob_sd = sd_country__mobile_Intercept,
    i_pxy2 = cor_country__mobile_Intercept__val_Intercept,
    # Slope parameters
    s_int_mu = b_internet_year,
    s_int_sd = sd_country__internet_year,
    s_val_mu = b_val_year,
    s_val_sd = sd_country__val_year,
    s_pxy = cor_country__internet_year__val_year,
    s_mob_mu = b_mobile_year,
    s_mob_sd = sd_country__mobile_year,
    s_pxy2 = cor_country__mobile_year__val_year,
    .draw
  ) %>%
  mutate(
    i_int_mu = coalesce(i_int_mu, i_mob_mu),
    i_int_sd = coalesce(i_int_sd, i_mob_sd),
    i_pxy = coalesce(i_pxy, i_pxy2),
    s_int_mu = coalesce(s_int_mu, s_mob_mu),
    s_int_sd = coalesce(s_int_sd, s_mob_sd),
    s_pxy = coalesce(s_pxy, s_pxy2)
  ) %>% 
  mutate(
    ellipse_intercept = pmap(
      list(i_pxy, i_int_sd, i_val_sd, i_int_mu, i_val_mu),
      ~ellipse(..1, scale = c(..2, ..3), centre = c(..4, ..5)) %>% 
        as_tibble()
    ),
    ellipse_slope = pmap(
      list(s_pxy, s_int_sd, s_val_sd, s_int_mu, s_val_mu),
      ~ellipse(..1, scale = c(..2, ..3), centre = c(..4, ..5)) %>% 
        as_tibble()
    )
  )

p1 <- brm_internet_intercept_plot +
  geom_path(
    data = filter(ellipses, name == "internet") %>% unnest(ellipse_intercept),
    aes(x, y, group = .draw), color = "dodgerblue1", alpha = .05
  )
p2 <- brm_internet_slope_plot +
  geom_path(
    data = filter(ellipses, name == "internet") %>% unnest(ellipse_slope),
    aes(x, y, group = .draw), color = "dodgerblue1", alpha = .05
  )
p3 <- brm_mobile_intercept_plot +
  geom_path(
    data = filter(ellipses, name == "mobile") %>% unnest(ellipse_intercept),
    aes(x, y, group = .draw), color = "dodgerblue1", alpha = .05
  )
p4 <- brm_mobile_slope_plot +
  geom_path(
    data = filter(ellipses, name == "mobile") %>% unnest(ellipse_slope),
    aes(x, y, group = .draw), color = "dodgerblue1", alpha = .05
  ) +
  coord_cartesian(xlim = c(-.2, 1.8))
pc <- p1 / p2 / p3 / p4 +
  plot_annotation(tag_levels = "A")
```

```{r include = FALSE}
agg_png(
  "figures/Correlations.png",
  width = W, height = W*0.8, units = "in", res = 300
)
pc
dev.off()
```

:::

## SCA

### OLS {.panel-tabset}

First we draw figures from OLS regressions of `outcome ~ time + predictor`. We draw parameter estimates `b_time` and `b_predictor` for every combination of country, year, and sex, for each outcome and predictor (internet/mobile).

#### Well-being

```{r}
if (!file.exists("tmp.rds")) {
  library(multidplyr)
  library(tictoc)
  pfilter <- possibly(dplyr::filter, NA)
  cluster <- new_cluster(8)
  cluster_library(cluster, c("tidyverse", "broom"))
  cluster_copy(cluster, "pfilter")
  tic()
  out <- dat %>% 
    # Limit to aggregates with 10 or more people (or MH model estimates)
    filter(n > 9 | is.na(n)) %>% 
    select(outcome, country, sex, age, val, year, i1_cw, m1_cw) %>% 
    pivot_longer(i1_cw:m1_cw, names_to = "predictor", values_to = "x") %>% 
    group_by(outcome, predictor, country, sex, age) %>% 
    mutate(z = cur_group_id()) %>% 
    nest(data = c(val, x, year)) %>% 
    mutate(n = map_dbl(data, nrow)) %>% 
    arrange(n) %>% 
    # Limit to specs for which 5 or more years existed
    filter(n > 4) %>%
    partition(cluster) %>%
    mutate(
      out = map(
        data,
        ~pfilter(
          tidy(
            lm(val ~ x + year, data = .x), 
            conf.int = TRUE
          ), 
          term %in% c("x", "year")
        )
      )
    ) %>% 
    collect()
  toc()
  saveRDS(out, "tmp.rds")
} else {out <- readRDS("tmp.rds")}

# Wrangle
tmp <- out %>% 
  select(-data, -n) %>% 
  unnest(out) %>% 
  # Create three predictors: year, internet, mobile
  ungroup() %>% 
  filter(!(predictor == "m1_cw" & term == "year")) %>% 
  mutate(
    predictor = case_when(
      predictor == "i1_cw" & term == "x" ~ "Internet",
      predictor == "m1_cw" & term == "x" ~ "Mobile",
      predictor == "i1_cw" & term == "year" ~ "Time"
    )
  ) %>% 
  group_by(predictor, outcome) %>% 
  arrange(predictor, outcome, estimate) %>% 
  mutate(n = 1:n()) %>% 
  mutate(
    sig = p.value < .05,
    color = case_when(
      !sig ~ "a",
      sig & sign(estimate) == -1 ~ "b",
      sig & sign(estimate) == 1 ~ "c"
    )
  ) 

tmp <- tmp %>% 
  rename(X = predictor, Sex = sex, Age = age)

tmp <- drop_na(tmp, X)

# Rescale to "decade-equivalent dose"
tmp <- tmp %>% 
  left_join(select(ols_itu, country, internet_slope, mobile_slope)) %>% 
  mutate(
    across(
      c(estimate, std.error, conf.low, conf.high), 
      ~case_when(
        X == "Time" ~ .,
        X == "Internet" ~ . * abs(internet_slope),
        X == "Mobile" ~ . * abs(mobile_slope)
      )
    )
  )

# Arrange data for X axis
tmp <- tmp %>% 
  ungroup() %>% 
  select(-c(z, term, std.error, statistic, ends_with("slope"))) %>% 
  group_by(outcome, X) %>% 
  arrange(outcome, X, estimate) %>% 
  mutate(n = 1:n())

sca_plot <- function(outcome, ylim = 50) {
  data <- filter(tmp, outcome == {{outcome}})
  
  p0 <- data %>%   
    ggplot(
      aes(
        x = n, y = estimate, col = color,
        text = str_glue("{country}, {Sex}, {Age}")
      )
    ) +
    scale_color_manual(
      values = c("grey75", "#CC3311", "#009988")
    ) +
    theme(
      legend.position = "none"
    )
  
  p1 <- p0 +  
    scale_y_continuous(
      "Estimate",
      breaks = extended_breaks(),
      labels = ~percent(./100)
    ) +
    geom_hline(yintercept = 0, lty = 2, size = .1) +
    # geom_linerange(
    #   aes(ymin = conf.low, ymax = conf.high),
    #   size = .025
    # ) +
    geom_point(
      data = filter(p0$data, color == "a"), 
      size = .275, alpha = .75
    ) +
    geom_point(
      data = filter(p0$data, color == "b"), 
      size = .275, alpha = .75
    ) +
    geom_point(
      data = filter(p0$data, color == "c"), 
      size = .275, alpha = .75
    ) +
    coord_cartesian(ylim = c(-ylim, ylim)) +
    facet_grid(
      rows = vars(X), 
      cols = vars(outcome), 
      labeller = as_labeller(~str_replace(., "_", " "))
    ) +
    theme(
      plot.margin = unit(c(4,4,2,4), "pt"),
      axis.title.x = element_blank()
    )
  
  p2 <- p0 + 
    scale_y_discrete() +
    aes(n, X, col = color) +
    geom_point(shape = "|") +
    # facet_grid(rows = "1", labeller = as_labeller(~"Sex")) +
    theme(
      axis.text.x = element_blank(),
      axis.ticks.x = element_blank(),
      plot.margin = unit(c(0,0,0,0), "pt"),
      strip.background = element_blank()
    )
  
  p3 <- p0 + 
    scale_y_discrete() +
    aes(n, Sex, col = color) +
    geom_point(
      size = .1,
      position = position_jitter(0, .3)
    ) +
    theme(
      axis.text.x = element_blank(),
      axis.ticks.x = element_blank(),
      plot.margin = unit(c(0,0,0,0), "pt"),
      strip.background = element_blank()
    )
  
  p4 <- p0 + 
    aes(n, Age, col = color) +
    geom_point(
      size = .15, shape = 20,
      position = position_jitter(0, .3)
    ) +
    theme(
      axis.text.x = element_blank(),
      axis.ticks.x = element_blank()
    ) + 
    scale_y_discrete(limits = rev) +
    labs(x = "Specification") +
    theme(plot.margin = unit(c(0,0,6,0), "pt"))
  (p1 / p3 / p4) +
    plot_layout(heights = c(6.5, 0.4, 2.5))
}
p1 <- oo[1:3] %>% 
  map(~sca_plot(.))
wrap_plots(p1[[1]], p1[[2]], p1[[3]])
```

#### Well-being interactive

```{r}
subplot(
  ggplotly(p1[[1]][[1]], tooltip = "text"),
  ggplotly(p1[[2]][[1]], tooltip = "text"),
  ggplotly(p1[[3]][[1]], tooltip = "text"),
  ggplotly(p1[[1]][[2]], tooltip = "text"), 
  ggplotly(p1[[2]][[2]], tooltip = "text"), 
  ggplotly(p1[[3]][[2]], tooltip = "text"), 
  ggplotly(p1[[1]][[3]], tooltip = "text"), 
  ggplotly(p1[[2]][[3]], tooltip = "text"), 
  ggplotly(p1[[3]][[3]], tooltip = "text"), 
  nrows = 3, 
  heights = c(0.6, 0.1, 0.3), 
  titleX = TRUE, shareX = TRUE
) %>% 
  layout(
    margin = list(t = 30, r = 30, b = 30, l = 30)
  )
```


#### Mental health

```{r}
p2 <- oo[4:5] %>% 
  map(~sca_plot(., 1))
p2[[3]] <- sca_plot(oo[6], .1)
wrap_plots(p2[[1]], p2[[2]], p2[[3]])
```

#### Mental health interactive

```{r}
subplot(
  ggplotly(p2[[1]][[1]], tooltip = "text"),
  ggplotly(p2[[2]][[1]], tooltip = "text"),
  ggplotly(p2[[3]][[1]], tooltip = "text"),
  ggplotly(p2[[1]][[2]], tooltip = "text"), 
  ggplotly(p2[[2]][[2]], tooltip = "text"), 
  ggplotly(p2[[3]][[2]], tooltip = "text"), 
  ggplotly(p2[[1]][[3]], tooltip = "text"), 
  ggplotly(p2[[2]][[3]], tooltip = "text"), 
  ggplotly(p2[[3]][[3]], tooltip = "text"), 
  nrows = 3, 
  heights = c(0.6, 0.1, 0.3), 
  titleX = TRUE, shareX = TRUE
) %>% 
  layout(
    margin = list(t = 30, r = 30, b = 30, l = 30)
  )
```

:::

### Model based

OLS estimates are very noisy and lead to implausibly large values and issues with multiple comparisons. Therefore a more accurate image is drawn from the models' estimates of country-, age-, and sex-specific estimates. Calculating these takes up to 20 minutes, 

```{r}
# Function to get country-sex-age estimates of time, internet and mobile effects for each outcome

get_coefs <- function(outcome) {
  if (!file.exists(str_glue("memoise_cache/{outcome}-sca-coefs.rds"))) {
    # Load three fits for outcome
    fit_1 <- readRDS(str_glue("models/brm-{outcome}-1.rds"))
    fit_3 <- readRDS(str_glue("models/brm-{outcome}-3.rds"))
    fit_4 <- readRDS(str_glue("models/brm-{outcome}-4.rds"))
    
    # Calculate time, internet, and mobile effects
    # for each country, sex, and age
    y_time <- tibble(fit_1$data) %>% 
      distinct(country, sex, age) %>% 
      mutate(se = 0, val = 0) %>% 
      mutate(min = -0.5, max = 0.5) %>% 
      pivot_longer(c(min, max), values_to = "year") %>% 
      add_epred_draws(fit_1, ndraws = 200, resp = "val") %>% 
      ungroup() %>% 
      select(country, sex, age, name, .epred) %>% 
      group_by(country, sex, age) %>%
      summarise(.epred = .epred[name=="max"] - .epred[name=="min"]) %>% 
      mean_qi()
    
    # Internet slopes ("decade-equivalent") from model 3
    y_internet <- tibble(fit_3$data) %>% 
      distinct(country, sex, age) %>% 
      left_join(distinct(itu, country, i1_cb)) %>% 
      left_join(distinct(ols_itu, country, internet_slope)) %>% 
      mutate(year = 0, se = 0) %>% 
      mutate(min = -internet_slope/2, max = internet_slope/2) %>% 
      pivot_longer(c(min, max), values_to = "i1_cw") %>% 
      add_epred_draws(fit_3, ndraws = 200, resp = "val") %>% 
      ungroup() %>% 
      select(country, sex, age, name, .epred) %>% 
      group_by(country, sex, age) %>%
      summarise(.epred = .epred[name=="max"] - .epred[name=="min"]) %>% 
      mean_qi()
    
    y_mobile <- tibble(fit_4$data) %>% 
      distinct(country, sex, age) %>% 
      left_join(distinct(itu, country, m1_cb)) %>% 
      left_join(distinct(ols_itu, country, mobile_slope)) %>% 
      mutate(year = 0, se = 0) %>% 
      mutate(min = -mobile_slope/2, max = mobile_slope/2) %>% 
      pivot_longer(c(min, max), values_to = "m1_cw") %>% 
      add_epred_draws(fit_4, ndraws = 200, resp = "val") %>% 
      ungroup() %>% 
      select(country, sex, age, name, .epred) %>% 
      group_by(country, sex, age) %>%
      summarise(.epred = .epred[name=="max"] - .epred[name=="min"]) %>% 
      mean_qi()
    
    y_all <- bind_rows(
      "Time" = y_time,
      "Internet" = y_internet,
      "Mobile" = y_mobile,
      .id = "predictor"
    )
    saveRDS(y_all, str_glue("memoise_cache/{outcome}-sca-coefs.rds"))
  } else {y_all <- readRDS(str_glue("memoise_cache/{outcome}-sca-coefs.rds"))}
  y_all
}

coefs <- tibble(
  outcome = factor(oo, levels = oo)
) %>% 
  group_by(outcome) %>% 
  mutate(out = map(outcome, get_coefs))
```

```{r}
# Wrangle
tmp <- coefs %>% 
  unnest(out) %>% 
  mutate(
    sig = sign(.lower) == sign(.upper),
    color = case_when(
      !sig ~ "a",
      sig & sign(.epred) == -1 ~ "b",
      sig & sign(.epred) == 1 ~ "c"
    )
  ) %>% 
  rename(X = predictor, Sex = sex, Age = age) %>% 
  # Rescale to "decade-equivalent dose"
  left_join(select(ols_itu, country, internet_slope, mobile_slope)) %>% 
  mutate(
    across(
      c(.epred, .lower, .upper), 
      ~case_when(
        X == "Time" ~ .,
        X == "Internet" ~ . * abs(internet_slope),
        X == "Mobile" ~ . * abs(mobile_slope)
      )
    )
  ) %>% 
  # Arrange data for X axis
  ungroup() %>% 
  select(-c(.width, .point, .interval, ends_with("slope"))) %>% 
  group_by(outcome, X) %>% 
  arrange(outcome, X, .epred) %>% 
  mutate(n = 1:n()) %>% 
  mutate(X = factor(X, levels = c("Time", "Internet", "Mobile")))

# We also display the world averages
tmp_world_scaling <- select(ols_itu, country, internet_slope, mobile_slope) %>% 
  summarise(
    internet_slope = mean(internet_slope, na.rm = TRUE),
    mobile_slope = mean(mobile_slope, na.rm = TRUE)
  )
tmp_world <- bind_rows(
  "Time" = country_year_coefs,
  "Internet" = country_internet_coefs,
  "Mobile" = country_mobile_coefs,
  .id = "X"
) %>% 
  filter(country == "World") %>% 
  transmute(
    X, outcome, .epred = mean, .lower = q2.5, .upper = q97.5
  ) %>% 
  mutate(
    sig = sign(.lower) == sign(.upper),
    color = case_when(
      !sig ~ "a",
      sig & sign(.epred) == -1 ~ "b",
      sig & sign(.epred) == 1 ~ "c"
    )
  ) %>% 
  # Rescale to "decade-equivalent dose"
  bind_cols(tmp_world_scaling) %>% 
  mutate(
    across(
      c(.epred, .lower, .upper), 
      ~case_when(
        X == "Time" ~ .,
        X == "Internet" ~ . * abs(internet_slope),
        X == "Mobile" ~ . * abs(mobile_slope)
      )
    )
  ) %>% 
  mutate(X = factor(X, levels = c("Time", "Internet", "Mobile")))
```


```{r}
sca_plot <- function(outcome, ylim = 25) {
  data <- filter(tmp, outcome == {{outcome}})
  
  avg_n <- data %>% 
    group_by(X) %>% 
    summarise(n = median(n))
  
  avg <- filter(tmp_world, outcome == {{outcome}}) %>% 
    mutate(n = -50)
  
  p0 <- data %>%   
    ggplot(
      aes(
        x = n, y = .epred, col = color, group = interaction(X, color),
        text = str_glue("{country}, {Sex}, {Age}")
      )
    ) +
    scale_color_manual(
      values = c("grey80", "#CC3311", "#009988")
    ) +
    theme(
      legend.position = "none"
    )
  
  p1 <- p0 +  
    scale_y_continuous(
      "Estimate",
      breaks = extended_breaks(7),
      labels = ~percent(./100)
    ) +
    geom_hline(yintercept = 0, lty = 2, size = .1) +
    geom_linerange(
      aes(ymin = .lower, ymax = .upper),
      size = .025
    ) +
    geom_point(
      data = filter(p0$data, color == "a"), 
      size = .001, alpha = .5
    ) +
    geom_point(
      data = filter(p0$data, color == "b"), 
      size = .001, alpha = .5
    ) +
    geom_point(
      data = filter(p0$data, color == "c"), 
      size = .001, alpha = .5
    ) +
    coord_cartesian(ylim = c(-ylim, ylim)) +
    facet_grid(
      rows = vars(X),
      cols = vars(outcome),
      labeller = as_labeller(~str_replace(., "_", " "))
    ) +
    theme(
      panel.grid.major.y = element_line(size = .1, color = "grey90"),
      plot.margin = unit(c(4,4,2,4), "pt"),
      axis.title.x = element_blank()
    ) +
    geom_pointrange(
      data = avg,
      aes(
        ymin = .lower, 
        ymax = .upper,
        text = str_glue("World: {number(.epred, .1)} [{number(.lower, .1)}, {number(.upper, .1)}]")
      ),
      fatten = 0.75, size = .2, 
    )

  p2 <- p0 + 
    scale_y_discrete() +
    aes(n, X, col = color) +
    geom_point(
      size = .01, alpha = .25,
      position = position_jitter(0, .35)
    ) +
    theme(
      axis.text.x = element_blank(),
      axis.title.x = element_blank(),
      axis.ticks.x = element_blank(),
      plot.margin = unit(c(0,0,0,0), "pt"),
      strip.background = element_blank(),
      axis.text.y = element_text(size = rel(0.75))
    )
  
  p3 <- p0 + 
    scale_y_discrete() +
    aes(n, Sex, col = color) +
    geom_point(
      size = .01, alpha = .25,
      position = position_jitter(0, .35)
    ) +
    theme(
      axis.text.x = element_blank(),
      axis.title.x = element_blank(),
      axis.ticks.x = element_blank(),
      plot.margin = unit(c(0,0,0,0), "pt"),
      strip.background = element_blank(),
      axis.text.y = element_text(size = rel(0.75))
    )
  
  p4 <- p0 + 
    aes(n, Age, col = color) +
    geom_point(
      size = .01, alpha = .25,
      position = position_jitter(0, .35)
    ) +
    theme(
      axis.text.x = element_blank(),
      axis.ticks.x = element_blank()
    ) + 
    scale_y_discrete(limits = rev) +
    labs(x = "Specification") +
    theme(
      plot.margin = unit(c(0,0,6,0), "pt"),
      axis.text.y = element_text(size = rel(0.75))
    )
  (p1 / p2 / p3 / p4) +
    plot_layout(heights = c(7.4, 0.5, 0.3, 1.8))
}
```

#### Well-being

```{r}
p1 <- oo[1:3] %>% 
  map(~sca_plot(.))
p1p <- wrap_plots(
  (p1[[1]] & theme(axis.title.x = element_blank())), 
  (p1[[2]] & theme(axis.title.y = element_blank())), 
  (p1[[3]] & theme(axis.title = element_blank()))
  )
p1p
```

```{r include = FALSE}
agg_png(
  "figures/SCA-wellbeing-(model).png",
  width = W, height = W*0.6, units = "in", res = 300
)
p1p
dev.off()
```

#### Well-being interactive

```{r}
subplot(
  ggplotly(p1p[[1]][[1]], tooltip = "text"),
  ggplotly(p1p[[2]][[1]], tooltip = "text"),
  ggplotly(p1p[[3]][[1]], tooltip = "text"),
  ggplotly(p1p[[1]][[2]], tooltip = "text"), 
  ggplotly(p1p[[2]][[2]], tooltip = "text"), 
  ggplotly(p1p[[3]][[2]], tooltip = "text"), 
  ggplotly(p1p[[1]][[3]], tooltip = "text"), 
  ggplotly(p1p[[2]][[3]], tooltip = "text"), 
  ggplotly(p1p[[3]][[3]], tooltip = "text"), 
  ggplotly(p1p[[1]][[4]], tooltip = "text"), 
  ggplotly(p1p[[2]][[4]], tooltip = "text"), 
  ggplotly(p1p[[3]][[4]], tooltip = "text"), 
  nrows = 4, 
  heights = c(0.65, 0.06, 0.04, 0.25), 
  titleX = TRUE, shareX = TRUE
) %>% 
  layout(
    margin = list(t = 30, r = 30, b = 30, l = 30)
  )
```

#### Mental health

```{r}
p2 <- oo[4:5] %>% 
  map(~sca_plot(., .5))
p2[[3]] <- sca_plot(oo[6], .08)
p2p <- wrap_plots(p2[[1]], p2[[2]], p2[[3]])
p2p
```

```{r include = FALSE}
agg_png(
  "figures/SCA-mentalhealth-(model).png",
  width = W, height = W*0.7, units = "in", res = 300
)
p2p
dev.off()
```

```{r}
# Compare magnitudes of internet & mobile & time
# It is critical that internet & mobile are appropriately scaled
# That's why we use the "decade-equivalent" values
# To do this properly we should do it one the samples not just means
coefs %>% 
  unnest(out) %>% 
  select(-c(.width, .point, .interval)) %>% 
  pivot_wider(
    names_from = predictor,
    values_from = starts_with(".")
  ) %>% 
  transmute(
    outcome, country, sex, age,
    internet = .epred_Internet / .epred_Time
  ) %>% 
  ggplot(aes(internet)) +
  geom_histogram() +
  scale_x_continuous(limits = c(-10, 10)) +
  facet_wrap("outcome")
```


```{r}
out <- z %>% 
  ungroup() %>% 
  select(country, sex, age, name, .epred) %>% 
  group_by(country, sex, age) %>%
  summarise(.epred = .epred[name=="max"] - .epred[name=="min"]) %>% 
  mean_qi()
# install.packages("specr")
# library(specr)
out <- out %>% 
  arrange(.epred) %>% 
  mutate(n = 1:n()) %>% 
  mutate(
    sig = sign(.lower) == sign(.upper),
    x = case_when(
      sig & sign(.epred) == -1 ~ "a",
      !sig ~ "b",
      sig & sign(.epred) == 1 ~ "c"
    )
  ) 
p_t <- out %>%   
  ggplot(aes(x = n, y = .epred, col = x)) +
  scale_color_manual(
    values = c("tomato2", "grey50", "dodgerblue2")
  ) +
  theme(
    axis.title.x = element_blank(),
    legend.position = "none"
  )
p1 <- p_t +  
  scale_y_continuous(
    "Estimate",
    breaks = extended_breaks(),
    labels = ~percent(./100)
  ) +
  scale_x_continuous(position = "top") +
  geom_hline(yintercept = 0, lty = 2, size = .1) +
  geom_linerange(
    aes(ymin = .lower, ymax = .upper),
    size = .025
  ) +
  geom_point(size = .025) +
  theme(plot.margin = unit(c(4,4,2,4), "pt"))

p2 <- p_t + 
  aes(n, sex, col = x) +
  geom_point(shape = "|") +
  facet_grid(rows = "1", labeller = as_labeller(~"Sex")) +
  theme(
    axis.title = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    plot.margin = unit(c(0,0,0,0), "pt")
  )

p3 <- p_t + 
  aes(n, age, col = x) +
  geom_point(shape = "|") +
  facet_grid(rows = "1", labeller = as_labeller(~"Age")) +
  theme(
    axis.title = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank()
  ) + 
  scale_y_discrete(limits = rev) +
  theme(plot.margin = unit(c(0,0,0,0), "pt"))
(p1 / p2 / p3) +
  plot_layout(heights = c(6.3, 0.4, 3.3))
```

## New figure 3

```{r}
this_name <- function(outcome) {
  
  fit_time <- readRDS(str_glue("models-small/brm-{outcome}-1.rds"))
  fit_internet <- readRDS(str_glue("models-small/brm-{outcome}-3.rds"))
  fit_mobile <- readRDS(str_glue("models-small/brm-{outcome}-4.rds"))
  
  y_time <- spread_draws(
    fit_time, 
    b_val_year, `b_val_year:sex1`, r_age__val[age, term] | term
  ) %>% 
    ungroup() %>% 
    mutate(
      World_Female = b_val_year + `b_val_year:sex1`*1,
      World_Male = b_val_year + `b_val_year:sex1`*-1,
      Age_Female = b_val_year + year + (`b_val_year:sex1` + `year:sex1`)*1,
      Age_Male = b_val_year + year + (`b_val_year:sex1` + `year:sex1`)*-1
    ) %>% 
    select(.draw, age, starts_with("World_"), starts_with("Age_")) %>% 
    pivot_wider(names_from = age, values_from = starts_with("Age_")) %>% 
    pivot_longer(-.draw, names_to = "Variable") %>% 
    separate(Variable, into = c("Level", "Sex", "Age"), sep = "_") %>% 
    mutate(Age = str_replace_all(Age, "\\.", " "))
  
  y_internet <- spread_draws(
    fit_internet, 
    b_i1_cw, `b_i1_cw:sex1`, r_age[age, term] | term
  ) %>% 
    ungroup() %>% 
    mutate(
      World_Female = b_i1_cw + `b_i1_cw:sex1`*1,
      World_Male = b_i1_cw + `b_i1_cw:sex1`*-1,
      Age_Female = b_i1_cw + i1_cw + (`b_i1_cw:sex1` + `i1_cw:sex1`)*1,
      Age_Male = b_i1_cw + i1_cw + (`b_i1_cw:sex1` + `i1_cw:sex1`)*-1
    ) %>% 
    select(.draw, age, starts_with("World_"), starts_with("Age_")) %>% 
    pivot_wider(names_from = age, values_from = starts_with("Age_")) %>% 
    pivot_longer(-.draw, names_to = "Variable") %>% 
    separate(Variable, into = c("Level", "Sex", "Age"), sep = "_") %>% 
    mutate(Age = str_replace_all(Age, "\\.", " ")) %>% 
    # Rescale effect to "decade-equivalent"
    bind_cols(
      scaling_factors %>% 
        filter(y == "Internet", country == "World", outcome == {{outcome}}) %>% 
        select(scaling)
    ) %>% 
    mutate(value = value * scaling) %>% 
    select(-scaling)
  
  y_mobile <- spread_draws(
    fit_mobile, 
    b_m1_cw, `b_m1_cw:sex1`, r_age[age, term] | term
  ) %>% 
    ungroup() %>% 
    mutate(
      World_Female = b_m1_cw + `b_m1_cw:sex1`*1,
      World_Male = b_m1_cw + `b_m1_cw:sex1`*-1,
      Age_Female = b_m1_cw + m1_cw + (`b_m1_cw:sex1` + `m1_cw:sex1`)*1,
      Age_Male = b_m1_cw + m1_cw + (`b_m1_cw:sex1` + `m1_cw:sex1`)*-1
    ) %>% 
    select(.draw, age, starts_with("World_"), starts_with("Age_")) %>% 
    pivot_wider(names_from = age, values_from = starts_with("Age_")) %>% 
    pivot_longer(-.draw, names_to = "Variable") %>% 
    separate(Variable, into = c("Level", "Sex", "Age"), sep = "_") %>% 
    mutate(Age = str_replace_all(Age, "\\.", " ")) %>% 
    # Rescale effect to "decade-equivalent"
    bind_cols(
      scaling_factors %>% 
        filter(y == "Internet", country == "World", outcome == {{outcome}}) %>% 
        select(scaling)
    ) %>% 
    mutate(value = value * scaling) %>% 
    select(-scaling)
  
  bind_rows(
    "Time" = y_time,
    "Internet" = y_internet,
    "Mobile" = y_mobile,
    .id = "X"
  ) %>% 
    mutate(X = factor(X, levels = c("Time", "Internet", "Mobile"))) %>% 
    group_by(X, Level, Sex, Age) %>% 
    mean_qi(value)
}
this_name <- memoise(this_name, cache = cd)

out <- fits %>% 
  mutate(
    out = map(
      outcome,
      ~this_name(.x)
    )
  )

p_tmp <- out %>% 
  unnest(out) %>% 
  mutate(
    sig = sign(.lower) == sign(.upper),
    color = case_when(
      !sig ~ "c",
      sig & sign(value) == -1 ~ "b",
      sig & sign(value) == 1 ~ "a"
    )
  ) %>% 
  mutate(Age = if_else(is.na(Age), Sex, Age)) %>% 
  mutate(
    Age = factor(
      Age,
      levels = c(
        sort(levels(dat$age), decreasing = TRUE),
        "Male", "Female"
        )
    )
  ) %>%
  ggplot(aes(value, Age, col = color, shape = Sex)) +
  scale_color_brewer(palette = "Dark2") +
  geom_vline(xintercept = 0, lty = 2, size = .2) +
  scale_x_continuous(
    "Estimated linear association (%)",
    breaks = extended_breaks(5),
    # labels = ~percent(./100, .01),
    expand = expansion(.1)
  ) +
  geom_pointinterval(
    aes(xmin = .lower, xmax = .upper),
    interval_size_range = c(.1, .3),
    fatten_point = 3,
    position = position_dodgev(.5)
  ) +
  facet_grid(
    rows = vars(X),
    cols = vars(outcome),
    scales = "free_x",
    labeller = as_labeller(~str_replace(., "_", " "))
  ) +
  theme(
    axis.title.y = element_blank(),
    legend.position = "none"
  )
p_tmp

agg_png(
  "figures/Parameters-all-sex.png",
  width = W, height = W*0.6, units = "in", res = 300
)
p_tmp
dev.off()
```



## Controls

We then compare and contrast our results re internet adoption metrics to those with using Human Development Index as the predictor. We ask how different are associations with well being and mental health to internet adoption and HDI.

```{r}
# How do these things correlate
correlations <- itu %>% 
  group_by(country) %>% 
  select(year, internet, hdi) %>% 
  correlation::correlation()
correlations %>%
  tibble() %>% 
  mutate(Group = fct_rev(Group)) %>% 
  mutate(Correlation = str_glue("correlation({Parameter1}, {Parameter2})")) %>% 
  ggplot(aes(r, Group)) +
  scale_x_continuous(
    "Pearson correlation"
  ) +
  geom_pointrangeh(
    size = .15, fatten = 1.25,
    aes(xmin = CI_low, xmax = CI_high)
  ) +
  facet_wrap("Correlation") +
  theme(
    text = element_text(size = 11),
    axis.title.y = element_blank(),
    panel.grid.major.x = element_line(linetype = 2, size = .1)
  )
```


### Between-country correlations

```{r}
ols_hdi_mean_plot <- ols_internet_mean_plot +
  aes(hdi_mean, val_mean) +
  labs(
    x = "Mean Human Development Index",
    y = "Mean outcome"
  )

ols_hdi_slope_plot <- ols_internet_mean_plot + 
  aes(hdi_slope, val_slope) +
  labs(
    x = "Change per decade in Human Development Index",
    y = "Change in outcome"
  )

ols_internet_mean_plot /
  ols_hdi_mean_plot /
  ols_internet_slope_plot /
  ols_hdi_slope_plot
```

We can then correlate internet and well-being, adjusting for hdi.

```{r fig.height = 1.2}
ols %>% 
  group_by(outcome) %>% 
  nest() %>% 
  # mutate(data = map(data, ~mutate(., across(ends_with("mean"), scale)))) %>% 
  mutate(
    Raw_Internet = map(
      data, 
      ~tidy(lm(val_mean ~ internet_mean, data = .x), conf.int = TRUE)
    ),
    Adjusted_Internet = map(
      data, 
      ~tidy(lm(val_mean ~ internet_mean + hdi_mean, data = .x), conf.int = TRUE)
    ),
    Raw_Mobile = map(
      data, 
      ~tidy(lm(val_mean ~ mobile_mean, data = .x), conf.int = TRUE)
    ),
    Adjusted_Mobile = map(
      data, 
      ~tidy(lm(val_mean ~ mobile_mean + hdi_mean, data = .x), conf.int = TRUE)
    )
  ) %>% 
  select(-data) %>% 
  pivot_longer(
    c(starts_with("Raw"), starts_with("Adjusted")), 
    names_to = "Model"
  ) %>% 
  separate(Model, into = c("Model", "Predictor")) %>% 
  unnest(value) %>% 
  filter(term %in% c("internet_mean", "mobile_mean")) %>% 
  ggplot(aes(estimate, Predictor, col = Model)) +
  geom_vline(xintercept = 0, lty = 2, size = .25) +
  scale_x_continuous(
    "Association with 10% increase in internet adoption",
    expand = expansion(.1),
    breaks = extended_breaks(),
    labels = ~percent(./1000, .1)
  ) +
  geom_pointrangeh(
    aes(xmin = conf.low, xmax = conf.high),
    position = position_dodge2v(.35)
  ) +
  facet_wrap("outcome", nrow = 1, scales = "free_x") +
  theme(axis.text.x = element_text(angle = 90))
```

### HDI within-country associations

::: {.panel-tabset}

#### Countries

```{r}
#| fig.width: 10
#| fig.height: 8
country_hdi_sum <- function(fit) {
  as_draws_df(
    fit, 
    variable = c("b_h1_cw", "^r_country"), 
    regex = TRUE
  ) %>% 
    select(b_h1_cw, ends_with("h1_cw]")) %>% 
    rename_with(
      ~str_remove(., "r_country\\[") %>% str_remove(., ",h1_cw\\]")
    ) %>% 
    mutate(across(-b_h1_cw, ~.+b_h1_cw)) %>% 
    rename(World = b_h1_cw) %>% 
    summarise_draws(mean, ~quantile2(., probs = c(.025, .975))) %>% 
    mutate(country = factor(variable))
}
country_hdi_sum <- memoise(country_hdi_sum, cache = cd)

country_hdi_coefs <- fits %>% 
  mutate(
    fit = map(outcome, ~readRDS(str_glue("models-small/brm-{.x}-5.rds"))),
    country_hdi = map(fit, country_hdi_sum)
  ) %>% 
  select(-fit) %>% 
  unnest(country_hdi)

country_hdi_plot <- country_hdi_coefs %>% 
  # Clean all country names
  mutate(country = str_replace_all(country, "\\.(?!\\.)", " ")) %>% 
  left_join(distinct(dat, region, country)) %>% 
  # Arrange each panel
  group_by(outcome) %>% 
  arrange(outcome, mean) %>% 
  mutate(n = 1:n(), y = factor(n)) %>% 
  ungroup() %>% 
  mutate(
    level = country != "World", 
    mh = outcome %in% oo[4:6],
    text = str_glue("{country} ({number(mean, .01)} [{number(q2.5, .01)}, {number(q97.5, .01)}])")
  ) %>% 
  # mutate(star = sign(.lower) == sign(.upper)) %>% 
  ggplot(aes(mean, y, color = level)) +
  scale_size_manual(values = c(1.25, 0.25)) +
  scale_color_manual(values = c("dodgerblue4", "dodgerblue1")) +
  scale_y_discrete(expand = expansion(.01)) +
  # Association with 10% change
  scale_x_continuous(
    "Estimated association with .1\nincrease Human Development Index",
    breaks = extended_breaks(),
    labels = ~percent(./1000)
  ) +
  geom_vline(xintercept = 0, lty = 2, size = .2) +
  geom_segment(
    aes(
      x = q2.5, xend = q97.5, yend = y, 
      text = text
    ),
    size = .15
  ) +
  geom_point(aes(text = text, size = level)) +
  # Put world in top layer
  geom_point(
    data = . %>% filter(country == "World"), 
    aes(text = text, size = level)
  ) +
  facet_wrap(
    "outcome", 
    nrow = 2, 
    scales = "free",
    labeller = as_labeller(~str_replace(., "_", " "))
  ) +
  labs(y = "Country") +
  theme(
    legend.position = "none",
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )
country_hdi_plot
```

#### Countries interactive

```{r out.height = 860}
gp <- ggplotly(country_hdi_plot, tooltip = "text")
gp %>% 
  layout(
    margin = list(t = 40, r = 20, b = 60, l = 30),
    width = 970,
    height = 830
  )
```

#### Table

```{r}
country_hdi_coefs %>% 
  filter(country == "World") %>% 
  mutate(
    across(
      c(mean, q2.5, q97.5), ~percent(./1000, .001)
    )
  ) %>% 
  kbl(caption = "Estimated world associations with .1 increase in HDI") %>% 
  kable_custom()
```

:::



```{r some-quick-lme-models, eval = FALSE}
itu_tmp <- itu %>% 
  group_by(country) %>% 
  mutate(
    i_cw = internet - mean(internet, na.rm = TRUE),
    m_cw = mobile - mean(mobile, na.rm = TRUE),
    h_cw = hdi - mean(hdi, na.rm = TRUE)
  ) %>% 
  mutate(year = (year-2010)/10)

tmp <- dat %>% 
  group_by(country, year, outcome) %>% 
  summarise(val = mean(val, na.rm = TRUE)) %>% 
  ungroup() %>% 
  left_join(itu_tmp)

predictors <- c(
  "internet", "mobile", "hdi",
  "i_cw", "m_cw", "h_cw",
  "i1_cw", "m1_cw", "h1_cw"
)

lmer2 <- memoise(lmer, cache = cd)
out <- fits %>% 
  crossing(
    x = predictors
  ) %>% 
  mutate(
    frm = str_glue(
      "val ~ {x} + year + ({x} + year | country)"
    )
  ) %>% 
  mutate(
    fit = map2(
      frm, outcome, 
      ~lmer2(.x, data = tmp %>% filter(outcome == .y))
    )
  )

lme_pars <- out %>% 
  mutate(
    fixef = map(
      fit,
      ~tidy(.x, effects = "fixed", conf.int = TRUE)
    ),
    coef_country = map(
      fit,
      ~coef(.x)$country %>% 
        rownames_to_column("country") %>% 
        pivot_longer(-country, names_to = "term", values_to = "estimate")
    )
  ) %>% 
  mutate(
    x = factor(
      x,
      levels = predictors
    )
  ) %>% 
  select(-fit)

lme_pars %>%
  select(-coef_country) %>% 
  unnest(fixef) %>% 
  filter(!(term %in% c("(Intercept)", "year"))) %>% 
  ggplot(aes(estimate, x)) +
  scale_y_discrete("Predictor", limits = rev) +
  scale_x_continuous(
    "Conditional effect of 10% change in predictor",
    breaks = extended_breaks(),
    # Visualize conditional effect of 10% change on x
    # Modelled (0-100), change to proportion so percentage is correct
    labels = ~percent(./1000)
  ) +
  geom_vline(xintercept = 0, lty = 2, size = .25) +
  geom_pointrangeh(
    aes(xmin = conf.low, xmax = conf.high),
    # position = position_dodge2v(.25),
    fatten = 3
  ) +
  facet_wrap("outcome", scales = "free_x", nrow = 2)

last_plot() +
  geom_point(
    data = lme_pars %>% 
      select(-fixef) %>% 
      unnest(coef_country) %>% 
      filter(!(term %in% c("(Intercept)", "year"))),
    size = .5, alpha = .5, shape = 1, col = "grey60",
    position = position_jitter(height = .15)
  )
```

```{r }
benchmarks <- lme_pars %>% 
  select(outcome, fixef) %>% 
  unnest(fixef) %>% 
  filter(term == "h1_cw") %>% 
  transmute(
    outcome,
    benchmark = estimate/10  # Association with .1 change in HDI
  )

x <- readRDS("models-small/brm-Positive_experiences-3.rds")
fits
as_draws_df(x, variable = "^b_[i|m]1_cw$", regex = TRUE)
tmp <- benchmarks %>% 
  mutate(
    est = map(
      outcome, 
      ~as_draws_df(
        readRDS(str_glue("models-small/brm-{.x}-3.rds")),
        variable = "^b_i1_cw$", regex = TRUE
      ) %>% tibble()
    )
  ) %>% 
  unnest(est)
ggplot(aes(b_i1_cw, outcome)) +
  geom_vline(xintercept = 0, lty = 2, size = .25) +
  geom_vline(aes(xintercept = benchmark)) +
  stat_halfeye(
    normalize = "xy"
  ) +
  facet_wrap("outcome", scales = "free", nrow = 1)

library(bayestestR)
bayestestR::p_significance()

tmp %>% 
  group_by(outcome) %>% 
  mutate(
    m = map_dbl(
      est,
      ~mean(pull(.x, 1))
    ),
    p_rope = map2_dbl(
      benchmark, est,
      ~p_rope(
        as.numeric(pull(.y, 1)), 
        range = c(-abs(.x), abs(.x))
      )$p_ROPE
    )
  )
```

