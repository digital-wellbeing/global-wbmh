---
title: "Online analysis supplement"
description: |
  A global study of adolescents’ digital technology adoption and its associations with well-being and mental health
author:
  - name: Matti Vuorre
    url: https://vuorre.netlify.app
    affiliation: Oxford Internet Institute
    affiliation_url: https://www.oii.ox.ac.uk/people/matti-vuorre/
date: "`r Sys.Date()`"
output:
  distill::distill_article:
    toc: true
    toc_depth: 3
    toc_float: true
    fig_width: 8
    fig_height: 6
    fig_retina: 2
    dev: "ragg_png"
    code_folding: true
editor_options: 
  chunk_output_type: console
---

## Preface

This document details the analyses supporting *A global study of adolescents’ digital technology adoption and its associations with well-being and mental health* (Vuorre & Prybylski, in preparation).

It is written in R Markdown and therefore contains all the code required for reproducing our computations. However some parts of the code were parallelised to work best with our local setup, so having e.g. a different number of cores will significantly impact the run-time of this script.

Therefore we recommend reproducing the analyses by running them in interactive mode, and changing the parallelisation parameters by hand to best fit your setup.

## Settings

We first load the required R packages and set some options for the resulting document.

```{r packages-settings}
#| results: 'hide'
# Packages
library(readxl)
library(ggtext)
library(janitor)
library(brms)
library(gtsummary)
library(imputeTS)
library(broom.mixed)
library(ragg)
library(scales)
library(ggh4x)
library(tidybayes)
library(naniar)
library(ggdist)
library(parameters)
library(countrycode)
library(lme4)
library(emmeans)
library(plotly)
library(knitr)
library(patchwork)
library(bayestestR)
library(lubridate)
library(haven)
library(janitor)
library(broom)
library(kableExtra)
library(ggbeeswarm)
library(ggstance)
library(sysfonts)
library(tidyverse)

# Knitr options
opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  cache = TRUE,
  error = FALSE,
  message = FALSE,
  fig.align = "center",
  fig.retina = 2
)

# Plotting theme
Font <- "Titillium Web"
if (!(Font %in% font_families())) font_add_google(Font, Font)
theme_set(
  theme_linedraw(
    base_size = 12, 
    base_family = Font
  ) +
    theme(
      panel.grid = element_blank(),
      strip.text = element_text(margin = margin(4, 4, 4, 4, "pt"))
    )
)

# MCMC settings
options(brms.backend = "cmdstanr")
# Run this to delete fitted models and refit
# unlink(list.files(pattern = "output/brm-.*\\.rds"))

# Create directory for intermediate files
dir.create("output", FALSE)
```

## Data cleaning

We downloaded the relevant data from sources to `data-raw/`. We cannot share the data here but indicate below how and when each data table was obtained. 

### Global Burden of Disease

The Global Burden of Disease data were downloaded from <http://ghdx.healthdata.org/gbd-results-tool> on 2021-11-02 to `data-raw/GBD/gbd-2021-11-02/`. We selected the relevant locations, age groups, years, and causes from the data tool as detailed in the manuscript. Next we load all tables (inside downloaded `.zip` files, there may be more than one depending on size of downloaded table) inside the directory.

```{r gbd-data-load}
# Load data files and merge to one table
gbd <- list.files(
  "data-raw/GBD/gbd-2021-11-02/", 
  pattern = ".zip", full.names = TRUE, recursive = TRUE
) %>% 
  read_csv()
```

We then ensure that the correct variables were downloaded, and then clean this data.

```{r gbd-data-clean}
# Cleaning

# First step is to clean names in all data sets
gbd <- clean_names(gbd)


# Confirm that correct measures were downloaded:
# - prevalence: Total number of cases
# - rate: Total cases per 100,000 population
#   - We convert this to a percentage
# distinct(gbd, measure, metric)
gbd <- select(gbd, -metric, -measure)
gbd <- gbd %>% 
  mutate(across(c(val, upper, lower), ~.x/1000))

# Clean cause names
# distinct(gbd, cause)
gbd <- gbd %>% 
  mutate(
    cause = case_when(
      cause == "Anxiety disorders" ~ "Anxiety",
      cause == "Depressive disorders" ~ "Depression",
      cause == "Self-harm" ~ "Selfharm"
    )
  )

# Harmonise variable names with other datasets
gbd <- gbd %>% 
  rename(country = location)

# The outcomes values are model predictions and come with lower and upper CI limits (2.5 and 97.5 %iles of their posterior distributions).We convert those to normal approximate standard errors.
gbd <- gbd %>% 
  mutate(se = (upper-lower) / (1.96*2)) %>%
  select(-c(upper, lower))
```

Then we need to harmonise to country names (always somewhat idiosyncratic) to a common metric. We use the short English names from the UNICODE CLDR project as provided by `countrycode::countryname()`. There is a harmonised name for each GBD country, and 27 country names are harmonised.

```{r gbd-harmonise-countries}
# Check what names were changed and if any don't have harmonised counterpart
gbd %>%
  distinct(country) %>% 
  arrange(country) %>%
  mutate(
    country_harmonised = countryname(country, destination = "cldr.short.en")
  ) %>% 
  filter(country != country_harmonised | is.na(country_harmonised)) %>% 
  kbl() %>% 
  kable_minimal(full_width = FALSE) %>% 
  scroll_box(width = "500px", height = "400px")
# Harmonise old names after verifying above that none are dropped
gbd <- gbd %>% 
  mutate(country = countryname(country, destination = "cldr.short.en"))
```


### Gallup World Poll

GWP cleaning goes here.

### International Telecommunication Union

The internet adoption data were downloaded from the ITU website in October 2021, and placed with their original file names to `data-raw/ITU/`. The specific URLs for obtaining the data files are

- <https://www.itu.int/en/ITU-D/Statistics/Documents/statistics/2021/July/PercentIndividualsUsingInternet.xlsx>
- <https://www.itu.int/en/ITU-D/Statistics/Documents/statistics/2021/July/FixedBroadbandSubscriptions_2000-2020.xlsx>
- <https://www.itu.int/en/ITU-D/Statistics/Documents/statistics/2021/July/MobileBroadbandSubscriptions_2007-2020.xlsx>

We first load, reshape, and merge these datasets.

```{r itu-load-clean}
# Read and reshape fixed broadband data
itu_fixed <- read_xlsx(
  "data-raw/ITU/FixedBroadbandSubscriptions_2000-2020.xlsx", 
  sheet = 2,
  col_types = "text"
) %>% 
  pivot_longer(-c(Indicator, Country)) %>% 
  separate(name, into = c("year", "variable")) %>% 
  pivot_wider(names_from = variable) %>% 
  mutate(fixed = as.numeric(value)) %>% 
  select(country = Country, year, fixed)

# Read and reshape mobile broadband data
itu_mobile <- read_xlsx(
  "data-raw/ITU/MobileBroadbandSubscriptions_2007-2020.xlsx", 
  sheet = 2,
  col_types = "text"
) %>% 
  pivot_longer(-c(Indicator, Country)) %>% 
  separate(name, into = c("year", "variable")) %>% 
  pivot_wider(names_from = variable) %>% 
  mutate(mobile = as.numeric(value)) %>% 
  select(country = Country, year, mobile)

# Percent using internet
itu_percent <- read_xlsx(
  "data-raw/ITU/PercentIndividualsUsingInternet.xlsx",
  col_types = "text"
) %>% 
  pivot_longer(-c(Indicator, Country)) %>% 
  separate(name, into = c("year", "variable")) %>% 
  pivot_wider(names_from = variable) %>% 
  mutate(internet = as.numeric(value)) %>% 
  select(country = Country, year, internet)

# Merge to one table in wide format (oldest on left to include all years)
itu <- reduce(list(itu_percent, itu_fixed, itu_mobile), left_join)

# values (1-100) to proportions (0-1) and years to numbers
itu <- itu %>% 
  mutate(across(c(internet, fixed, mobile), function(x) x/100)) %>% 
  mutate(year = as.numeric(year))

# Drop tables
rm(itu_fixed, itu_mobile, itu_percent)
```

Then harmonise country names as above, and drop countries that don't exist in outcomes.

```{r itu-harmonise-countries}
# Check what names were changed and if any don't have harmonised counterpart
itu %>%
  distinct(country) %>% 
  arrange(country) %>%
  mutate(
    country_harmonised = countryname(country, destination = "cldr.short.en")
  ) %>% 
  filter(country != country_harmonised | is.na(country_harmonised)) %>% 
  kbl() %>% 
  kable_minimal(full_width = FALSE) %>% 
  scroll_box(width = "500px", height = "400px")

# Harmonise old names after verifying above that none are dropped
itu <- itu %>% 
  mutate(country = countryname(country, destination = "cldr.short.en"))

# These countries don't exist in outcomes
itu %>%
  distinct(country) %>% 
  anti_join(distinct(gbd, country)) %>% 
  kbl() %>% 
  kable_minimal(full_width = FALSE) %>% 
  scroll_box(width = "500px", height = "400px")

# Drop them
itu <- itu %>% 
  filter(country %in% unique(gbd$country))
```

#### Missingness

Remove countries with no observations

```{r}
itu <- itu %>% 
  group_by(country) %>% 
  mutate(nobs = sum(!is.na(internet))) %>% 
  ungroup() %>% 
  filter(nobs > 0) %>% 
  select(-nobs)
```


There are some missing values in the data; in the Internet variable these are mainly in the first or last years of each country's time-series. This needs to be changed to calculate by-variable (with appropriate time-spans) when adding mobile and fixed

```{r}
miss_var_summary(itu)
```

We then impute missing values to the internet adoption timeseries. We use linear interpolation to fill missing intermediate values, but do not extrapolate before or after the first and last values.

```{r itu-impute}
itu <- itu %>% 
  group_by(country) %>% 
  # Find first and last year with internet data in each country
  mutate(
    min_year = year[min(which(!is.na(internet)))],
    max_year = year[max(which(!is.na(internet)))]
  ) %>%
  # Interpolate values linearly
  # use possibly() to avoid errors for countries with no data
  # Add variables to c() to impute for fixed and mobile broadband
  mutate(
    across(
      c(internet), 
      possibly(
        function(x) na_interpolation(x, maxgap = Inf), 
        # If function errors, provide original internet value
        otherwise = internet
      )
    )
  ) %>% 
  # Take out projected (non-intermediate) imputed values
  mutate(
    internet = if_else(
      between(year, unique(min_year), unique(max_year)), 
      internet, 
      NaN
    )
  ) %>% 
  ungroup() %>% 
  select(-min_year, -max_year)
```

We see that 96 intermediate internet use values were imputed to the time series.

```{r}
miss_var_summary(itu)
```

### Complete study dataset

#### GLOBE regions

We group the countries into GLOBE regions in order to have a higher level of grouping at which the analyses can be summarised. This allows us to eg. present figures and tables per region, instead of overwhelmingly by country, and also provides an upper level for the multilevel models. We use the extended GLOBE regions following Jebb et al. (2020), and had to manually add labels to some countries that were not grouped in those studies.

```{r}
regions <- read_csv(
  "data-raw/Regions/GLOBE-regions-from-Jebb-et-al-2020.csv"
) %>% 
  # Jebb et al used * to indicate deviance from GLOBE, remove
  mutate(country = str_remove_all(country, "\\*")) %>% 
  # Standardize country names
  # This drops Nagorno-Karabakh Republic
  mutate(country = countryname(country)) %>% 
  drop_na(country)

# This also combined Swaziland and (Eswatini) to Eswatini, and Northern- and Cyprus. Therefore we just take the distinct country & region.
regions <- distinct(regions, region, country)

# Countries in our dataset not present in region data
filter(
  distinct(gbd, country), 
  !(country %in% unique(regions$country))
) %>% 
  arrange(country) %>% 
  write_csv("data-raw/Regions/GBD-countries-without-region.csv")

# I then filled missing regions in Jebb et al and extended GLOBE referenced therein

# Load our manually filled region data
regions_filled <- read_csv(
  "data-raw/Regions/GBD-countries-without-region-filled.csv"
) 
```

We then combine all the region tables, clean region names, and join to our data

```{r}
# Combine Jebb et al GLOBE regions and our manually added ones
regions <- regions %>% 
  bind_rows(
    regions_filled %>% 
      mutate(Note = "Filled")
  ) %>% 
  arrange(region, country)

# Shorter name for plots
regions <- regions %>% 
  mutate(region = if_else(region=="Sub-Sahara Africa", "Africa", region))

# Format regions to factors and use line breaks instead of spaces
regions$region <- factor(regions$region)
levels(regions$region) <- str_replace_all(levels(regions$region), " ", "\n")

# Display table of regions and countries
regions %>% 
  kbl(caption = "All countries and regions.") %>% 
  kable_minimal(full_width = FALSE) %>% 
  scroll_box(width = "500px", height = "400px")

regions <- select(regions, -Note)
```

#### Create predictors

We then create predictors (centered, lagged, rescaled) for models in the ITU dataset.

```{r}
# For models, we rescale year; centred at 2013 and one unit indicates decade
itu <- itu %>% 
  mutate(time = (year - 2013) / 10)

# Create predictor: Lagged effect of 10% increase in internet
itu <- itu %>% 
  arrange(country, year) %>% 
  group_by(country) %>% 
  mutate(i1 = lag(internet*10, 1)) %>% 
  ungroup()

# Centering within and between countries
itu <- itu %>%
  bmlm::isolate("i1", by = "country", which = "both")
```

#### Create tables

Here, we join the ITU table to the GBD table. Note this appropriately duplicates the country-specific predictor values to the demographic groups within each country. We then create a table specific to young people. 

We also join regions to the data.

```{r}
# Add regions to data tables
itu <- left_join(itu, regions)
gbd <- left_join(gbd, regions)

# Merge data tables
gbd <- left_join(gbd, itu)

# Contrast code sex
gbd$sex <- factor(gbd$sex)
contrasts(gbd$sex) <- c(-.5, .5)

# Focus on young people
gbd_all <- gbd
gbd <- gbd %>% 
  filter(age %in% c("15 to 19", "20 to 24"))

# Contrast code binary age in young data set
gbd$age <- factor(gbd$age)
contrasts(gbd$age) <- c(-.5, .5)

# Young data in wide format
gbd_wide <- gbd %>%
  pivot_wider(names_from = cause, values_from = c(val, se))
names(gbd_wide) <- str_remove(names(gbd_wide), "val_")
```

We also save a synthetic version of this dataset to better enable others to reproduce our analytical procedures:

```{r synth-data-create}

```

## Describe

### Internet use trends

```{r}
itu %>% 
  filter(year %in% c(2001, 2019)) %>% 
  select(region, country, year, internet) %>% 
  pivot_wider(names_from = year, values_from = internet) %>% 
  select(-country) %>% 
  tbl_summary(by = region) %>% 
  add_overall()
itu %>% 
  group_by(country) %>% 
  summarise(x = sum(!is.na(internet))) %>% 
  arrange(x)
```


```{r}
# Plot predictors from their own table--values are repeated in data that includes outcomes due to age and sex groups for each year and country
itu %>% 
  mutate(year = make_date(year)) %>%
  ggplot(aes(x = year, y = internet)) +
  coord_cartesian(ylim = c(0, 1.00)) +
  scale_y_continuous(
    "Internet users",
    breaks = c(0, .25, .5, .75, 1),
    labels = percent,
    expand = expansion(c(0.02, 0.1))
  ) +
  scale_x_date(
    breaks = breaks_width("5 years"),
    labels = label_date("'%y")
  ) +
  geom_line(
    aes(group = country),
    alpha = .25, size = .4, color = "dodgerblue1"
  ) +
  stat_summary(
    fun = mean, geom = "line", 
    size = .6, color = "dodgerblue4"
  ) +
  facet_wrap(~region, nrow = 1) +
  theme(legend.position = "none")
ggsave(
  "output/Fig-ITU.png", 
  device = agg_png,
  height = 600, width = 3200, res = 300, units = "px"
)
```

```{r}
itu %>% 
  mutate(year = make_date(year)) %>%
  mutate(mobile = if_else(mobile > 1.50, NaN, mobile)) %>% 
  pivot_longer(internet:mobile) %>% 
  mutate(name = str_to_title(name)) %>% 
  mutate(name = fct_inorder(name)) %>% 
  ggplot(aes(x = year, y = value)) +
  # coord_cartesian(ylim = c(0, 1.00)) +
  scale_y_continuous(
    "Users or subscriptions",
    # breaks = c(0, .25, .5, .75, 1),
    labels = percent,
    expand = expansion(c(0.025, 0.05))
  ) +
  scale_x_date(
    breaks = breaks_width("5 years"),
    labels = label_date("'%y")
  ) +
  # Ensure all axes go up to 100%
  geom_blank(
    data = tibble(
      region = "Africa", 
      country = NA, 
      value = 1, 
      year = make_date(2001))
  ) +
  geom_line(
    aes(group = country),
    alpha = .25, size = .4, color = "dodgerblue1"
  ) +
  stat_summary(
    fun = mean, geom = "line", 
    size = .6, color = "dodgerblue4"
  ) +
  facet_grid(name~region, scales = "free_y") +
  theme(
    legend.position = "none",
    panel.spacing = unit(2, "pt")
  )
```


### Mental health

```{r eval = FALSE}
pa <- gbd %>% 
  ggplot(aes(year, val, group = country, col = region)) +
  scale_y_continuous(
    "Rate in 100 people",
    breaks = pretty_breaks()
  ) +
  scale_x_continuous(
    breaks = c(2000, 2005, 2010, 2015, 2020),
    labels = c("'00", "'05", "'10", "'15", "'20")
  ) +
  stat_summary(fun = mean, geom = "line", size = .5) +
  facet_grid(cause~region, scales = "free_y") +
  theme(
    legend.position = "none",
    axis.title.x = element_blank()
  )
pb <- gbd %>% 
  mutate(Group = str_glue("{sex} ({age})")) %>% 
  ggplot(aes(year, val, col = Group)) +
  scale_color_brewer(palette = "Paired") +
  scale_y_continuous(
    "Rate in 100 people",
    breaks = pretty_breaks()
  ) +
  scale_x_continuous(
    "Year",
    breaks = c(2000, 2005, 2010, 2015, 2020),
    labels = c("'00", "'05", "'10", "'15", "'20")
  ) +
  stat_summary(fun = mean, geom = "line", size = .6) +
  facet_grid(cause~region, scales = "free_y")

p_gbd <- (pa / pb) +
  plot_annotation(tag_levels = "A")

p_gbd
ggsave(
  "output/Fig-GBD.png", 
  device = agg_png,
  height = 2400, width = 3600, res = 300, units = "px"
)
```

### Multiple lines

Here we create two plots. One to show all main variables' time trends for each region, and country within region. Then, show the outcome time trends for top internet trend in each region. Maybe put first in main text and second in appendix.

First, variables with one region per panel.

```{r}
# Add pseudo GWP to figure plot out
pseudo_gwp <-
  bind_rows(
    distinct(gbd, region, year) %>% 
      crossing(
        cause = fct_inorder(
          c(
            "Negative\nexperiences", 
            "Positive\nexperiences", 
            "Life\nsatisfaction"
          )
        )
      )
  )
p_vars <- bind_rows(
  pseudo_gwp,
  gbd %>% 
    group_by(region, country, year, cause) %>% 
    summarise(mean = mean(val/100))
) %>% 
  ungroup() %>% 
  mutate(cause = fct_inorder(cause)) %>% 
  mutate(year = make_date(year)) %>% 
  ggplot(aes(year, mean)) +
  scale_color_brewer(
    "Variable",
    palette = "Set1", direction = -1
  ) +
  scale_y_continuous(
    "Rate or scale score",
    labels = function(x) percent(x, .01) %>% str_remove("\\.00"),
    breaks = pretty_breaks()
  ) +
  scale_x_date(
    "Year",
    breaks = make_date(c(2005, 2010, 2015)), 
    date_labels = "'%y", 
    expand = expansion(.02)
  ) +
  geom_line(
    aes(group = interaction(country, cause)), 
    alpha = .25, size = .4, color = "dodgerblue1"
  ) +
  stat_summary(
    fun = mean, geom = "line", 
    size = .6, color = "dodgerblue4"
  ) +
  facet_grid(cause~region, scales = "free_y") +
  theme(
    legend.position = "none",
    panel.spacing = unit(2, "pt")
  )
p_vars
ggsave(
  "output/Fig-vars-timeseries.png", 
  device = agg_png,
  height = 2400, width = 3600, res = 300, units = "px"
)
```

```{r}
# Get top 1 internet trend country in each region
top_trends <- gbd %>% 
  semi_join(distinct(itu, country)) %>% 
  group_by(region, country) %>% 
  summarise(tidy(lm(internet ~ time, data = cur_data_all()))) %>% 
  filter(term == "time") %>% 
  group_by(region) %>% 
  slice_max(order_by = estimate, n = 1)
pb <- gbd %>% 
  filter(country %in% top_trends$country) %>%
  mutate(country = factor(country, levels = top_trends$country)) %>% 
  mutate(Group = str_glue("{sex} ({age})")) %>% 
  mutate(year = make_date(year)) %>% 
  ggplot(aes(year, val/100, col = Group)) +
  scale_color_brewer(palette = "Paired") +
  scale_y_continuous(
    "Rate",
    labels = function(x) percent(x, .01) %>% str_remove("\\.00"),
    breaks = pretty_breaks()
  ) +
  scale_x_date(
    "Year",
    breaks = make_date(c(2005, 2010, 2015)), 
    date_labels = "'%y", 
    expand = expansion(.02)
  ) +
  stat_summary(fun = mean, geom = "line", size = .6) +
  facet_grid(cause~country, scales = "free_y")

(pa + theme(axis.title.x = element_blank())) / 
  pb * 
  theme(panel.spacing = unit(2, "pt")) +
  plot_layout(heights = c(4, 3)) +
  plot_annotation(tag_levels = "A")
ggsave(
  "output/Fig-all-vars-timeseries.png", 
  device = agg_png,
  height = 2400, width = 3600, res = 300, units = "px"
)
```


## Model 1: Temporal trends

We then model the mental health and well-being outcomes over time allowing for heterogeneity across locations and demographic groups.

We first fit the models using lme4 because they are big and therefore would be very slow with brms.

### GBD

#### lme4

```{r fit-gbd-time-lme4}
# These take about 5-20 minutes each
# run in parallel in background jobs
# recommended to conduct this in interactive mode (rstudio)
file_path <- "output/lme4-gbd-time.rds"
if (!file.exists(file_path)) {
  library(job)
  job({fit_anx <- lmer(
    Anxiety ~ 1 + time * sex * age + 
      (1 + time * sex * age | region) +
      (1 + time * sex * age | country),
    data = gbd_wide
  )}, title = "Anxiety time (lmer)")
  job({fit_dep <- lmer(
    Depression ~ 1 + time * sex * age + 
      (1 + time * sex * age | region) +
      (1 + time * sex * age | country),
    data = gbd_wide
  )}, title = "Depression time (lmer)")
  job({fit_sel <- lmer(
    Selfharm ~ 1 + time * sex * age + 
      (1 + time * sex * age | region) +
      (1 + time * sex * age | country),
    data = gbd_wide
  )}, title = "Self harm time (lmer)")
  fits_lmer <- distinct(gbd, cause) %>% 
    mutate(fit = list(fit_anx, fit_dep, fit_sel))
  write_rds(fits_lmer, file_path)
} else {fits_lmer <- read_rds(file_path)}
```

Plot fixed effects and by demographic

```{r}
# Fixed effects parameters
fixed_effects <- fits_lmer %>% 
  mutate(out = map(fit, ~tidy(., conf.int = TRUE))) %>% 
  select(-fit) %>% 
  unnest(out) %>% 
  standardize_names() %>% 
  as_tibble() %>% 
  filter(
    Effects == "fixed", 
    Parameter != "(Intercept)"
  ) 
# Fixed effects per demographic
fixed_effects_demographics <- fits_lmer %>% 
  mutate(
    out = map(
      fit,
      ~emtrends(.x, var = "time", by = c("sex", "age")) %>% 
        parameters() %>% 
        as.data.frame()
    )
  ) %>% 
  select(-fit) %>% 
  unnest(out) %>% 
  standardize_names() %>% 
  as_tibble() %>% 
  mutate(Parameter = str_glue("{sex}\n({age})"))

# Random effects parameters
random_effects <- fits_lmer %>% 
  mutate(
    coef_region = map(
      fit, 
      ~bind_rows(
        coef(.x)$region %>% 
          as.data.frame() %>% 
          rownames_to_column("region"),
        coef(.x)$country %>% 
          as.data.frame() %>% 
          rownames_to_column("country"),
        .id = "cluster"
      ) %>% 
        mutate(cluster = factor(cluster, labels = c("region", "country")))
    )
  ) %>% 
  select(-fit) %>% 
  unnest(coef_region) %>% 
  mutate(Type = "Effects") %>%
  select(-`(Int      ,nc ercept)`)

bind_rows(
  fixed_effects,
  fixed_effects_demographics, 
  .id = "Type"
) %>% 
  mutate(Type = factor(Type, labels = c("Effects", "Time by demographic"))) %>% 
  mutate(Parameter = fct_inorder(Parameter)) %>%
  mutate(cause = factor(cause)) %>% 
  rowwise() %>% 
  mutate(
    sig = factor(
      !between(0, CI_low, CI_high), 
      levels = c(TRUE, FALSE)
    )
  ) %>% 
  ggplot(aes(Coefficient, Parameter, col = cause, shape = sig)) +
  scale_color_discrete(
    "Outcome"
  ) +
  scale_x_continuous(
    "Estimate (95%CI)"
  ) +
  scale_shape_manual(values = c(19, 21)) +
  geom_vline(xintercept = 0, size = .2, alpha = .2) +
  geom_pointrangeh(
    aes(xmin = CI_low, xmax = CI_high),
    position = position_dodge2v(.5),
    fill = "white", size = .3, fatten = 5
  ) +
  guides(shape = "none") +
  facet_wrap("Type", ncol = 2, scales = "free") +
  theme(axis.title.y = element_blank())
```

#### brms

correlating temporal trends in outcomes and internet use using multilevel model with shared correlation matrix

note we use beta so transform edge values

we start with non interactive model--demographics are covariates. later to be expanded to interaction but slow

##### Time: Main effects

We first fit a multivariate model of time effects on internet penetration and each of the well-being outcomes.

$$
\begin{align*}
y_{i[c][r]} &\sim \text{Normal}(\mu^y_{i[c][r]}, \sigma^{2y}) \\

\mu^y_{i[c][r]} &= \beta^{y}_{0} + \gamma^{y}_{0[c]} + \delta^{y}_{0[r]} +
\beta^y_{1}\text{t}_i + \gamma^{y}_{1[c]}\text{t}_i + \delta^{y}_{1[r]}\text{t}_i  \\

i_{i[c][r]} &\sim 
\text{Beta}(\mu^i_{i[c][r]}, \phi^i) \\

\mu^i_{i[c][r]} &= \text{logit}(
\beta^{i}_{0} + \gamma^{i}_{0[c]} + \delta^{i}_{0[r]} +
\beta^i_{1}\text{t}_i + \gamma^{i}_{1[c]}\text{t}_i + \delta^{i}_{1[r]}\text{t}_i) \\

\left[\begin{array}{c}
\gamma^y_{0[c]} \\ \gamma^y_{1[c]} \\ \gamma^i_{0[c]} \\ \gamma^i_{1[c]}
\end{array}\right] 
&\sim MVN(
\left[\begin{array}{c}
0 \\ 0 \\ 0 \\ 0
\end{array}\right],
\Sigma^c
),

\left[\begin{array}{c}
\delta^y_{0[r]} \\ \delta^y_{1[r]} \\ \delta^i_{0[r]} \\ \delta^i_{1[r]}
\end{array}\right] 
\sim MVN(
\left[\begin{array}{c}
0 \\ 0 \\ 0 \\ 0
\end{array}\right],
\Sigma^r
)
\end{align*}
$$

```{r}
# Transform edge proportions to fit beta distribution
gbd_10 <- gbd_wide %>% 
  mutate(internet = if_else(internet == 0, .0000000001, internet)) %>% 
  mutate(internet = if_else(internet == 1, .9999999999, internet))

# Define a model of internet proportion over time
bf_int <- bf(
  internet ~ 1 + time + 
    (1 + time |c| country) +
    (1 + time |r| region), 
  family = Beta()
)

# Define models of outcomes
bf_anx <- bf(
  Anxiety ~ 1 + time + sex + age + 
    (1 + time + sex + age |c| country) +
    (1 + time + sex + age |r| region),
  family = gaussian()
)
bf_dep <- bf(
  Depression ~ 1 + time + sex + age + 
    (1 + time + sex + age |c| country) +
    (1 + time + sex + age |r| region),
  family = gaussian()
)
bf_sel <- bf(
  Selfharm ~ 1 + time + sex + age + 
    (1 + time + sex + age |c| country) +
    (1 + time + sex + age |r| region),
  family = gaussian()
)

bf_time_mv <- bf(
  mvbind(Depression, Anxiety, Selfharm) ~ 
    1 + time +
    (1 + time |c| country) +
    (1 + time | region),
  family = gaussian()
) +
  bf_int +
  set_rescor(FALSE)


# Fit models
fit_anx <- brm(
  bf_int + bf_anx + set_rescor(FALSE),
  data = gbd_10,
  file = "output/brm-gbd-time-anxiety",
  chains = 4,
  cores = 4,
  iter = 1000, warmup = 600, refresh = 10,
  threads = 1,
  control = list(adapt_delta = .9)
)
fit_dep <- brm(
  bf_int + bf_dep + set_rescor(FALSE),
  data = gbd_10,
  file = "output/brm-gbd-time-depression",
  chains = 4,
  cores = 4,
  iter = 1000, warmup = 600, refresh = 10,
  threads = 1,
  control = list(adapt_delta = .9)
)
fit_sel <- brm(
  bf_int + bf_sel + set_rescor(FALSE),
  data = gbd_10,
  file = "output/brm-gbd-time-selfharm",
  chains = 4,
  cores = 4,
  iter = 1000, warmup = 600, refresh = 10,
  threads = 1,
  control = list(adapt_delta = .9)
)
fits_brm_time_main <- tibble(
  outcome = c("Anxiety", "Depression", "Selfharm"),
  fit = list(fit_anx, fit_dep, fit_sel)
)

```

Coefficients

```{r}
fits_brm_time_main %>% 
  mutate(
    out = map(
      fit, 
      ~as_draws(.x, variable = "b_", regex = TRUE) %>% 
        summarise_draws(quantile, rhat, .args = list(probs = c(.5, .05, .95)))
    )
  ) %>% 
  select(-fit) %>% 
  unnest(out) %>% 
  # filter(str_detect(Parameter, "_time$")) %>% 
  kbl(digits = 3) %>% 
  kable_minimal(full_width = FALSE)
```

Revisit figure of temporal trends with coefficients

```{r}
tmp_pars <- fits_brm_time_main %>% 
  mutate(
    out = map2(
      fit, 
      outcome,
      ~hypothesis(
        .x, 
        c(str_glue("{.y}_time = 0")),
        scope = "coef",
        group = "region"
      )$hypothesis
    )
  ) %>% 
  select(-fit) %>% 
  unnest(out) %>% 
  # Internet trend is estimated in all models keep first
  distinct(Group, Hypothesis, .keep_all = TRUE) %>% 
  mutate(across(where(is.numeric), ~round(., 3))) %>% 
  mutate(result = str_glue('**{Estimate}**<br>[{CI.Lower}, {CI.Upper}]')) %>% 
  select(cause = Hypothesis, region = Group, result) %>% 
  mutate(cause = str_sub(cause, 2, -6) %>% str_remove("_time"))

p_vars +
  geom_richtext(
    data = tmp_pars %>% mutate(cause = fct_inorder(str_to_title(cause))),
    aes(x = make_date(2000), y = Inf, label = result),
    size = 2, vjust = .9, hjust = 0.1, color = "dodgerblue4",
    family = Font,
    fill = NA, label.color = NA
  )
ggsave(
  "output/Fig-vars-timeseries-estimates.png", 
  device = agg_png,
  height = 2400, width = 3600, res = 300, units = "px"
)
```

Calculate country coefficients and show scatterplots

```{r time-correlation-anxiety}
# Get average and region
r_region_anxiety <- fit_anx %>% 
  spread_draws(
    b_Anxiety_time, 
    b_internet_time,
    r_region__Anxiety[region, term],
    r_region__internet[region, term]
  ) %>% 
  filter(term == "time") %>% 
  ungroup() %>% 
  # Fix names by replacing dot with line break
  mutate(region = str_replace(region, "\\.", "\n"))

# Then country
r_country_anxiety <- fit_anx %>% 
  spread_draws(
    r_country__Anxiety[country, term],
    r_country__internet[country, term]
  ) %>% 
  filter(term == "time") %>% 
  ungroup() %>% 
  # Fix names by taking labels from original names
  mutate(
    country = factor(
      country, 
      labels = sort(unique(fit_anx$data$country))
    )
  ) %>% 
  left_join(distinct(gbd, region, country))

# Calculate country coefficients
country_anxiety <- left_join(r_country_anxiety, r_region_anxiety) %>% 
  mutate(
    internet = b_internet_time + r_region__internet + r_country__internet,
    anxiety = b_Anxiety_time + r_region__Anxiety + r_country__Anxiety
  ) %>% 
  group_by(country, region) %>% 
  median_qi(internet, anxiety)

country_anxiety_ellipse <- spread_draws(
  fit_anx,
  b_Anxiety_time, b_internet_time,
  cor_country__internet_time__Anxiety_time, 
  ndraws = 100
) %>% 
  mutate(
    e = pmap(
      list(
        x = cor_country__internet_time__Anxiety_time, 
        y = b_internet_time, 
        z = b_Anxiety_time
      ), 
      function(x, y, z) ellipse::ellipse(x, centre = c(y, z), level = .8) %>% 
        as_tibble()
    )
  ) %>% 
  unnest(e)

region_anxiety_ellipse <- spread_draws(
  fit_anx,
  b_Anxiety_time, b_internet_time,
  cor_region__internet_time__Anxiety_time, 
  ndraws = 100
) %>% 
  mutate(
    e = pmap(
      list(
        x = cor_region__internet_time__Anxiety_time, 
        y = b_internet_time, 
        z = b_Anxiety_time
      ), 
      function(x, y, z) ellipse::ellipse(x, centre = c(y, z), level = .8) %>% 
        as_tibble()
    )
  ) %>% 
  unnest(e)

country_anxiety_cor <- fit_anx %>%
  as_draws_df(
    variable = c(
      "cor_country__internet_time__Anxiety_time",
      "cor_region__internet_time__Anxiety_time"
    ),
    regex = TRUE
  ) %>% 
  as_tibble()
country_anxiety_result <- country_anxiety_cor %>%   
  summarise_draws(quantile, rhat, .args = list(probs = c(.5, .05, .95))) %>% 
  mutate(across(where(is.numeric), ~round(., 2))) %>% 
  mutate(result = str_glue("{`50%`} [{`5%`}, {`95%`}]"))

p_cor_country_anx <- country_anxiety %>% 
  ggplot(aes(internet, anxiety)) +
  # geom_path(
  #   data = region_anxiety_ellipse, 
  #   aes(x=x, y=y), alpha = .2, size = .1, col = "dodgerblue4"
  # ) +
  # geom_path(
  #   data = country_anxiety_ellipse, 
  #   aes(x=x, y=y), alpha = .2, size = .1, col = "dodgerblue1"
  # ) +
  geom_vline(xintercept = 0, lty = 2, size = .2) +
  geom_hline(yintercept = 0, lty = 2, size = .2) +
  geom_point(col = "dodgerblue1", size = 1, alpha = .75) +
  scale_x_continuous(
    "Linear internet trend",
    breaks = pretty_breaks()
  ) +
  scale_y_continuous(
    "Linear anxiety trend",
    breaks = pretty_breaks()
  ) +
  geom_richtext(
    data = country_anxiety_result %>% 
      filter(variable == "cor_country__internet_time__Anxiety_time"),
    aes(x = -Inf, y = Inf, label = result),
    size = 3, vjust = 1, hjust = -0.1, color = "dodgerblue4",
    family = Font,
    fill = NA, label.color = NA
  ) +
  theme(aspect.ratio = 1)
```

```{r time-correlation-depression}
# Get average and region
r_region_depression <- fit_dep %>% 
  spread_draws(
    b_Depression_time, 
    b_internet_time,
    r_region__Depression[region, term],
    r_region__internet[region, term]
  ) %>% 
  filter(term == "time") %>% 
  ungroup() %>% 
  # Fix names by replacing dot with line break
  mutate(region = str_replace(region, "\\.", "\n"))

# Then country
r_country_depression <- fit_dep %>% 
  spread_draws(
    r_country__Depression[country, term],
    r_country__internet[country, term]
  ) %>% 
  filter(term == "time") %>% 
  ungroup() %>% 
  # Fix names by taking labels from original names
  mutate(
    country = factor(
      country, 
      labels = sort(unique(fit_dep$data$country))
    )
  ) %>% 
  left_join(distinct(gbd, region, country))

# Calculate country coefficients
country_depression <- left_join(r_country_depression, r_region_depression) %>% 
  mutate(
    internet = b_internet_time + r_region__internet + r_country__internet,
    depression = b_Depression_time + r_region__Depression + r_country__Depression
  ) %>% 
  group_by(country, region) %>% 
  median_qi(internet, depression)

country_depression_ellipse <- spread_draws(
  fit_dep,
  b_Depression_time, b_internet_time,
  cor_country__internet_time__Depression_time, 
  ndraws = 100
) %>% 
  mutate(
    e = pmap(
      list(
        x = cor_country__internet_time__Depression_time, 
        y = b_internet_time, 
        z = b_Depression_time
      ), 
      function(x, y, z) ellipse::ellipse(x, centre = c(y, z), level = .8) %>% 
        as_tibble()
    )
  ) %>% 
  unnest(e)

region_depression_ellipse <- spread_draws(
  fit_dep,
  b_Depression_time, b_internet_time,
  cor_region__internet_time__Depression_time, 
  ndraws = 100
) %>% 
  mutate(
    e = pmap(
      list(
        x = cor_region__internet_time__Depression_time, 
        y = b_internet_time, 
        z = b_Depression_time
      ), 
      function(x, y, z) ellipse::ellipse(x, centre = c(y, z), level = .8) %>% 
        as_tibble()
    )
  ) %>% 
  unnest(e)

country_depression_cor <- fit_dep %>%
  as_draws_df(
    variable = c(
      "cor_country__internet_time__Depression_time",
      "cor_region__internet_time__Depression_time"
    ),
    regex = TRUE
  ) %>% 
  as_tibble()
country_depression_result <- country_depression_cor %>%   
  summarise_draws(quantile, rhat, .args = list(probs = c(.5, .05, .95))) %>% 
  mutate(across(where(is.numeric), ~round(., 2))) %>% 
  mutate(result = str_glue("{`50%`} [{`5%`}, {`95%`}]"))

p_cor_country_dep <- country_depression %>% 
  ggplot(aes(internet, depression)) +
  # geom_path(
  #   data = region_depression_ellipse, 
  #   aes(x=x, y=y), alpha = .2, size = .1, col = "dodgerblue4"
  # ) +
  # geom_path(
  #   data = country_depression_ellipse, 
  #   aes(x=x, y=y), alpha = .2, size = .1, col = "dodgerblue1"
  # ) +
  geom_vline(xintercept = 0, lty = 2, size = .2) +
  geom_hline(yintercept = 0, lty = 2, size = .2) +
  geom_point(col = "dodgerblue1", size = 1, alpha = .75) +
  scale_x_continuous(
    "Linear internet trend",
    breaks = pretty_breaks()
  ) +
  scale_y_continuous(
    "Linear depression trend",
    breaks = pretty_breaks()
  ) +
  geom_richtext(
    data = country_depression_result %>% 
      filter(variable == "cor_country__internet_time__Depression_time"),
    aes(x = -Inf, y = Inf, label = result),
    size = 3, vjust = 1, hjust = -0.1, color = "dodgerblue4",
    family = Font,
    fill = NA, label.color = NA
  ) +
  theme(aspect.ratio = 1)
```

```{r time-correlation-selfharm}
# Get average and region
r_region_selfharm <- fit_sel %>% 
  spread_draws(
    b_Selfharm_time, 
    b_internet_time,
    r_region__Selfharm[region, term],
    r_region__internet[region, term]
  ) %>% 
  filter(term == "time") %>% 
  ungroup() %>% 
  # Fix names by replacing dot with line break
  mutate(region = str_replace(region, "\\.", "\n"))

# Then country
r_country_selfharm <- fit_sel %>% 
  spread_draws(
    r_country__Selfharm[country, term],
    r_country__internet[country, term]
  ) %>% 
  filter(term == "time") %>% 
  ungroup() %>% 
  # Fix names by taking labels from original names
  mutate(
    country = factor(
      country, 
      labels = sort(unique(fit_sel$data$country))
    )
  ) %>% 
  left_join(distinct(gbd, region, country))

# Calculate country coefficients
country_selfharm <- left_join(r_country_selfharm, r_region_selfharm) %>% 
  mutate(
    internet = b_internet_time + r_region__internet + r_country__internet,
    selfharm = b_Selfharm_time + r_region__Selfharm + r_country__Selfharm
  ) %>% 
  group_by(country, region) %>% 
  median_qi(internet, selfharm)

country_selfharm_ellipse <- spread_draws(
  fit_sel,
  b_Selfharm_time, b_internet_time,
  cor_country__internet_time__Selfharm_time, 
  ndraws = 100
) %>% 
  mutate(
    e = pmap(
      list(
        x = cor_country__internet_time__Selfharm_time, 
        y = b_internet_time, 
        z = b_Selfharm_time
      ), 
      function(x, y, z) ellipse::ellipse(x, centre = c(y, z), level = .8) %>% 
        as_tibble()
    )
  ) %>% 
  unnest(e)

region_selfharm_ellipse <- spread_draws(
  fit_sel,
  b_Selfharm_time, b_internet_time,
  cor_region__internet_time__Selfharm_time, 
  ndraws = 100
) %>% 
  mutate(
    e = pmap(
      list(
        x = cor_region__internet_time__Selfharm_time, 
        y = b_internet_time, 
        z = b_Selfharm_time
      ), 
      function(x, y, z) ellipse::ellipse(x, centre = c(y, z), level = .8) %>% 
        as_tibble()
    )
  ) %>% 
  unnest(e)

country_selfharm_cor <- fit_sel %>%
  as_draws_df(
    variable = c(
      "cor_country__internet_time__Selfharm_time",
      "cor_region__internet_time__Selfharm_time"
    ),
    regex = TRUE
  ) %>% 
  as_tibble()
country_selfharm_result <- country_selfharm_cor %>%   
  summarise_draws(quantile, rhat, .args = list(probs = c(.5, .05, .95))) %>% 
  mutate(across(where(is.numeric), ~round(., 2))) %>% 
  mutate(result = str_glue("{`50%`} [{`5%`}, {`95%`}]"))

p_cor_country_sel <- country_selfharm %>% 
  ggplot(aes(internet, selfharm)) +
  # geom_path(
  #   data = region_selfharm_ellipse, 
  #   aes(x=x, y=y), alpha = .2, size = .1, col = "dodgerblue4"
  # ) +
  # geom_path(
  #   data = country_selfharm_ellipse, 
  #   aes(x=x, y=y), alpha = .2, size = .1, col = "dodgerblue1"
  # ) +
  geom_vline(xintercept = 0, lty = 2, size = .2) +
  geom_hline(yintercept = 0, lty = 2, size = .2) +
  geom_point(col = "dodgerblue1", size = 1, alpha = .75) +
  scale_x_continuous(
    "Linear internet trend",
    breaks = pretty_breaks()
  ) +
  scale_y_continuous(
    "Linear selfharm trend",
    breaks = pretty_breaks()
  ) +
  geom_richtext(
    data = country_selfharm_result %>% 
      filter(variable == "cor_country__internet_time__Selfharm_time"),
    aes(x = -Inf, y = Inf, label = result),
    size = 3, vjust = 1, hjust = -0.1, color = "dodgerblue4",
    family = Font,
    fill = NA, label.color = NA
  ) +
  theme(aspect.ratio = 1)
```

```{r}
p_cor_country_anx + theme(axis.title.x = element_blank()) | 
  p_cor_country_dep | 
  p_cor_country_sel + theme(axis.title.x = element_blank())
```


##### Time: Interactions

```{r}
# Define models of outcomes
bf_anx <- bf(
  Anxiety ~ 1 + time * sex + time * age + 
    (1 + time * sex + time * age |c| country) +
    (1 + time * sex + time * age |r| region),
  family = gaussian()
)
bf_dep <- bf(
  Depression ~ 1 + time + sex + age + 
    (1 + time * sex + time * age |c| country) +
    (1 + time * sex + time * age |r| region),
  family = gaussian()
)
bf_sel <- bf(
  Selfharm ~ 1 + time + sex + age + 
    (1 + time * sex + time * age |c| country) +
    (1 + time * sex + time * age |r| region),
  family = gaussian()
)

# Fit models
fit_anx <- brm(
  bf_int + bf_anx + set_rescor(FALSE),
  data = gbd_10,
  file = "output/brm-gbd-time-anxiety-int2",
  chains = 4,
  cores = 4,
  iter = 1000, warmup = 600, refresh = 10,
  threads = 1,
  control = list(adapt_delta = .9)
)
fit_dep <- brm(
  bf_int + bf_dep + set_rescor(FALSE),
  data = gbd_10,
  file = "output/brm-gbd-time-depression-int2",
  chains = 4,
  cores = 4,
  iter = 1000, warmup = 600, refresh = 10,
  threads = 1,
  control = list(adapt_delta = .9)
)
fit_sel <- brm(
  bf_int + bf_sel + set_rescor(FALSE),
  data = gbd_10,
  file = "output/brm-gbd-time-selfharm-int2",
  chains = 4,
  cores = 4,
  iter = 1000, warmup = 600, refresh = 10,
  threads = 1,
  control = list(adapt_delta = .9)
)
fits_brm_time_interactions <- tibble(
  outcome = c("Anxiety", "Depression", "Selfharm"),
  fit = list(fit_anx, fit_dep, fit_sel)
)
```

Coefficients

```{r}
fits_brm_time_interactions %>% 
  mutate(
    out = map(
      fit, 
      ~as_draws(.x, variable = "b_", regex = TRUE) %>% 
        summarise_draws(quantile, rhat, .args = list(probs = c(.05, .5, .95)))
    )
  ) %>% 
  select(-fit) %>% 
  unnest(out) %>% 
  # filter(str_detect(Parameter, "_time$")) %>% 
  kbl(digits = 2) %>% 
  kable_minimal(full_width = FALSE)
```

Model comparison using waic shows that interactive model is favored across the board.

```{r eval = FALSE}
waics <- left_join(
  rename(fits_brm_time_main, fit_main = fit),
  rename(fits_brm_time_interactions, fit_intr = fit)
) %>% 
  mutate(waic = map2(fit_main, fit_intr, ~waic(.x, .y)))
waics$waic[[3]]
```

Show main effects

Plot fixed effects and by demographic

```{r}
# Fixed effects parameters
fixed_effects <- fits_brm_time_interactions %>% 
  mutate(out = map(fit, ~tidy(., conf.int = TRUE))) %>% 
  select(-fit) %>% 
  unnest(out) %>% 
  standardize_names() %>% 
  as_tibble() %>% 
  filter(
    Effects == "fixed", 
    Parameter != "(Intercept)"
  ) 
# Fixed effects per demographic
fixed_effects_demographics <- fits_brm_time_interactions %>% 
  mutate(
    out = map2(
      fit, outcome,
      ~emtrends(
        .x, 
        var = "time", 
        by = c("sex", "age"), 
        resp = .y
      ) %>% 
        parameters() %>% 
        as.data.frame()
    )
  )
fixed_effects_demographics %>% 
  select(-fit) %>% 
  unnest(out) %>% 
  standardize_names() %>% 
  as_tibble() %>% 
  mutate(Parameter = str_glue("{sex}\n({age})"))

# Random effects parameters
random_effects <- fits_lmer %>% 
  mutate(
    coef_region = map(
      fit, 
      ~bind_rows(
        coef(.x)$region %>% 
          as.data.frame() %>% 
          rownames_to_column("region"),
        coef(.x)$country %>% 
          as.data.frame() %>% 
          rownames_to_column("country"),
        .id = "cluster"
      ) %>% 
        mutate(cluster = factor(cluster, labels = c("region", "country")))
    )
  ) %>% 
  select(-fit) %>% 
  unnest(coef_region) %>% 
  mutate(Type = "Effects") %>%
  select(-`(Int      ,nc ercept)`)

bind_rows(
  fixed_effects,
  fixed_effects_demographics, 
  .id = "Type"
) %>% 
  mutate(Type = factor(Type, labels = c("Effects", "Time by demographic"))) %>% 
  mutate(Parameter = fct_inorder(Parameter)) %>%
  mutate(cause = factor(cause)) %>% 
  rowwise() %>% 
  mutate(
    sig = factor(
      !between(0, CI_low, CI_high), 
      levels = c(TRUE, FALSE)
    )
  ) %>% 
  ggplot(aes(Coefficient, Parameter, col = cause, shape = sig)) +
  scale_color_discrete(
    "Outcome"
  ) +
  scale_x_continuous(
    "Estimate (95%CI)"
  ) +
  scale_shape_manual(values = c(19, 21)) +
  geom_vline(xintercept = 0, size = .2, alpha = .2) +
  geom_pointrangeh(
    aes(xmin = CI_low, xmax = CI_high),
    position = position_dodge2v(.5),
    fill = "white", size = .3, fatten = 5
  ) +
  guides(shape = "none") +
  facet_wrap("Type", ncol = 2, scales = "free") +
  theme(axis.title.y = element_blank())
```

```{r}
library(modelbased)
x <- parameters(fits_brm$fit[[1]], test = "pd", effects = "random", group_level = TRUE, keep = "time_Intercept")
tmp <- fits_brm %>% 
  mutate(
    # Average effect
    avg = map2(
      fit, 
      Outcome, 
      ~hypothesis(.x, str_glue("{.y}_time = 0"))
    ),
    # By country effect
    by_country = map2(
      fit, 
      Outcome, 
      ~hypothesis(
        .x, str_glue("{.y}_time = 0"), 
        scope = "coef", group = "country"
      )
    ),
    # By region effect
    by_region = map2(
      fit, 
      Outcome, 
      ~hypothesis(
        .x, str_glue("{.y}_time = 0"), 
        scope = "coef", group = "region"
      )
    )
  ) %>% 
  select(-fit)

tmp %>% 
  select(Outcome, avg) %>% 
  mutate(avg = map(avg, ))

tmp$by_region[[1]] %>% str

h <- paste(
  c("valAnxiety_Time", "valDepression_Time", "valSelfharm_Time"), 
  "= 0"
)

# Prepare average samples
time_avg <- hypothesis(fit_gbd_time, h)
time_avg_samples <- time_avg$samples
names(time_avg_samples) <- time_avg$hypothesis$Hypothesis
time_avg_samples <- time_avg_samples %>% 
  pivot_longer(everything(), names_to = "Parameter") %>% 
  mutate(region = "Average")

# Prepare region samples
time_region <- hypothesis(fit_gbd_time, h, scope = "coef", group = "region")
time_region_samples <- time_region$samples
names(time_region_samples) <- paste(
  time_region$hypothesis$Hypothesis, 
  time_region$hypothesis$Group, sep = ":"
)
time_region_samples <- time_region_samples %>% 
  pivot_longer(everything(), names_to = "Parameter") %>% 
  separate(Parameter, c("Parameter", "region"), sep = ":")

# Prepare country point estimates
time_country <- hypothesis(fit_gbd_time, h, scope = "coef", group = "country")
time_country_hypothesis <- time_country$hypothesis %>% 
  rename(country = Group, Parameter = Hypothesis)
time_country_hypothesis <- left_join(
  time_country_hypothesis, 
  distinct(fit_gbd_time$data, country, region)
)

time_sum <- bind_rows(
  time_region$hypothesis,
  time_avg$hypothesis %>% mutate(Group = "Average")
) %>% 
  as_tibble() %>% 
  rename(region = Group, Parameter = Hypothesis)

bind_rows(
  time_region_samples,
  time_avg_samples
) %>% 
  mutate(region = fct_relevel(region, "Average")) %>% 
  mutate(Average = region == "Average") %>% 
  ggplot(aes(value/10, region)) +
  scale_y_discrete(
    expand = expansion(c(0.025, 0.075)),
    labels = function(x) ifelse(x == "Average", "**Average**", x)
  ) +
  scale_x_continuous(
    "Estimated yearly change",
    breaks = pretty_breaks(5)
  ) +
  scale_alpha_manual(values = c(.5, 1)) +
  geom_vline(xintercept = 0, size = .2, alpha = .25) +
  stat_eye(
    side = "top",
    aes(col = region, fill = region, alpha = Average),
    point_interval = NULL,
    normalize = "panels", 
    height = .75
  ) +
  geom_pointrangeh(
    data = time_sum,
    aes(x = Estimate/10, xmin = CI.Lower/10, xmax = CI.Upper/10),
    size = .3, fatten = 1.4
  ) +
  geom_point(
    data = time_country_hypothesis,
    aes(col = region, x = Estimate/10), 
    size = .5,
    alpha = .25,
    position = position_nudge(y = -.05)
  ) +
  facet_wrap(
    "Parameter", ncol = 3, scales = "free_x",
    labeller = as_labeller(
      function(x) str_extract(x, "Anxiety|Depression|Selfharm"))
  ) +
  theme(
    axis.text.y = element_markdown(),
    legend.position = "none",
    axis.title.y = element_blank()
  )
ggsave(
  "output/Fig-brm-time-forest.png", 
  device = agg_png,
  height = 1200, width = 3200, res = 300, units = "px"
)
```


##### Internet: Main effects

```{r}
# Define models of outcomes
bf_anx <- bf(
  Anxiety ~ 1 + time + sex + age + i1_cw + i1_cb +
    (1 + time + sex + age + i1_cw |c| country) +
    (1 + time + sex + age + i1_cw |r| region),
  family = gaussian()
)
bf_dep <- bf(
  Depression ~ 1 + time + sex + age + i1_cw + i1_cb +
    (1 + time + sex + age + i1_cw |c| country) +
    (1 + time + sex + age + i1_cw |r| region),
  family = gaussian()
)
bf_sel <- bf(
  Selfharm ~ 1 + time + sex + age + i1_cw + i1_cb + 
    (1 + time + sex + age + i1_cw |c| country) +
    (1 + time + sex + age + i1_cw |r| region),
  family = gaussian()
)

# Fit models in background (need 12 cores)
fit_anx <- brm(
  bf_int + bf_anx + set_rescor(FALSE),
  data = gbd_10,
  file = "output/brm-gbd-time-internet-anxiety",
  chains = 4,
  cores = 4,
  iter = 1000, warmup = 600, refresh = 10,
  threads = 1,
  control = list(adapt_delta = .9)
)
fit_dep <- brm(
  bf_int + bf_dep + set_rescor(FALSE),
  data = gbd_10,
  file = "output/brm-gbd-time-internet-depression",
  chains = 4,
  cores = 4,
  iter = 1000, warmup = 600, refresh = 10,
  threads = 1,
  control = list(adapt_delta = .9)
)
fit_sel <- brm(
  bf_int + bf_sel + set_rescor(FALSE),
  data = gbd_10,
  file = "output/brm-gbd-time-internet-selfharm",
  chains = 4,
  cores = 4,
  iter = 1000, warmup = 600, refresh = 10,
  threads = 1,
  control = list(adapt_delta = .9)
)
fits_brm_internet_main <- tibble(
  outcome = c("Anxiety", "Depression", "Selfharm"),
  fit = list(fit_anx, fit_dep, fit_sel)
)
```

Coefficients

```{r}
fits_brm_internet_main %>% 
  mutate(
    out = map(
      fit, 
      ~as_draws(.x, variable = "b_", regex = TRUE) %>% 
        summarise_draws(quantile, rhat, .args = list(probs = c(.5, .05, .95)))
    )
  ) %>% 
  select(-fit) %>% 
  unnest(out) %>% 
  filter(str_detect(variable, "_i1_cw|b$")) %>% 
  kbl(digits = 3) %>% 
  kable_minimal(full_width = FALSE)
```

Different levels

```{r}
# Get average and region
r_selfharm <- fit_sel %>% 
  spread_draws(
    b_Selfharm_i1_cw, 
    r_region__Selfharm[region, term]
  ) %>% 
  filter(term == "i1_cw") %>% 
  ungroup() %>% 
  # Fix names by replacing dot with line break
  mutate(region = str_replace(region, "\\.", "\n"))

fit_sel %>% 
  spread_draws(
    r_country__Selfharm[country, term]
    )

# Calculate country coefficients
r_selfharm <- r_selfharm %>% 
  mutate(
    b_average = b_Selfharm_i1_cw,
    b_region = b_average + r_region__Selfharm,
    b_country = b_region + r_country__Selfharm
  )

r_selfharm %>% 
  distinct(.draw, b_average) %>% 
  mutate(region = "Average") %>% 
  ggplot(aes(b_average, region)) +
  stat_halfeye(size = 1, fill = "dodgerblue4") +
  stat_halfeye(
    data = r_selfharm %>% 
      distinct(.draw, region, b_region),
    aes(b_region),
    size = 1, fill = "dodgerblue1"
  ) +
  geom_point(
    data = 
  )
r_selfharm %>% 
  group_by(region, country) %>% 
  median_qi(b_country)
```


##### Internet: Interactions

```{r}
# Define models of outcomes
bf_anx <- bf(
  Anxiety ~ 1 + time*sex + time*age + i1_cw*sex + i1_cw*age + i1_cb +
    (1 + time*sex + time*age + i1_cw*sex + i1_cw*age | country) +
    (1 + time*sex + time*age + i1_cw*sex + i1_cw*age | region),
  family = gaussian()
)
bf_dep <- bf(
  Depression ~ 1 + time*sex + time*age + i1_cw*sex + i1_cw*age + i1_cb +
    (1 + time*sex + time*age + i1_cw*sex + i1_cw*age | country) +
    (1 + time*sex + time*age + i1_cw*sex + i1_cw*age | region),
  family = gaussian()
)
bf_sel <- bf(
  Selfharm ~ 1 + time*sex + time*age + i1_cw*sex + i1_cw*age + i1_cb + 
    (1 + time*sex + time*age + i1_cw*sex + i1_cw*age | country) +
    (1 + time*sex + time*age + i1_cw*sex + i1_cw*age | region),
  family = gaussian()
)

# Fit models in background (need 12 cores)
job::job({
  fit_anx <- brm(
    bf_anx,
    data = gbd_wide,
    file = "output/brm-gbd-time-internet-anxiety-int2",
    chains = 4,
    cores = 4,
    iter = 1200, warmup = 600, refresh = 10,
    threads = 1,
    control = list(adapt_delta = .9)
  )
}, title = "Fitting brms anxiety")
job::job({
  fit_dep <- brm(
    bf_dep,
    data = gbd_wide,
    file = "output/brm-gbd-time-internet-depression-int2",
    chains = 4,
    cores = 4,
    iter = 1200, warmup = 600, refresh = 10,
    threads = 1,
    control = list(adapt_delta = .9)
  )
}, title = "Fitting brms depression")
fit_sel <- brm(
  bf_sel,
  data = gbd_wide,
  file = "output/brm-gbd-time-internet-selfharm-int2",
  chains = 4,
  cores = 4,
  iter = 1200, warmup = 600, refresh = 10,
  threads = 1,
  control = list(adapt_delta = .9)
)
```

###### Plot: Average effects of time

```{r eval = FALSE}
fixef(fit_gbd_time) %>%
  as.data.frame() %>% 
  rownames_to_column("Parameter") %>% 
  as_tibble()

h <- paste(
  c("valAnxiety_Time", "valDepression_Time", "valSelfharm_Time"), 
  "= 0"
)

# Prepare average samples
time_avg <- hypothesis(fit_gbd_time, h)
time_avg_samples <- time_avg$samples
names(time_avg_samples) <- time_avg$hypothesis$Hypothesis
time_avg_samples <- time_avg_samples %>% 
  pivot_longer(everything(), names_to = "Parameter") %>% 
  mutate(region = "Average")

# Prepare region samples
time_region <- hypothesis(fit_gbd_time, h, scope = "coef", group = "region")
time_region_samples <- time_region$samples
names(time_region_samples) <- paste(
  time_region$hypothesis$Hypothesis, 
  time_region$hypothesis$Group, sep = ":"
)
time_region_samples <- time_region_samples %>% 
  pivot_longer(everything(), names_to = "Parameter") %>% 
  separate(Parameter, c("Parameter", "region"), sep = ":")

# Prepare country point estimates
time_country <- hypothesis(fit_gbd_time, h, scope = "coef", group = "country")
time_country_hypothesis <- time_country$hypothesis %>% 
  rename(country = Group, Parameter = Hypothesis)
time_country_hypothesis <- left_join(
  time_country_hypothesis, 
  distinct(fit_gbd_time$data, country, region)
)

time_sum <- bind_rows(
  time_region$hypothesis,
  time_avg$hypothesis %>% mutate(Group = "Average")
) %>% 
  as_tibble() %>% 
  rename(region = Group, Parameter = Hypothesis)

bind_rows(
  time_region_samples,
  time_avg_samples
) %>% 
  mutate(region = fct_relevel(region, "Average")) %>% 
  mutate(Average = region == "Average") %>% 
  ggplot(aes(value/10, region)) +
  scale_y_discrete(
    expand = expansion(c(0.025, 0.075)),
    labels = function(x) ifelse(x == "Average", "**Average**", x)
  ) +
  scale_x_continuous(
    "Estimated yearly change",
    breaks = pretty_breaks(5)
  ) +
  scale_alpha_manual(values = c(.5, 1)) +
  geom_vline(xintercept = 0, size = .2, alpha = .25) +
  stat_eye(
    side = "top",
    aes(col = region, fill = region, alpha = Average),
    point_interval = NULL,
    normalize = "panels", 
    height = .75
  ) +
  geom_pointrangeh(
    data = time_sum,
    aes(x = Estimate/10, xmin = CI.Lower/10, xmax = CI.Upper/10),
    size = .3, fatten = 1.4
  ) +
  geom_point(
    data = time_country_hypothesis,
    aes(col = region, x = Estimate/10), 
    size = .5,
    alpha = .25,
    position = position_nudge(y = -.05)
  ) +
  facet_wrap(
    "Parameter", ncol = 3, scales = "free_x",
    labeller = as_labeller(
      function(x) str_extract(x, "Anxiety|Depression|Selfharm"))
  ) +
  theme(
    axis.text.y = element_markdown(),
    legend.position = "none",
    axis.title.y = element_blank()
  )
ggsave(
  "output/Fig-brm-time-forest.png", 
  device = agg_png,
  height = 1200, width = 3200, res = 300, units = "px"
)
```

## Model 2: Associations

This model expands the above to add internet adoption as a predictor.

### GBD

#### Figure

```{r}
gbd %>% 
  ggplot(
    aes(
      x = i1_cw/10, 
      y = val, 
      col = region, fill = region
    )
  ) +
  geom_point(size = .25, alpha = .1) +
  stat_smooth(method = "lm", alpha = .2, size = .3) +
  # stat_summary(fun = mean, geom = "line", size = .25) +
  facet_grid(Cause~region, scales = "free_y") +
  theme(legend.position = "none")
```

#### lme4

```{r fit-gbd-internet-lme4}
# These take about 1-3 hours each
# run in parallel in background jobs
# recommended to conduct this in interactive mode (rstudio)
file_path <- "output/lme4-gbd-internet.rds"
if (!file.exists(file_path)) {
  library(job)
  job({fit_anx <- lmer(
    Anxiety ~ 1 + time * sex * age + i1_cw * sex * age + i1_cb +
      (1 + time * sex * age + i1_cw * sex * age | region) +
      (1 + time * sex * age + i1_cw * sex * age | country),
    data = gbd_wide
  )}, title = "Anxiety internet (lmer)")
  job({fit_dep <- lmer(
    Depression ~ 1 + time * sex * age + i1_cw * sex * age + i1_cb +
      (1 + time * sex * age + i1_cw * sex * age | region) +
      (1 + time * sex * age + i1_cw * sex * age | country),
    data = gbd_wide
  )}, title = "Depression internet (lmer)")
  job({fit_sel <- lmer(
    Selfharm ~ 1 + time * sex * age + i1_cw * sex * age + i1_cb +
      (1 + time * sex * age + i1_cw * sex * age | region) +
      (1 + time * sex * age + i1_cw * sex * age | country),
    data = gbd_wide
  )}, title = "Self harm internet (lmer)")
  fits_lmer <- distinct(gbd, cause) %>% 
    mutate(fit = list(fit_anx, fit_dep, fit_sel))
  write_rds(fits_lmer, file_path)
} else {fits_lmer <- read_rds(file_path)}
```

```{r}
fits_lmer %>% 
  mutate(out = map(fit, ~tidy(., conf.int = TRUE))) %>% 
  select(-fit) %>% 
  unnest(out) %>% 
  filter(term == "i1_cw")
```

#### brms

```{r fit-gbd-internet-brms, eval = FALSE}
# bf_gbd_internet <- bf(
#   mvbind(
#     val_Depression,
#     val_Anxiety,
#     val_Self_harm
#   ) ~ 1 + Time + i1_cw + i1_cb +
#     (1 + Time + i1_cw || region)
#   (1 + Time + i1_cw || country)
# ) +
#   set_rescor(FALSE)
# 
# fit_gbd_internet <- brm(
#   bf_gbd_internet,
#   gbd_y_w,
#   file = "output/brm-gbd-internet-mv",
#   chains = 5,
#   cores = 5,
#   iter = 300, warmup = 150, refresh = 10,
#   threads = 2,
#   control = list(adapt_delta = .9, max_treedepth = 15)
# )

bf_gbd_internet_demos <- bf(
  mvbind(
    Depression,
    Anxiety,
    Selfharm
  ) ~ 1 + time * sex * age + i1_cw * sex * age + i1_cb +
    (1 + time * sex * age + i1_cw * sex * age | country)
) +
  set_rescor(FALSE)

p <- prior(normal(0, 3), class = b, resp = Anxiety) +
  prior(normal(0, 3), class = b, resp = Depression) +
  prior(normal(0, 3), class = b, resp = Selfharm) +
  prior(student_t(7, 0, 1), class = sd, resp = Anxiety) +
  prior(student_t(7, 0, 1), class = sd, resp = Depression) +
  prior(student_t(7, 0, 1), class = sd, resp = Selfharm)

job::job({fit_gbd_internet_demos <- brm(
  bf_gbd_internet_demos,
  gbd_wide,
  prior = p,
  file = "output/brm-gbd-internet-mv-demos",
  chains = 5,
  cores = 5,
  iter = 450, warmup = 300, refresh = 10,
  threads = 1,
  control = list(adapt_delta = .9, max_treedepth = 15)
)}, title = "brms internet")
```

